<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gioco delle Divisioni in Colonna v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            max-height: 98vh;
            overflow-y: auto;
        }

        h1 {
            text-align: center;
            color: #4facfe;
            margin-bottom: 5px;
            font-size: 1.4em;
        }

        .score-board {
            display: flex;
            justify-content: space-around;
            margin-bottom: 5px;
            padding: 5px;
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            border-radius: 15px;
            color: white;
        }

        .score-item {
            text-align: center;
            flex: 1;
        }

        .score-label {
            font-size: 0.7em;
            opacity: 0.9;
        }

        .score-value {
            font-size: 1.2em;
            font-weight: bold;
        }

        /* Stile per il pulsante Esci */
        .btn-exit {
            background: none;
            border: none;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            width: 100%;
            padding: 2px;
            border-radius: 5px;
            transition: background 0.2s;
        }
        .btn-exit:hover {
            background: rgba(255,255,255,0.2);
        }
        .exit-icon {
            font-size: 1.2em;
        }

        .division-area {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 5px;
            overflow-x: auto;
        }

        .timer {
            text-align: center;
            font-size: 1em;
            color: #4facfe;
            margin: 3px 0;
        }

        .phase-indicator {
            text-align: center;
            padding: 3px 5px;
            margin: 3px 0;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: bold;
            color: #333;
            line-height: 1.2;
        }

        .division-classic {
            font-family: 'Courier New', monospace;
            font-size: 1.3em;
            display: inline-block;
            margin: 10px auto;
        }

        .division-header {
            display: flex;
            align-items: flex-start;
            gap: 0;
        }

        .dividend-box {
            display: flex;
            gap: 2px;
            padding-right: 8px;
            border-right: 3px solid #333;
            border-bottom: 3px solid #333;
            padding-bottom: 3px;
        }

        .dividend-digit {
            width: 35px;
            text-align: center;
            font-weight: bold;
            font-size: 1em;
            position: relative;
            padding: 3px 0;
            transition: all 0.3s ease;
        }

        .dividend-digit.highlighted {
            background: #fff3cd;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
            transform: scale(1.1);
        }

        .divisor-box {
            padding: 3px 12px;
            border-bottom: 3px solid #333;
            font-weight: bold;
            font-size: 1em;
            text-align: center;
        }

        .quotient-box {
            display: flex;
            gap: 2px;
            padding: 5px 0 0 0;
            justify-content: center;
        }

        .quotient-input {
            width: 35px;
            height: 35px;
            text-align: center;
            font-size: 1em;
            border: 2px solid #4facfe;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .work-column {
            margin-top: 5px;
            padding-left: 0;
        }

        .step-row {
            margin: 8px 0;
            padding: 5px;
            background: #fff;
            border-left: 3px solid #4facfe;
            border-radius: 5px;
        }

        .step-label {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 3px;
            font-weight: bold;
        }

        .calculation-line {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 3px 0;
            font-size: 0.8em;
        }

        .calc-row {
            display: flex;
            gap: 2px;
            align-items: center;
            margin: 2px 0;
        }

        .number-display {
            min-width: 50px;
            text-align: right;
            font-weight: bold;
        }

        .operation-sign {
            width: 25px;
            font-weight: bold;
            color: #dc3545;
        }

        .input-small {
            width: 32px;
            height: 30px;
            text-align: center;
            font-size: 0.9em;
            border: 2px solid #43e97b;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        .input-result {
            width: 30px;
            height: 30px;
            text-align: center;
            font-size: 0.9em;
            border: 2px solid #ffc107;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        .subtraction-box {
            border-top: 2px solid #333;
            margin-top: 2px;
            padding-top: 3px;
        }

        .input-digit {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .input-digit:focus {
            outline: none;
            box-shadow: 0 0 8px rgba(67, 233, 123, 0.5);
        }

        .input-digit.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .input-digit.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .button-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 5px;
        }

        button {
            padding: 8px 15px;
            font-size: 0.9em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-check {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-new {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-hint {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .message {
            text-align: center;
            padding: 5px;
            margin-top: 5px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            min-height: 35px;
        }

        .message.show {
            opacity: 1;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .message.points {
            background: #fff3cd;
            color: #856404;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 10px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
            line-height: 1.4;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltiptext strong {
            color: #43e97b;
            display: block;
            margin-bottom: 5px;
        }
        
        .tooltiptext ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .tooltiptext li {
            margin: 4px 0;
        }

        .help-text {
            font-size: 0.7em;
            color: #666;
            font-style: italic;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Divisioni in Colonna üéØ</h1>
        
        <div class="score-board">
            <div class="score-item">
                <div class="score-label">Punteggio</div>
                <div class="score-value" id="score">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">Operazioni</div>
                <div class="score-value" id="operations">0</div>
            </div>
            <div class="score-item">
                <div class="score-label tooltip">
                    Streak üî•
                    <span class="tooltiptext">
                        <strong>Cos'√® lo Streak?</strong>
                        Lo Streak indica quante divisioni hai risolto correttamente di seguito, senza errori.
                        <ul>
                            <li>‚úÖ Risolvi correttamente ‚Üí Streak +1</li>
                            <li>‚ùå Sbagli ‚Üí Streak torna a 0</li>
                        </ul>
                        <strong>üéÅ Bonus Punti:</strong>
                        Con Streak ‚â• 3 ricevi punti extra!<br>
                        (Streak √ó 10 punti bonus)
                    </span>
                </div>
                <div class="score-value" id="streak">0</div>
            </div>
            <!-- NUOVO PULSANTE ESCI -->
            <div class="score-item">
                <button class="btn-exit" id="esciBtn">
                    <span class="exit-icon">üö™</span>
                    <span>Esci</span>
                </button>
            </div>
        </div>

        <div class="timer" id="timer">Tempo: 0s</div>

        <div class="division-area">
            <div class="phase-indicator" id="phaseIndicator">Segui i passaggi per risolvere la divisione!</div>
            <div style="display: flex; justify-content: center;">
                <div id="operation"></div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-check" id="checkBtn">Controlla</button>
            <button class="btn-new" id="newBtn">Nuova Divisione</button>
            <button class="btn-hint" id="hintBtn">Aiuto</button>
        </div>

        <div class="message" id="message"></div>
    </div>

    <script>
        let dividend, divisor, quotient, remainder;
        let startTime, timerInterval;
        let score = 0, operations = 0, streak = 0;
        let divisionSteps = [];

        function generateDivision() {
            divisor = Math.floor(Math.random() * 8) + 2;
            quotient = Math.floor(Math.random() * 90) + 10;
            remainder = Math.floor(Math.random() * divisor);
            dividend = quotient * divisor + remainder;
            
            if (dividend > 999) {
                quotient = Math.floor(Math.random() * 90) + 10;
                remainder = Math.floor(Math.random() * divisor);
                dividend = quotient * divisor + remainder;
            }
            
            calculateSteps();
            console.log('=== NUOVA DIVISIONE ===');
            console.log(dividend + ' √∑ ' + divisor + ' = ' + quotient + ' resto ' + remainder);
            console.log('Steps:', divisionSteps);
        }

        function calculateSteps() {
            divisionSteps = [];
            const dividendStr = dividend.toString();
            const quotientStr = quotient.toString();
            let currentNumber = 0;
            let position = 0;
            let digitIndex = 0;
            
            // Primo passo: prendi cifre sufficienti
            let firstDigits = [];
            while (currentNumber < divisor && digitIndex < dividendStr.length) {
                firstDigits.push(digitIndex);
                currentNumber = currentNumber * 10 + parseInt(dividendStr[digitIndex]);
                digitIndex++;
            }
            
            console.log('Primo passo - prendo cifre:', firstDigits, 'numero:', currentNumber);
            
            // Primo passaggio
            if (currentNumber >= divisor) {
                const quotientDigit = parseInt(quotientStr[position]);
                const product = quotientDigit * divisor;
                const partialRemainder = currentNumber - product;
                
                divisionSteps.push({
                    numberToDivide: currentNumber,
                    quotientDigit: quotientDigit,
                    product: product,
                    remainder: partialRemainder,
                    digitsTaken: digitIndex,
                    highlightDigits: firstDigits,
                    isFirst: true
                });
                
                currentNumber = partialRemainder;
                position++;
            }
            
            // Passi successivi
            for (let i = digitIndex; i < dividendStr.length; i++) {
                currentNumber = currentNumber * 10 + parseInt(dividendStr[i]);
                const quotientDigit = parseInt(quotientStr[position]);
                const product = quotientDigit * divisor;
                const partialRemainder = currentNumber - product;
                
                console.log('Passo successivo - abbasso cifra:', i, '(valore:', dividendStr[i] + ') numero:', currentNumber);
                
                divisionSteps.push({
                    numberToDivide: currentNumber,
                    quotientDigit: quotientDigit,
                    product: product,
                    remainder: partialRemainder,
                    digitsTaken: 1,
                    digitBroughtDown: dividendStr[i],
                    highlightDigits: [i],
                    isFirst: false
                });
                
                currentNumber = partialRemainder;
                position++;
            }
        }

        function renderDivision() {
            const dividendStr = dividend.toString();
            const quotientStr = quotient.toString();
            
            let html = '<div class="division-classic">';
            
            // Header
            html += '<div class="division-header">';
            html += '<div class="dividend-box">';
            for (let i = 0; i < dividendStr.length; i++) {
                html += `<div class="dividend-digit" id="dividend-digit-${i}">${dividendStr[i]}</div>`;
            }
            html += '</div>';
            html += '<div style="display: flex; flex-direction: column;">';
            html += `<div class="divisor-box">${divisor}</div>`;
            html += '<div class="quotient-box">';
            for (let i = 0; i < quotientStr.length; i++) {
                html += `<input type="text" maxlength="1" class="quotient-input input-digit" data-step="${i}" data-type="quotient" inputmode="numeric">`;
            }
            html += '</div></div></div>';
            
            // Colonna dei passaggi
            html += '<div class="work-column">';
            
            for (let stepIdx = 0; stepIdx < divisionSteps.length; stepIdx++) {
                const step = divisionSteps[stepIdx];
                const digitsToHighlight = step.highlightDigits.join(',');
                
                html += `<div class="step-row" data-step="${stepIdx}" data-digits="${digitsToHighlight}">`;
                
                // Titolo
                html += '<div class="step-label">';
                if (step.isFirst) {
                    if (step.digitsTaken > 1) {
                        const firstDigits = dividendStr.substring(0, step.digitsTaken);
                        html += `Passo ${stepIdx + 1}: Prendo ${firstDigits} (${dividendStr[0]} √® troppo piccolo)`;
                    } else {
                        html += `Passo ${stepIdx + 1}: Prendo ${step.numberToDivide}`;
                    }
                } else {
                    html += `Passo ${stepIdx + 1}: Abbasso ${step.digitBroughtDown}, ottengo ${step.numberToDivide}`;
                }
                html += '</div>';
                
                // Divisione
                html += '<div class="calculation-line">';
                html += `<span>${step.numberToDivide} : ${divisor} = </span>`;
                html += `<input type="text" maxlength="1" class="input-small input-digit" data-step="${stepIdx}" data-type="quotient-step" inputmode="numeric">`;
                html += '<span class="help-text">(scrivi nel quoziente sopra)</span>';
                html += '</div>';
                
                // Moltiplicazione
                html += '<div class="calculation-line" style="margin-top: 8px;">';
                html += `<span>${divisor} √ó </span>`;
                html += `<input type="text" maxlength="1" class="input-small input-digit" data-step="${stepIdx}" data-type="mult" inputmode="numeric">`;
                html += `<span> = </span>`;
                
                const productStr = step.product.toString();
                if (productStr.length === 1) {
                    html += `<input type="text" maxlength="1" class="input-result input-digit" data-step="${stepIdx}" data-pos="0" data-type="product" inputmode="numeric">`;
                } else {
                    html += `<input type="text" maxlength="1" class="input-result input-digit" data-step="${stepIdx}" data-pos="0" data-type="product" inputmode="numeric">`;
                    html += `<input type="text" maxlength="1" class="input-result input-digit" data-step="${stepIdx}" data-pos="1" data-type="product" inputmode="numeric">`;
                }
                html += '</div>';
                
                // Sottrazione
                html += '<div style="margin-top: 10px; padding: 5px; background: #f8f9fa; border-radius: 5px;">';
                html += '<div class="calc-row">';
                html += `<div class="number-display">${step.numberToDivide}</div>`;
                html += '</div>';
                html += '<div class="calc-row">';
                html += '<span class="operation-sign">‚àí</span>';
                
                if (productStr.length === 1) {
                    html += `<input type="text" maxlength="1" class="input-result input-digit" data-step="${stepIdx}" data-pos="0" data-type="subtract" inputmode="numeric">`;
                } else {
                    html += `<input type="text" maxlength="1" class="input-result input-digit" data-step="${stepIdx}" data-pos="0" data-type="subtract" inputmode="numeric">`;
                    html += `<input type="text" maxlength="1" class="input-result input-digit" data-step="${stepIdx}" data-pos="1" data-type="subtract" inputmode="numeric">`;
                }
                html += '</div>';
                html += '<div class="calc-row subtraction-box">';
                
                const remainderStr = step.remainder.toString();
                if (remainderStr.length === 1 || step.remainder === 0) {
                    html += `<input type="text" maxlength="1" class="input-result input-digit" data-step="${stepIdx}" data-pos="0" data-type="remainder" inputmode="numeric" style="border-color: #e91e63;">`;
                } else {
                    html += `<input type="text" maxlength="1" class="input-result input-digit" data-step="${stepIdx}" data-pos="0" data-type="remainder" inputmode="numeric" style="border-color: #e91e63;">`;
                    html += `<input type="text" maxlength="1" class="input-result input-digit" data-step="${stepIdx}" data-pos="1" data-type="remainder" inputmode="numeric" style="border-color: #e91e63;">`;
                }
                html += '<span class="help-text">resto</span>';
                html += '</div></div>';
                
                html += '</div>';
            }
            
            html += '</div>';
            html += '<div style="margin-top: 8px; padding: 5px; background: #fff3cd; border-radius: 5px; text-align: center; font-size: 0.85em;">';
            html += `<strong>Resto finale: ${remainder}</strong>`;
            html += '</div></div>';
            
            document.getElementById('operation').innerHTML = html;
            setupEventListeners();
        }

        function setupEventListeners() {
            const inputs = document.querySelectorAll('.input-digit');
            const steps = document.querySelectorAll('.step-row');
            
            inputs.forEach((input) => {
                input.addEventListener('focus', (e) => {
                    const stepIdx = e.target.dataset.step;
                    if (stepIdx !== undefined) {
                        const stepRow = document.querySelector(`.step-row[data-step="${stepIdx}"]`);
                        if (stepRow) {
                            const digits = stepRow.dataset.digits;
                            if (digits) {
                                console.log('Focus su step', stepIdx, '- evidenzio cifre:', digits);
                                highlightDigits(digits.split(','));
                            }
                        }
                    }
                });
                
                input.addEventListener('input', (e) => {
                    if (e.target.value && /[0-9]/.test(e.target.value)) {
                        const allInputs = Array.from(inputs);
                        const currentIndex = allInputs.indexOf(input);
                        if (currentIndex < allInputs.length - 1) {
                            allInputs[currentIndex + 1].focus();
                        }
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value) {
                        const allInputs = Array.from(inputs);
                        const currentIndex = allInputs.indexOf(input);
                        if (currentIndex > 0) {
                            allInputs[currentIndex - 1].focus();
                        }
                    }
                });
            });
            
            // Evidenzia le cifre del primo passo all'inizio e mantienile
            if (steps.length > 0) {
                const firstStep = steps[0];
                const digits = firstStep.dataset.digits;
                if (digits) {
                    console.log('Evidenzio cifre iniziali:', digits);
                    highlightDigits(digits.split(','));
                }
            }
        }

        function highlightDigits(digitIndices) {
            console.log('highlightDigits chiamata con:', digitIndices);
            
            document.querySelectorAll('.dividend-digit').forEach(d => {
                d.classList.remove('highlighted');
            });
            
            digitIndices.forEach(idx => {
                const digit = document.getElementById(`dividend-digit-${idx}`);
                console.log('Cerco di evidenziare cifra', idx, 'elemento trovato:', digit);
                if (digit) {
                    digit.classList.add('highlighted');
                    console.log('Cifra', idx, 'evidenziata!');
                }
            });
        }

        function newDivision() {
            generateDivision();
            renderDivision();
            startTimer();
            showMessage('');
        }

        function startTimer() {
            startTime = Date.now();
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = `Tempo: ${elapsed}s`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            return Math.floor((Date.now() - startTime) / 1000);
        }

        function checkAnswer() {
            let allCorrect = true;
            let emptyFields = false;
            
            const quotientInputs = document.querySelectorAll('[data-type="quotient"]');
            const quotientStr = quotient.toString();
            quotientInputs.forEach((input, idx) => {
                if (!input.value) {
                    emptyFields = true;
                } else {
                    const isCorrect = input.value === quotientStr[idx];
                    input.classList.toggle('correct', isCorrect);
                    input.classList.toggle('incorrect', !isCorrect);
                    if (!isCorrect) allCorrect = false;
                }
            });
            
            divisionSteps.forEach((step, stepIdx) => {
                const quotStepInput = document.querySelector(`[data-step="${stepIdx}"][data-type="quotient-step"]`);
                if (quotStepInput) {
                    if (!quotStepInput.value) {
                        emptyFields = true;
                    } else {
                        const isCorrect = parseInt(quotStepInput.value) === step.quotientDigit;
                        quotStepInput.classList.toggle('correct', isCorrect);
                        quotStepInput.classList.toggle('incorrect', !isCorrect);
                        if (!isCorrect) allCorrect = false;
                    }
                }
                
                const multInput = document.querySelector(`[data-step="${stepIdx}"][data-type="mult"]`);
                if (multInput) {
                    if (!multInput.value) {
                        emptyFields = true;
                    } else {
                        const isCorrect = parseInt(multInput.value) === step.quotientDigit;
                        multInput.classList.toggle('correct', isCorrect);
                        multInput.classList.toggle('incorrect', !isCorrect);
                        if (!isCorrect) allCorrect = false;
                    }
                }
                
                const productInputs = document.querySelectorAll(`[data-step="${stepIdx}"][data-type="product"]`);
                if (productInputs.length > 0) {
                    let userProduct = '';
                    productInputs.forEach(inp => {
                        if (!inp.value) {
                            emptyFields = true;
                        } else {
                            userProduct += inp.value;
                        }
                    });
                    if (userProduct) {
                        const isCorrect = parseInt(userProduct) === step.product;
                        productInputs.forEach(inp => {
                            inp.classList.toggle('correct', isCorrect);
                            inp.classList.toggle('incorrect', !isCorrect);
                        });
                        if (!isCorrect) allCorrect = false;
                    }
                }
                
                const subInputs = document.querySelectorAll(`[data-step="${stepIdx}"][data-type="subtract"]`);
                if (subInputs.length > 0) {
                    let userSub = '';
                    subInputs.forEach(inp => {
                        if (!inp.value) {
                            emptyFields = true;
                        } else {
                            userSub += inp.value;
                        }
                    });
                    if (userSub) {
                        const isCorrect = parseInt(userSub) === step.product;
                        subInputs.forEach(inp => {
                            inp.classList.toggle('correct', isCorrect);
                            inp.classList.toggle('incorrect', !isCorrect);
                        });
                        if (!isCorrect) allCorrect = false;
                    }
                }
                
                const remInputs = document.querySelectorAll(`[data-step="${stepIdx}"][data-type="remainder"]`);
                if (remInputs.length > 0) {
                    let userRem = '';
                    remInputs.forEach(inp => {
                        if (!inp.value) {
                            emptyFields = true;
                        } else {
                            userRem += inp.value;
                        }
                    });
                    if (userRem) {
                        const isCorrect = parseInt(userRem) === step.remainder;
                        remInputs.forEach(inp => {
                            inp.classList.toggle('correct', isCorrect);
                            inp.classList.toggle('incorrect', !isCorrect);
                        });
                        if (!isCorrect) allCorrect = false;
                    }
                }
            });
            
            if (emptyFields) {
                showMessage('üìù Completa tutti i campi!', 'error');
                return;
            }
            
            const elapsed = stopTimer();
            operations++;
            document.getElementById('operations').textContent = operations;
            
            if (allCorrect) {
                let points = 100;
                if (elapsed < 30) points += 50;
                else if (elapsed < 60) points += 25;
                else if (elapsed < 90) points += 10;
                
                score += points;
                streak++;
                
                if (streak >= 3) {
                    const bonusPoints = streak * 10;
                    score += bonusPoints;
                    points += bonusPoints;
                }
                
                document.getElementById('score').textContent = score;
                document.getElementById('streak').textContent = streak;
                
                showMessage(`üéâ Perfetto! Tutti i passaggi corretti! +${points} punti (${elapsed}s) üåü`, 'success');
                
                setTimeout(() => newDivision(), 3000);
            } else {
                streak = 0;
                document.getElementById('streak').textContent = streak;
                showMessage('‚ùå Controlla i passaggi evidenziati in rosso. Riprova! üí™', 'error');
            }
        }

        function showHint() {
            let hint = `üí° ${dividend} √∑ ${divisor} = ${quotient}`;
            if (remainder > 0) {
                hint += ` con resto ${remainder}`;
            }
            showMessage(hint, 'points');
        }

        function showMessage(text, type = '') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = 'message';
            if (type) messageEl.classList.add(type);
            if (text) messageEl.classList.add('show');
            
            if (text && type !== 'error') {
                setTimeout(() => {
                    messageEl.classList.remove('show');
                }, 5000);
            }
        }

        // ==================== FUNZIONE PER ESCI (DIRETTA) ====================
        function esciDalGioco() {
            if (confirm("Vuoi davvero uscire dal gioco?")) {
                // Ferma il timer se attivo
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                // Reindirizza a Google (o a qualsiasi altra pagina)
                window.location.href = "https://oragioca.github.io/matematica/";
                // In alternativa, per una pagina vuota: window.location.href = "about:blank";
            }
        }

        document.getElementById('checkBtn').addEventListener('click', checkAnswer);
        document.getElementById('newBtn').addEventListener('click', newDivision);
        document.getElementById('hintBtn').addEventListener('click', showHint);

        // NUOVO: evento per il pulsante Esci
        document.getElementById('esciBtn').addEventListener('click', esciDalGioco);

        newDivision();
    </script>
</body>
</html>