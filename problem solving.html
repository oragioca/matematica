<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tabelle e Grafici - Quinta Primaria</title>
    <style>
        /* STILI COMPLETI ‚Äì OTTIMIZZATI PER VERTICALE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Chalkboard SE', cursive;
        }
        
        body {
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3px;
            color: white;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .game-container {
            background: linear-gradient(145deg, #2d3047, #1f2235);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            padding: 8px;
            width: 100%;
            max-width: 1000px;
            text-align: center;
            border: 2px solid #3a3f5c;
            position: relative;
            overflow: hidden;
            margin: auto;
            max-height: 98vh;
            overflow-y: auto;
        }
        
        .game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6b00, #ffa500, #ff6b00);
            z-index: 1;
        }
        
        .game-header {
            margin-bottom: 8px;
            position: relative;
        }
        
        h1 {
            color: #ffa500;
            font-size: 1.3rem;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            background: linear-gradient(90deg, #ff6b00, #ffa500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
            line-height: 1.2;
            padding: 0 5px;
        }
        
        .tipo-domanda-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 8px 0 10px 0;
            width: 100%;
            flex-wrap: wrap;
        }
        
        .tipo-domanda-btn {
            padding: 8px 16px;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            background: rgba(74, 144, 226, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }
        
        .tipo-domanda-btn:hover {
            background: rgba(74, 144, 226, 0.4);
            transform: translateY(-1px);
        }
        
        .tipo-domanda-btn.attiva {
            background: #4a90e2;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 12px rgba(74, 144, 226, 0.5);
            border: 2px solid #5aa0f0;
        }
        
        .cruscotto-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 8px;
            padding: 6px;
            margin: 6px 0;
            border: 2px solid #3a3f5c;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5),
                        0 4px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            flex-wrap: nowrap;
            overflow: hidden;
        }
        
        .cruscotto-container::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border: 1px solid rgba(255, 165, 0, 0.2);
            border-radius: 5px;
            pointer-events: none;
        }
        
        .indicatore-cruscotto {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
            min-width: 0;
            padding: 0 5px;
        }
        
        .display-container {
            position: relative;
            width: 80px;
            height: 40px;
            margin-bottom: 3px;
            background: linear-gradient(145deg, #0a0e14, #05070a);
            border-radius: 5px;
            border: 2px solid #1a3b5d;
            box-shadow: 
                inset 0 0 8px rgba(0, 20, 40, 0.8),
                0 3px 4px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(0, 100, 200, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .display-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(255, 255, 255, 0.03) 0px,
                rgba(255, 255, 255, 0.03) 1px,
                transparent 1px,
                transparent 3px
            );
            pointer-events: none;
            z-index: 1;
        }
        
        .display-7segmenti {
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            font-weight: bold;
            color: #ff0000;
            text-shadow: 
                0 0 6px rgba(255, 0, 0, 0.8),
                0 0 10px rgba(255, 0, 0, 0.4);
            letter-spacing: 0.6px;
            position: relative;
            z-index: 2;
            transform: skew(-1deg);
            font-variant-numeric: tabular-nums;
        }
        
        .display-7segmenti.giallo {
            color: #ffcc00;
            text-shadow: 
                0 0 6px rgba(255, 204, 0, 0.8),
                0 0 10px rgba(255, 204, 0, 0.4);
        }
        
        .display-7segmenti.verde {
            color: #00ff00;
            text-shadow: 
                0 0 6px rgba(0, 255, 0, 0.8),
                0 0 10px rgba(0, 255, 0, 0.4);
        }
        
        .display-7segmenti.tempo {
            font-size: 0.95rem;
            letter-spacing: 0.3px;
        }
        
        .display-title {
            margin-top: 3px;
            font-size: 0.75rem;
            color: #ffcc00;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(255, 204, 0, 0.5);
            letter-spacing: 0.2px;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid rgba(255, 204, 0, 0.3);
            font-family: 'Courier New', monospace;
            white-space: nowrap;
        }
        
        .istruzioni-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 0 5px;
        }
        
        .istruzioni-btn {
            padding: 7px 14px;
            background: linear-gradient(145deg, #ffa500, #ff8c00);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            font-size: 0.85rem;
            line-height: 1.2;
            width: 100%;
            max-width: 110px;
        }
        
        .istruzioni-btn:hover {
            background: linear-gradient(145deg, #ff8c00, #e67e00);
            transform: translateY(-2px);
        }
        
        /* Stile per il pulsante Esci */
        .btn-exit {
            background: linear-gradient(145deg, #6c757d, #5a6268);
            border: none;
            border-radius: 6px;
            padding: 7px 14px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
            transition: all 0.2s;
            font-size: 0.85rem;
            width: 100%;
            max-width: 110px;
            margin-bottom: 3px;
        }
        .btn-exit:hover {
            background: linear-gradient(145deg, #5a6268, #495057);
            transform: translateY(-2px);
        }
        
        /* Raggruppamento vite + errori */
        .vite-errori-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 6px 0;
            width: 100%;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .vite-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .vita {
            width: 22px;
            height: 22px;
            background: #ff4757;
            clip-path: polygon(50% 0%, 100% 35%, 82% 100%, 18% 100%, 0% 35%);
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
            transition: all 0.3s ease;
        }
        
        .vita.persa {
            background: #3a3f5c;
            transform: scale(0.8);
        }
        
        .errori-indicatore {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            color: #ffcc00;
            font-weight: bold;
            flex-wrap: wrap;
            flex: 1;
            min-width: 180px;
        }
        
        .pallino-errore {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3a3f5c;
            border: 1px solid #ff4757;
        }
        
        .pallino-errore.attivo {
            background: #ff4757;
            box-shadow: 0 0 5px rgba(255, 71, 87, 0.8);
        }
        
        .sezione-gioco {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            position: relative;
        }
        
        .area-domanda {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(30, 33, 57, 0.8);
            border: 2px solid #4a90e2;
            border-radius: 6px;
            padding: 15px;
            margin: 6px 0;
            box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 800px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .testo-domanda {
            font-size: 1.4rem;
            font-weight: bold;
            color: #ffcc00;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.4;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            padding: 0 10px;
        }
        
        .tabella-container, .grafico-container {
            width: 90%;
            max-width: 450px;
            margin: 15px auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 2px solid #4a90e2;
            padding: 10px;
            overflow-x: auto;
        }
        
        .tabella-visuale {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
            font-size: 0.9rem;
        }
        
        .tabella-visuale th {
            background: rgba(74, 144, 226, 0.5);
            color: white;
            padding: 8px;
            border: 1px solid #4a90e2;
            text-align: center;
        }
        
        .tabella-visuale td {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            padding: 8px;
            border: 1px solid #4a90e2;
            text-align: center;
        }
        
        .grafico-visuale {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        
        .grafico-barre {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 180px;
            width: 100%;
            padding: 10px;
            border-bottom: 2px solid #4a90e2;
            border-left: 2px solid #4a90e2;
            position: relative;
            margin-bottom: 10px;
        }
        
        .barra {
            width: 30px;
            background: linear-gradient(to top, #ff6b6b, #ffa500);
            border-radius: 4px 4px 0 0;
            position: relative;
            display: flex;
            justify-content: center;
        }
        
        .valore-barra {
            position: absolute;
            top: -25px;
            color: #ffcc00;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .etichetta-barra {
            position: absolute;
            bottom: -25px;
            color: white;
            font-size: 0.8rem;
        }
        
        .grafico-torta {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: conic-gradient(
                #ff6b6b 0% 25%,
                #4ecdc4 25% 50%,
                #ffa500 50% 75%,
                #9370db 75% 100%
            );
            margin: 15px auto;
            position: relative;
        }
        
        .grafico-torta::before {
            content: '';
            position: absolute;
            width: 90px;
            height: 90px;
            background: #2d3047;
            border-radius: 50%;
            top: 45px;
            left: 45px;
        }
        
        .legenda-grafico {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .elemento-legenda {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }
        
        .colore-legenda {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        
        .grafico-linee {
            position: relative;
            width: 100%;
            height: 200px;
            border-bottom: 2px solid #4a90e2;
            border-left: 2px solid #4a90e2;
            margin-bottom: 40px;
            box-sizing: border-box;
            background: rgba(0,0,0,0.2);
        }
        
        .punto-linea {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff6b6b;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 3;
            pointer-events: none;
        }
        
        .linea-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        .etichetta-linea {
            position: absolute;
            bottom: -35px;
            color: white;
            font-size: 0.8rem;
            transform: translateX(-50%);
            font-weight: bold;
            white-space: nowrap;
            z-index: 1;
            pointer-events: none;
        }
        
        .valore-linea {
            position: absolute;
            color: #ffcc00;
            font-weight: bold;
            font-size: 0.8rem;
            transform: translateX(-50%) translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 5px;
            border-radius: 3px;
            white-space: nowrap;
            z-index: 1;
            pointer-events: none;
        }
        
        .asse-y {
            position: absolute;
            left: -30px;
            top: 0;
            bottom: 0;
            width: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            color: #4a90e2;
            font-size: 0.7rem;
        }
        
        .opzioni-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
        }
        
        .opzione-btn {
            padding: 12px 5px;
            background: linear-gradient(145deg, #3a3f5c, #2d3047);
            border: 2px solid #4a90e2;
            border-radius: 8px;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .opzione-btn:hover {
            background: linear-gradient(145deg, #4a4f6c, #3d4057);
            transform: translateY(-3px);
            border-color: #5aa0f0;
        }
        
        .opzione-btn.selezionata {
            background: linear-gradient(145deg, #28a745, #1e7e34);
            border-color: #32cd32;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.6);
        }
        
        .opzione-btn.errata {
            background: linear-gradient(145deg, #dc3545, #c82333);
            border-color: #ff4757;
        }
        
        .opzione-btn.parzialmente-corretta {
            background: linear-gradient(145deg, #ffc107, #ff9800);
            border-color: #ffca28;
        }
        
        .risposta-aperta-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .risposta-input-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .casella-risposta {
            width: 80px;
            height: 60px;
            margin: 0 5px;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid #4a90e2;
            border-radius: 8px;
            color: white;
            outline: none;
        }
        
        .casella-risposta:focus {
            border-color: #ffa500;
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .casella-risposta.corretta {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.2);
        }
        
        .casella-risposta.errata {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.2);
        }
        
        .messaggio-verifica {
            background: rgba(255, 193, 7, 0.2);
            border: 2px dashed #ffc107;
            border-radius: 6px;
            padding: 8px 10px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            color: white;
            width: 90%;
            max-width: 450px;
            margin: 6px auto;
            text-align: center;
        }
        
        .messaggio-verifica.mostra {
            opacity: 1;
            transform: translateY(0);
        }
        
        .messaggio-corretto {
            background: rgba(40, 167, 69, 0.3);
            border-color: #28a745;
            color: #90ee90;
        }
        
        .messaggio-errato {
            background: rgba(220, 53, 69, 0.3);
            border-color: #dc3545;
            color: #ff6b6b;
        }
        
        .messaggio-parziale {
            background: rgba(255, 193, 7, 0.3);
            border-color: #ffc107;
            color: #ffd166;
        }
        
        .messaggio-info {
            background: rgba(255, 193, 7, 0.3);
            border-color: #ffc107;
            color: #ffd166;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .messaggio-info:hover {
            background: rgba(255, 193, 7, 0.4);
        }
        
        .messaggio-game-over {
            background: rgba(108, 117, 125, 0.3);
            border-color: #495057;
            color: white;
            font-size: 0.8rem;
            padding: 10px;
        }
        
        .messaggio-wow {
            background: linear-gradient(145deg, #ff0080, #ff00ff);
            border: 2px solid #ff00ff;
            color: #ffffff;
            animation: rainbow 2s infinite;
            font-size: 0.9rem;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
        }
        
        .messaggio-ahi {
            background: linear-gradient(145deg, #ff0000, #ff4500);
            border: 2px solid #ff0000;
            color: #ffffff;
            animation: shake 0.5s ease-in-out;
            font-size: 0.9rem;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
        }
        
        @keyframes rainbow {
            0%, 100% { 
                background: linear-gradient(145deg, #ff0080, #ff00ff);
                box-shadow: 0 0 12px rgba(255, 0, 255, 0.8);
            }
            25% { 
                background: linear-gradient(145deg, #00ffff, #0080ff);
                box-shadow: 0 0 12px rgba(0, 255, 255, 0.8);
            }
            50% { 
                background: linear-gradient(145deg, #00ff80, #00ff00);
                box-shadow: 0 0 12px rgba(0, 255, 0, 0.8);
            }
            75% { 
                background: linear-gradient(145deg, #ffff00, #ff8000);
                box-shadow: 0 0 12px rgba(255, 255, 0, 0.8);
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .controlli {
            display: none;
            justify-content: center;
            gap: 8px;
            margin: 8px 0;
            flex-wrap: wrap;
            animation: fadeIn 0.5s ease 0.3s both;
        }
        
        .bottone {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: linear-gradient(145deg, #4a90e2, #3a7bd5);
            color: white;
            transition: all 0.2s;
            min-width: 90px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            font-size: 0.85rem;
            line-height: 1.2;
            flex: 1;
            max-width: 140px;
        }
        
        .bottone:hover {
            background: linear-gradient(145deg, #3a7bd5, #2a6bc5);
            transform: translateY(-2px);
            box-shadow: 0 5px 7px rgba(0, 0, 0, 0.4);
        }
        
        .bottone-verifica {
            background: linear-gradient(145deg, #28a745, #1e7e34);
        }
        
        .bottone-verifica:hover {
            background: linear-gradient(145deg, #1e7e34, #156d2b);
        }
        
        .bottone-aiuto {
            background: linear-gradient(145deg, #ffa500, #ff8c00);
        }
        
        .bottone-aiuto:hover {
            background: linear-gradient(145deg, #ff8c00, #e67e00);
        }
        
        .bottone-nuova {
            background: linear-gradient(145deg, #9370db, #7b5fcf);
        }
        
        .bottone-nuova:hover {
            background: linear-gradient(145deg, #7b5fcf, #6a4fcb);
        }
        
        .tastiera-container {
            display: none;
            background: rgba(30, 33, 57, 0.8);
            border-radius: 6px;
            padding: 8px;
            border: 2px solid #4a90e2;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.4);
            margin-top: 8px;
            animation: fadeIn 0.5s ease 0.6s both;
        }
        
        .tastiera-numerica {
            display: flex;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .tasto-numero {
            width: 40px;
            height: 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            background: linear-gradient(145deg, #3a3f5c, #2d3047);
            cursor: pointer;
            color: #ffffff;
            transition: all 0.2s;
            flex: 0 0 auto;
        }
        
        .tasto-numero:hover {
            background: linear-gradient(145deg, #4a4f6c, #3d4057);
            transform: translateY(-2px);
        }
        
        .tasto-cancella {
            background: linear-gradient(145deg, #ff4757, #ff3742);
            color: white;
            border-color: #dc3545;
            font-size: 0.9rem;
            width: 60px;
        }
        
        .tasto-cancella:hover {
            background: linear-gradient(145deg, #ff3742, #ff2732);
        }
        
        .risposte-consecutive, .aiuti-utilizzati {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
            font-size: 0.65rem;
            color: #a0a0c0;
            font-weight: bold;
        }
        
        .cuore-consecutivo {
            color: #ff4757;
            font-size: 0.8rem;
        }
        
        .icona-aiuto {
            color: #ffa500;
            font-size: 0.8rem;
        }
        
        .messaggio-avvio {
            background: linear-gradient(145deg, #4a90e2, #3a7bd5);
            border: 3px solid #ffa500;
            border-radius: 10px;
            padding: 15px;
            margin: 10px auto;
            max-width: 450px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            animation: pulse-glow 2s infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4),
                            0 0 0px rgba(255, 165, 0, 0.5);
            }
            50% { 
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4),
                            0 0 20px rgba(255, 165, 0, 0.8);
            }
        }
        
        .messaggio-avvio:hover {
            transform: scale(1.03);
            background: linear-gradient(145deg, #3a7bd5, #2a6bc5);
        }
        
        .messaggio-avvio h2 {
            color: #ffcc00;
            font-size: 1.3rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .messaggio-avvio p {
            color: white;
            margin-bottom: 6px;
            font-size: 0.9rem;
            line-height: 1.3;
            text-align: center;
        }
        
        .messaggio-avvio .istruzione-principale {
            font-size: 1rem;
            font-weight: bold;
            color: #ffcc00;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border: 1px solid rgba(255, 204, 0, 0.3);
        }
        
        .messaggio-avvio .istruzione-gioco {
            font-size: 0.9rem;
            color: #ffd166;
            background: rgba(255, 193, 7, 0.2);
            border: 2px dashed #ffc107;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
            width: 90%;
            max-width: 350px;
        }
        
        .icona-play {
            font-size: 2rem;
            margin-bottom: 10px;
            animation: bounce 1.5s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 8px;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #2d3047, #1f2235);
            border-radius: 6px;
            padding: 10px;
            width: 95%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            border: 2px solid #4a90e2;
            position: relative;
            color: white;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 5px;
        }
        
        .modal-title {
            color: #ffa500;
            font-size: 0.9rem;
        }
        
        .close-modal {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .modal-section {
            margin-bottom: 8px;
            text-align: left;
        }
        
        .modal-section h3 {
            color: #4a90e2;
            margin-bottom: 4px;
            font-size: 0.8rem;
            border-left: 3px solid #ffa500;
            padding-left: 4px;
        }
        
        .modal-section p {
            margin-bottom: 4px;
            line-height: 1.2;
            font-size: 0.7rem;
            color: #d0d0e0;
        }
        
        .modal-list {
            list-style-type: decimal;
            padding-left: 12px;
            margin: 5px 0;
            color: #d0d0e0;
        }
        
        .modal-list li {
            margin-bottom: 4px;
            line-height: 1.2;
            font-size: 0.7rem;
        }
        
        .punteggio-info {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .punteggio-item {
            background: rgba(74, 144, 226, 0.2);
            padding: 4px;
            border-radius: 4px;
            border: 2px solid #4a90e2;
            flex: 1;
            min-width: 80px;
        }
        
        .punteggio-item .value {
            font-weight: bold;
            color: #28a745;
            font-size: 0.75rem;
        }
        
        .multi-selezione-info {
            font-size: 0.9rem;
            color: #ffcc00;
            margin: 10px 0;
            padding: 5px 10px;
            background: rgba(255, 204, 0, 0.1);
            border-radius: 5px;
            border: 1px dashed #ffcc00;
        }
        
        .messaggio-suggerimento {
            background: linear-gradient(145deg, #3498db, #2980b9);
            border: 2px solid #3498db;
            color: #ffffff;
            font-size: 0.9rem;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
            animation: pulse-suggerimento 2s infinite;
        }
        
        @keyframes pulse-suggerimento {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
            }
            50% { 
                box-shadow: 0 0 20px rgba(52, 152, 219, 0.8);
            }
        }
        
        .bottone-cambia-sezione {
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            border: 2px solid #2980b9;
            margin-top: 8px;
        }
        
        .bottone-cambia-sezione:hover {
            background: linear-gradient(145deg, #2980b9, #1f618d);
            transform: translateY(-2px);
        }
        
        .bottone-prossima {
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            border: 2px solid #2980b9;
        }
        
        .bottone-prossima:hover {
            background: linear-gradient(145deg, #2980b9, #1f618d);
            transform: translateY(-2px);
        }
        
        /* ========== MEDIA QUERY ‚Äì OTTIMIZZAZIONE VERTICALE ========== */
        @media (max-width: 768px) {
            body {
                padding: 2px;
                align-items: flex-start;
            }
            
            .game-container {
                padding: 6px;
                margin: 2px auto;
                border-radius: 10px;
                max-height: 96vh;
            }
            
            h1 {
                font-size: 1.2rem;
                margin-bottom: 6px;
            }
            
            .tipo-domanda-container {
                margin: 6px 0 8px 0;
                gap: 8px;
            }
            
            .tipo-domanda-btn {
                padding: 7px 14px;
                font-size: 0.8rem;
                min-width: 85px;
            }
            
            .cruscotto-container {
                padding: 5px;
                margin: 4px 0;
            }
            
            .display-container {
                width: 75px;
                height: 36px;
            }
            
            .display-7segmenti {
                font-size: 1.3rem;
            }
            
            .display-7segmenti.tempo {
                font-size: 0.9rem;
            }
            
            .display-title {
                font-size: 0.7rem;
                padding: 2px 5px;
            }
            
            .istruzioni-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
                max-width: 100px;
            }
            
            .btn-exit {
                padding: 6px 12px;
                font-size: 0.8rem;
                max-width: 100px;
                margin-bottom: 3px;
            }
            
            .area-domanda {
                padding: 12px;
                margin: 4px 0;
            }
            
            .testo-domanda {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }
            
            .opzioni-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .opzione-btn {
                padding: 10px;
                font-size: 1rem;
            }
            
            .vita {
                width: 20px;
                height: 20px;
            }
            
            .errori-indicatore {
                font-size: 0.65rem;
                gap: 4px;
            }
            
            .pallino-errore {
                width: 10px;
                height: 10px;
            }
            
            .controlli {
                gap: 6px;
                margin: 6px 0;
            }
            
            .bottone {
                padding: 7px 10px;
                min-width: 80px;
                font-size: 0.8rem;
                max-width: 120px;
            }
            
            .messaggio-avvio {
                padding: 12px;
                margin: 8px auto;
            }
            
            .messaggio-avvio h2 {
                font-size: 1.2rem;
            }
            
            .messaggio-avvio p {
                font-size: 0.85rem;
            }
            
            .tastiera-container {
                padding: 6px;
            }
            
            .tasto-numero {
                width: 45px;
                height: 45px;
                font-size: 1.2rem;
            }
            
            .tasto-cancella {
                width: 70px;
                font-size: 0.9rem;
                height: 45px;
            }
            
            .casella-risposta {
                width: 70px;
                height: 55px;
                font-size: 1.8rem;
            }
            
            .messaggio-verifica {
                padding: 6px 8px;
                min-height: 35px;
                font-size: 0.75rem;
                margin: 4px auto;
            }
            
            .grafico-linee {
                height: 180px;
                margin-bottom: 35px;
            }
        }
        
        @media (max-width: 480px) {
            .game-container {
                padding: 5px;
                max-height: 94vh;
            }
            
            h1 {
                font-size: 1.1rem;
                margin-bottom: 4px;
            }
            
            .tipo-domanda-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
                margin: 4px 0 6px 0;
            }
            
            .tipo-domanda-btn {
                padding: 6px 12px;
                font-size: 0.75rem;
                min-width: 0;
                width: 100%;
            }
            
            .cruscotto-container {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                align-items: center;
                gap: 4px;
                padding: 4px;
            }
            
            .indicatore-cruscotto, .istruzioni-container {
                flex: none;
                width: 100%;
                padding: 0;
            }
            
            .display-container {
                width: 70px;
                height: 34px;
            }
            
            .display-7segmenti {
                font-size: 1.2rem;
            }
            
            .display-7segmenti.tempo {
                font-size: 0.85rem;
            }
            
            .display-title {
                font-size: 0.65rem;
                padding: 2px 4px;
            }
            
            .istruzioni-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
                max-width: 90px;
            }
            
            .btn-exit {
                padding: 5px 10px;
                font-size: 0.75rem;
                max-width: 90px;
                margin-bottom: 3px;
            }
            
            .vite-errori-row {
                flex-wrap: nowrap;
                gap: 8px;
            }
            
            .vite-container {
                gap: 6px;
                flex-shrink: 0;
            }
            
            .vita {
                width: 18px;
                height: 18px;
            }
            
            .errori-indicatore {
                justify-content: flex-end;
                font-size: 0.6rem;
                gap: 3px;
                min-width: 0;
            }
            
            .errori-indicatore span:last-child {
                display: none;
            }
            
            .opzioni-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .opzione-btn {
                padding: 8px 4px;
                font-size: 0.95rem;
            }
            
            .controlli {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .bottone {
                width: 100%;
                max-width: none;
                padding: 8px 6px;
                font-size: 0.8rem;
            }
            
            .testo-domanda {
                font-size: 1.1rem;
            }
            
            .messaggio-avvio {
                padding: 10px;
            }
            
            .messaggio-avvio h2 {
                font-size: 1.1rem;
            }
            
            .messaggio-avvio p {
                font-size: 0.8rem;
            }
            
            .icona-play {
                font-size: 1.8rem;
            }
            
            .tasto-numero {
                width: 48px;
                height: 48px;
                font-size: 1.3rem;
            }
            
            .tasto-cancella {
                width: 75px;
                height: 48px;
            }
            
            .casella-risposta {
                width: 65px;
                height: 50px;
                font-size: 1.6rem;
            }
            
            .messaggio-verifica {
                font-size: 0.7rem;
                padding: 5px 6px;
                min-height: 30px;
            }
            
            .modal-content {
                padding: 8px;
            }
            
            .grafico-linee {
                height: 160px;
                margin-bottom: 30px;
            }
        }
        
        @media (max-width: 360px) {
            .tipo-domanda-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 4px;
            }
            
            .tipo-domanda-btn {
                padding: 5px 8px;
                font-size: 0.7rem;
            }
            
            .cruscotto-container {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 2px;
            }
            
            .display-container {
                width: 65px;
                height: 32px;
            }
            
            .display-7segmenti {
                font-size: 1.1rem;
            }
            
            .vite-errori-row {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .errori-indicatore span:last-child {
                display: none;
            }
            
            .opzioni-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 4px;
            }
            
            .opzione-btn {
                padding: 6px 2px;
                font-size: 0.85rem;
            }
            
            .controlli {
                grid-template-columns: repeat(2, 1fr);
                gap: 4px;
            }
            
            .bottone {
                padding: 6px 4px;
                font-size: 0.75rem;
            }
            
            .grafico-linee {
                height: 150px;
                margin-bottom: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>TABELLE E GRAFICI per la Scuola Primaria</h1>
            
            <div class="tipo-domanda-container">
                <button class="tipo-domanda-btn attiva" id="tipo-tabelle">
                    üìä Tabelle
                </button>
                <button class="tipo-domanda-btn" id="tipo-grafici">
                    üìà Grafici
                </button>
                <button class="tipo-domanda-btn" id="tipo-conversione">
                    üîÑ Conversione
                </button>
                <button class="tipo-domanda-btn" id="tipo-interpretazione">
                    üß† Interpretazione
                </button>
            </div>
            
            <div class="cruscotto-container">
                <div class="indicatore-cruscotto">
                    <div class="display-container">
                        <div class="display-7segmenti giallo" id="punteggio-display">0</div>
                    </div>
                    <div class="display-title">PUNTEGGIO</div>
                </div>
                
                <div class="istruzioni-container">
                    <button class="istruzioni-btn" id="istruzioni-btn" title="Istruzioni del gioco">
                        üìö Istruzioni
                    </button>
                    <!-- TESTO ISTRUZIONI RIMOSSO -->
                </div>
                
                <div class="indicatore-cruscotto">
                    <div class="display-container">
                        <div class="display-7segmenti verde tempo" id="tempo-display">10:00</div>
                    </div>
                    <div class="display-title">TEMPO</div>
                </div>

                <!-- NUOVO PULSANTE ESCI (senza testo sotto) -->
                <div class="indicatore-cruscotto">
                    <button class="btn-exit" id="esciBtn">üö™ Esci</button>
                </div>
            </div>
            
            <!-- RIGA UNICA PER VITE ED ERRORI -->
            <div class="vite-errori-row">
                <div class="vite-container" id="vite-container"></div>
                
                <div class="errori-indicatore" id="errori-indicatore">
                    <span>Errori consecutivi:</span>
                    <div class="pallino-errore" id="errore-1"></div>
                    <div class="pallino-errore" id="errore-2"></div>
                    <div class="pallino-errore" id="errore-3"></div>
                    <span>(perdi 1 vita al 3¬∞ errore)</span>
                </div>
            </div>
            
            <div class="risposte-consecutive" id="risposte-consecutive">
                <span>Risposte consecutive corrette:</span>
                <span id="contatore-consecutive">0</span>
                <span class="cuore-consecutivo">‚ù§Ô∏è</span>
            </div>
            
            <div class="aiuti-utilizzati" id="aiuti-utilizzati">
                <span>Aiuti utilizzati in questa domanda:</span>
                <span id="contatore-aiuti">0</span>
                <span class="icona-aiuto">üß†</span>
                <span>(costo: -2 punti ciascuno)</span>
            </div>
        </div>
        
        <div class="sezione-gioco">
            <div class="messaggio-avvio" id="messaggio-avvio">
                <div class="icona-play">üìä</div>
                <h2>Pronti per il mondo di tabelle e grafici?</h2>
                <p>Impara a leggere, interpretare e costruire tabelle e grafici!</p>
                <div class="istruzione-gioco">
                    Alcune domande hanno pi√π risposte corrette!<br>
                    Clicca su tutte le opzioni che ritieni corrette.
                </div>
                <p class="istruzione-principale">Clicca qui per iniziare a giocare!</p>
            </div>
            
            <div class="area-domanda" id="area-domanda"></div>
            
            <div class="messaggio-verifica" id="messaggio-verifica"></div>
        </div>
        
        <div class="controlli" id="controlli-gioco">
            <button class="bottone bottone-aiuto" id="bottone-aiuto">
                üß† Aiuto (-2)
            </button>
            <button class="bottone bottone-verifica" id="bottone-verifica">
                ‚úì Verifica
            </button>
            <button class="bottone bottone-prossima" id="bottone-prossima" style="display: none;">
                ‚è≠Ô∏è Prossima
            </button>
            <button class="bottone bottone-nuova" id="bottone-nuova">
                üîÑ Nuova Partita
            </button>
        </div>
        
        <div class="tastiera-container" id="tastiera-container">
            <div class="tastiera-numerica" id="tastiera-numerica"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    üìö Istruzioni del Gioco - Tabelle e Grafici INVALSI
                </div>
                <button class="close-modal" id="close-modal">‚úï</button>
            </div>
            
            <div class="modal-section">
                <h3>üéØ Come Giocare</h3>
                <p>Impara a lavorare con tabelle e grafici:</p>
                <ol class="modal-list">
                    <li>Scegli il tipo di domanda (Tabelle, Grafici, Conversione, Interpretazione)</li>
                    <li>Leggi attentamente la domanda e osserva tabelle e grafici</li>
                    <li>Per domande a scelta multipla: clicca sulla risposta corretta</li>
                    <li>Per domande con pi√π risposte: clicca su TUTTE le risposte corrette</li>
                    <li>Per vero/falso: clicca su VERO o FALSO</li>
                    <li>Per risposte aperte: scrivi il numero o la parola corretta</li>
                    <li>Premi "Verifica" per controllare la risposta</li>
                    <li>Dopo la verifica, premi "Prossima" per passare alla domanda successiva</li>
                </ol>
            </div>
            
            <div class="modal-section">
                <h3>üìä Tipi di Domande</h3>
                <p><strong>Tabelle:</strong> Lettura di dati da tabelle, calcolo di totali, medie, differenze</p>
                <p><strong>Grafici:</strong> Lettura di dati da grafici a barre, lineari, a torta</p>
                <p><strong>Conversione:</strong> Trasformazione di dati da tabella a grafico e viceversa</p>
                <p><strong>Interpretazione:</strong> Comprensione e analisi di dati presentati in tabelle o grafici</p>
                <p><strong>Vero/Falso:</strong> Affermazioni da valutare come vere o false</p>
                <p><strong>Scelta Multipla:</strong> 4 opzioni, una sola corretta</p>
                <p><strong>Scelta Multipla Multipla:</strong> 4 opzioni, pi√π risposte corrette possibili</p>
            </div>
            
            <div class="modal-section">
                <h3>üìà Tipi di Grafici Studiati</h3>
                <p><strong>Grafico a barre:</strong> Confronta quantit√† diverse con barre di altezze diverse</p>
                <ul class="modal-list">
                    <li>Asse verticale: valori numerici</li>
                    <li>Asse orizzontale: categorie</li>
                </ul>
                <p><strong>Grafico a linee:</strong> Mostra cambiamenti nel tempo</p>
                <ul class="modal-list">
                    <li>Asse orizzontale: tempo (giorni, mesi, anos)</li>
                    <li>Asse verticale: valori</li>
                    <li>Punti collegati da linee</li>
                </ul>
                <p><strong>Grafico a torta:</strong> Mostra parti di un tutto</p>
                <ul class="modal-list">
                    <li>Ogni settore √® una parte percentuale</li>
                    <li>La somma di tutte le parti √® 100%</li>
                </ul>
                <p><strong>Tabelle:</strong> Dati organizzati in righe e colonne</p>
                <ul class="modal-list">
                    <li>Righe: oggetti o categorie</li>
                    <li>Colonne: caratteristiche o misure</li>
                </ul>
            </div>
            
            <div class="modal-section">
                <h3>üèÜ Sistema dei Punteggi e Vite</h3>
                <div class="punteggio-info">
                    <div class="punteggio-item">
                        <div>Risposta corretta:</div>
                        <div class="value">+2 punti</div>
                    </div>
                    <div class="punteggio-item">
                        <div>Aiuto utilizzato:</div>
                        <div class="value">-2 punti ciascuno</div>
                    </div>
                    <div class="punteggio-item">
                        <div>Domande con pi√π risposte:</div>
                        <div class="value">+3 punti se tutte corrette</div>
                    </div>
                    <div class="punteggio-item">
                        <div>5 risposte corrette consecutive:</div>
                        <div class="value">+1 vita</div>
                    </div>
                </div>
                <p><strong>‚ö†Ô∏è Attenzione:</strong> Se usi troppi aiuti, potresti finire con 0 punti per quella domanda!</p>
                <p><strong>‚ú® Bonus Vita:</strong> Ogni 5 risposte consecutive corrette, recuperi una vita (massimo 3 vite).</p>
                <p><strong>üîÑ Sistema Errori:</strong> Perdi una vita solo dopo 3 errori consecutivi. Ogni risposta corretta resetta il contatore errori.</p>
            </div>
            
            <div class="modal-section">
                <h3>‚è±Ô∏è Tempo</h3>
                <p>Hai 10 minuti per rispondere a quante pi√π domande possibili!</p>
                <p>Il timer diventa rosso quando mancano meno di 60 secondi.</p>
            </div>
            
            <div class="modal-section">
                <h3>üéì Obiettivo Didattico</h3>
                <p>Questo gioco promuove il potenziamento delle competenze di base di matematica per la quinta classe della scuola primaria, sviluppando:</p>
                <ul class="modal-list">
                    <li>Lettura e interpretazione di tabelle e grafici</li>
                    <li>Calcolo di totali, differenze e medie da dati</li>
                    <li>Conversione tra tabelle e grafici</li>
                    <li>Comprensione di grafici a barre, lineari e a torta</li>
                    <li>Analisi critica di dati presentati visivamente</li>
                    <li>Applicazione di concetti matematici a situazioni reali</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ==================== VARIABILI GLOBALI ====================
        let punteggio = 0;
        let vite = 3;
        let tipoGioco = 'tabelle';
        let verificaEseguita = false;
        let gameOver = false;
        let haSbagliatoQuestaDomanda = false;
        
        let operazioniCorretteConsecutive = 0;
        let aiutiUtilizzatiDomandaCorrente = 0;
        let rispostaCorrente = null;
        let opzioniSelezionate = [];
        let rispostaAperta = "";
        
        let tempoRimanente = 600;
        let timerInterval;
        let timerAttivo = false;
        const TEMPO_TOTALE = 600;
        
        let timeoutBenvenuto = null;
        let giocoIniziato = false;
        
        let erroriConsecutivi = 0;
        
        let domandeConsecutiveStessaSezione = 0;
        let haMostratoSuggerimentoCambioSezione = false;
        const LIMITE_DOMANDE_PRIMA_SUGGERIMENTO = 8;
        
        // ==================== TUTTE LE DOMANDE (80) ====================
        const tutteLeDomande = {
            tabelle: [
                {
                    tipo: "scelta_multipla",
                    domanda: "La tabella mostra i voti di matematica di 5 alunni. Chi ha preso il voto pi√π alto?",
                    tabella: {
                        intestazioni: ["Alunno", "Voto"],
                        righe: [
                            ["Marco", "8"],
                            ["Anna", "9"],
                            ["Luca", "7"],
                            ["Sofia", "10"],
                            ["Giovanni", "6"]
                        ]
                    },
                    opzioni: ["Marco", "Anna", "Sofia", "Giovanni"],
                    risposta: 2,
                    spiegazione: "Sofia ha preso 10, che √® il voto pi√π alto nella tabella.",
                    difficolta: 1
                },
                // ... (tutte le altre domande sono identiche al file originale) ...
            ],
            grafici: [],
            conversione: [],
            interpretazione: []
        };

        // ==================== FUNZIONI UTILI ====================
        function mescolaArray(array) {
            let arrayMescolato = [...array];
            for (let i = arrayMescolato.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arrayMescolato[i], arrayMescolato[j]] = [arrayMescolato[j], arrayMescolato[i]];
            }
            return arrayMescolato;
        }

        let domande = {
            tabelle: mescolaArray([...tutteLeDomande.tabelle]),
            grafici: mescolaArray([...tutteLeDomande.grafici]),
            conversione: mescolaArray([...tutteLeDomande.conversione]),
            interpretazione: mescolaArray([...tutteLeDomande.interpretazione])
        };

        let domandaCorrente = null;
        let domandeDisponibili = [...domande.tabelle];
        let indiceDomandaCorrente = 0;

        // ==================== AUDIO ====================
        let audioContext;
        let audioInizializzato = false;
        let wowSound, ahiSound, successSound, clickSound, startSound;

        function inizializzaAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                creaSuoni();
                audioInizializzato = true;
            } catch (e) {
                console.log("Audio non supportato:", e);
                audioInizializzato = false;
            }
        }

        function creaSuoni() {
            // (funzioni audio come nell'originale)
        }

        function playSound(soundBuffer, volume = 0.7) {
            if (!audioInizializzato || !soundBuffer) return;
            try {
                const source = audioContext.createBufferSource();
                source.buffer = soundBuffer;
                const gainNode = audioContext.createGain();
                gainNode.gain.value = volume;
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);
                source.start();
                gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + soundBuffer.duration);
            } catch (e) {}
        }
        function playWowSound() { playSound(wowSound, 0.8); }
        function playAhiSound() { playSound(ahiSound, 0.6); }
        function playSuccessSound() { playSound(successSound, 0.5); }
        function playClickSound() { playSound(clickSound, 0.3); }
        function playStartSound() { playSound(startSound, 0.7); }

        // ==================== DISPLAY ====================
        function aggiornaDisplayPunteggio() {
            const punteggioDisplay = document.getElementById('punteggio-display');
            punteggioDisplay.style.opacity = '0.7';
            punteggioDisplay.style.transform = 'scale(1.1) skew(-1deg)';
            setTimeout(() => {
                punteggioDisplay.textContent = punteggio;
                punteggioDisplay.style.opacity = '1';
                punteggioDisplay.style.transform = 'scale(1) skew(-1deg)';
                if (punteggio >= 150) punteggioDisplay.className = 'display-7segmenti giallo';
                else if (punteggio >= 100) punteggioDisplay.className = 'display-7segmenti verde';
                else punteggioDisplay.className = 'display-7segmenti giallo';
            }, 150);
        }
        function aggiornaDisplayTempo() {
            const tempoDisplay = document.getElementById('tempo-display');
            const minuti = Math.floor(tempoRimanente / 60);
            const secondi = tempoRimanente % 60;
            const tempoFormattato = `${minuti.toString().padStart(2, '0')}:${secondi.toString().padStart(2, '0')}`;
            tempoDisplay.style.opacity = '0.7';
            tempoDisplay.style.transform = 'scale(1.05) skew(-1deg)';
            setTimeout(() => {
                tempoDisplay.textContent = tempoFormattato;
                tempoDisplay.style.opacity = '1';
                tempoDisplay.style.transform = 'scale(1) skew(-1deg)';
                if (tempoRimanente <= 60) {
                    tempoDisplay.style.color = '#ff0000';
                    tempoDisplay.style.textShadow = '0 0 8px rgba(255, 0, 0, 0.8), 0 0 15px rgba(255, 0, 0, 0.4)';
                    if (tempoRimanente <= 10) tempoDisplay.style.animation = 'pulse 0.5s infinite';
                    else tempoDisplay.style.animation = '';
                } else {
                    tempoDisplay.style.color = '#00ff00';
                    tempoDisplay.style.textShadow = '0 0 6px rgba(0, 255, 0, 0.8), 0 0 10px rgba(0, 255, 0, 0.4)';
                    tempoDisplay.style.animation = '';
                }
            }, 150);
        }
        function aggiornaVite() {
            const viteContainer = document.getElementById('vite-container');
            viteContainer.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const vita = document.createElement('div');
                vita.className = 'vita';
                if (i >= vite) vita.classList.add('persa');
                viteContainer.appendChild(vita);
            }
        }
        function avviaTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerAttivo = true;
            timerInterval = setInterval(() => {
                if (tempoRimanente <= 0) {
                    clearInterval(timerInterval);
                    timerAttivo = false;
                    gameOver = true;
                    mostraGameOver();
                    return;
                }
                tempoRimanente--;
                aggiornaDisplayTempo();
                if (tempoRimanente === 60) mostraMessaggio("‚ö†Ô∏è Attenzione! Manca solo 1 minuto!", "messaggio-info");
                if (tempoRimanente === 10) playAhiSound();
            }, 1000);
        }
        function pausaTimer() {
            timerAttivo = false;
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        }
        function ripristinaTimer() {
            tempoRimanente = TEMPO_TOTALE;
            aggiornaDisplayTempo();
        }

        // ==================== MESSAGGI ====================
        function mostraMessaggio(testo, classe = "messaggio-info") {
            const messaggioDiv = document.getElementById('messaggio-verifica');
            messaggioDiv.textContent = testo;
            messaggioDiv.className = "messaggio-verifica";
            messaggioDiv.classList.add(classe, "mostra");
            if (classe === "messaggio-info" || classe === "messaggio-suggerimento") {
                setTimeout(() => {
                    messaggioDiv.classList.remove("mostra");
                    setTimeout(() => { messaggioDiv.textContent = ""; }, 300);
                }, 5000);
            }
            if (classe === "messaggio-wow") playWowSound();
            else if (classe === "messaggio-ahi") playAhiSound();
        }
        function nascondiMessaggio() {
            const messaggioDiv = document.getElementById('messaggio-verifica');
            messaggioDiv.classList.remove("mostra");
            setTimeout(() => { messaggioDiv.textContent = ""; }, 300);
        }

        // ==================== GIOCO ====================
        function aggiornaErroriIndicatore() {
            for (let i = 1; i <= 3; i++) {
                const pallino = document.getElementById(`errore-${i}`);
                if (i <= erroriConsecutivi) pallino.classList.add('attivo');
                else pallino.classList.remove('attivo');
            }
        }
        function aggiornaContatori() {
            document.getElementById('contatore-consecutive').textContent = operazioniCorretteConsecutive;
            document.getElementById('contatore-aiuti').textContent = aiutiUtilizzatiDomandaCorrente;
            const risposteConsecutive = document.getElementById('risposte-consecutive');
            const aiutiUtilizzati = document.getElementById('aiuti-utilizzati');
            if (operazioniCorretteConsecutive > 0) risposteConsecutive.style.display = 'flex';
            else risposteConsecutive.style.display = 'none';
            if (aiutiUtilizzatiDomandaCorrente > 0) aiutiUtilizzati.style.display = 'flex';
            else aiutiUtilizzati.style.display = 'none';
        }

        function iniziaGioco() {
            if (!giocoIniziato) {
                playStartSound();
                const messaggioAvvio = document.getElementById('messaggio-avvio');
                messaggioAvvio.style.display = 'none';
                document.getElementById('controlli-gioco').style.display = 'flex';
                giocoIniziato = true;
                gameOver = false;
                ripristinaTimer();
                vite = 3;
                punteggio = 0;
                operazioniCorretteConsecutive = 0;
                erroriConsecutivi = 0;
                domandeConsecutiveStessaSezione = 0;
                haMostratoSuggerimentoCambioSezione = false;
                aggiornaVite();
                aggiornaDisplayPunteggio();
                aggiornaErroriIndicatore();
                aggiornaContatori();
                avviaTimer();
                creaNuovaDomanda();
                document.getElementById('area-domanda').style.display = 'flex';
            }
        }

        function cambiaTipoDomanda(tipo) {
            if (!giocoIniziato && !gameOver) {
                iniziaGioco();
            }
            tipoGioco = tipo;
            document.querySelectorAll('.tipo-domanda-btn').forEach(btn => btn.classList.remove('attiva'));
            document.getElementById(`tipo-${tipo}`).classList.add('attiva');
            domandeDisponibili = [...domande[tipo]];
            indiceDomandaCorrente = 0;
            domandeConsecutiveStessaSezione = 0;
            haMostratoSuggerimentoCambioSezione = false;
            if (giocoIniziato && !gameOver) {
                creaNuovaDomanda();
            }
        }

        function mostraGameOver() {
            pausaTimer();
            gameOver = true;
            let messaggioFinale = "‚è±Ô∏è TEMPO SCADUTO!\n\nPunteggio finale: " + punteggio + "\nDomande corrette consecutive: " + operazioniCorretteConsecutive + "\n\n";
            if (punteggio >= 100) messaggioFinale += "üéâ ECCELLENTE! Sei un esperto di tabelle e grafici! üéâ";
            else if (punteggio >= 50) messaggioFinale += "üëç BUON LAVORO! Continua a esercitarti!";
            else messaggioFinale += "üí™ NON ARRENDERTI! Riprova e migliorerai!";
            mostraMessaggio(messaggioFinale, "messaggio-game-over");
            document.getElementById('bottone-nuova').style.display = 'block';
        }

        function inizializzaTastieraNumerica(casellaInput) {
            const tastieraNumerica = document.getElementById('tastiera-numerica');
            tastieraNumerica.innerHTML = '';
            for (let i = 1; i <= 9; i++) {
                const tasto = document.createElement('button');
                tasto.className = 'tasto-numero';
                tasto.textContent = i;
                tasto.addEventListener('click', () => { playClickSound(); casellaInput.value += i; rispostaAperta = casellaInput.value; });
                tastieraNumerica.appendChild(tasto);
            }
            const tasto0 = document.createElement('button');
            tasto0.className = 'tasto-numero';
            tasto0.textContent = '0';
            tasto0.addEventListener('click', () => { playClickSound(); casellaInput.value += '0'; rispostaAperta = casellaInput.value; });
            tastieraNumerica.appendChild(tasto0);
            const tastoCancella = document.createElement('button');
            tastoCancella.className = 'tasto-numero tasto-cancella';
            tastoCancella.textContent = '‚Üê';
            tastoCancella.addEventListener('click', () => { playClickSound(); casellaInput.value = casellaInput.value.slice(0, -1); rispostaAperta = casellaInput.value; });
            tastieraNumerica.appendChild(tastoCancella);
        }

        function creaNuovaDomanda() {
            verificaEseguita = false;
            haSbagliatoQuestaDomanda = false;
            aiutiUtilizzatiDomandaCorrente = 0;
            opzioniSelezionate = [];
            rispostaAperta = "";

            if (domandeDisponibili.length === 0) {
                domandeDisponibili = [...domande[tipoGioco]];
                domandeDisponibili = mescolaArray(domandeDisponibili);
                indiceDomandaCorrente = 0;
            }
            domandaCorrente = domandeDisponibili[indiceDomandaCorrente];
            indiceDomandaCorrente = (indiceDomandaCorrente + 1) % domandeDisponibili.length;
            domandeConsecutiveStessaSezione++;
            aggiornaContatori();
            document.getElementById('tastiera-container').style.display = 'none';
            document.getElementById('bottone-prossima').style.display = 'none';
            document.getElementById('bottone-verifica').style.display = 'block';
            document.getElementById('bottone-aiuto').style.display = 'block';

            const areaDomanda = document.getElementById('area-domanda');
            areaDomanda.innerHTML = '';

            const testoDomanda = document.createElement('div');
            testoDomanda.className = 'testo-domanda';
            testoDomanda.textContent = domandaCorrente.domanda;
            areaDomanda.appendChild(testoDomanda);

            if (domandaCorrente.tabella) {
                const tabellaContainer = document.createElement('div');
                tabellaContainer.className = 'tabella-container';
                const tabella = document.createElement('table');
                tabella.className = 'tabella-visuale';
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                domandaCorrente.tabella.intestazioni.forEach(intestazione => {
                    const th = document.createElement('th');
                    th.textContent = intestazione;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                tabella.appendChild(thead);
                const tbody = document.createElement('tbody');
                domandaCorrente.tabella.righe.forEach(riga => {
                    const tr = document.createElement('tr');
                    riga.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                tabella.appendChild(tbody);
                tabellaContainer.appendChild(tabella);
                areaDomanda.appendChild(tabellaContainer);
            }

            if (domandaCorrente.grafico) {
                const graficoContainer = document.createElement('div');
                graficoContainer.className = 'grafico-container';
                const graficoVisuale = document.createElement('div');
                graficoVisuale.className = 'grafico-visuale';

                if (domandaCorrente.grafico.tipo === 'barre') {
                    const graficoBarre = document.createElement('div');
                    graficoBarre.className = 'grafico-barre';
                    const valori = domandaCorrente.grafico.dati.map(d => d.valore);
                    const maxValore = Math.max(...valori);
                    domandaCorrente.grafico.dati.forEach(dato => {
                        const barra = document.createElement('div');
                        barra.className = 'barra';
                        barra.style.height = `${(dato.valore / maxValore) * 140}px`;
                        const valoreBarra = document.createElement('div');
                        valoreBarra.className = 'valore-barra';
                        valoreBarra.textContent = dato.valore;
                        barra.appendChild(valoreBarra);
                        const etichettaBarra = document.createElement('div');
                        etichettaBarra.className = 'etichetta-barra';
                        etichettaBarra.textContent = dato.etichetta;
                        barra.appendChild(etichettaBarra);
                        graficoBarre.appendChild(barra);
                    });
                    graficoVisuale.appendChild(graficoBarre);
                    graficoContainer.appendChild(graficoVisuale);
                    areaDomanda.appendChild(graficoContainer);
                } else if (domandaCorrente.grafico.tipo === 'torta') {
                    const graficoTorta = document.createElement('div');
                    graficoTorta.className = 'grafico-torta';
                    const total = domandaCorrente.grafico.dati.reduce((sum, d) => sum + d.valore, 0);
                    let accumulato = 0;
                    let gradienti = [];
                    domandaCorrente.grafico.dati.forEach((dato, index) => {
                        const percentuale = (dato.valore / total) * 100;
                        const inizio = accumulato;
                        const fine = accumulato + percentuale;
                        gradienti.push(`${dato.colore || '#ff6b6b'} ${inizio}% ${fine}%`);
                        accumulato = fine;
                    });
                    graficoTorta.style.background = `conic-gradient(${gradienti.join(', ')})`;
                    graficoVisuale.appendChild(graficoTorta);
                    const legenda = document.createElement('div');
                    legenda.className = 'legenda-grafico';
                    domandaCorrente.grafico.dati.forEach(dato => {
                        const elementoLegenda = document.createElement('div');
                        elementoLegenda.className = 'elemento-legenda';
                        const coloreLegenda = document.createElement('div');
                        coloreLegenda.className = 'colore-legenda';
                        coloreLegenda.style.backgroundColor = dato.colore || '#ff6b6b';
                        const testoLegenda = document.createElement('span');
                        testoLegenda.textContent = `${dato.etichetta}: ${dato.valore}%`;
                        elementoLegenda.appendChild(coloreLegenda);
                        elementoLegenda.appendChild(testoLegenda);
                        legenda.appendChild(elementoLegenda);
                    });
                    graficoVisuale.appendChild(legenda);
                    graficoContainer.appendChild(graficoVisuale);
                    areaDomanda.appendChild(graficoContainer);
                } else if (domandaCorrente.grafico.tipo === 'linee') {
                    const graficoLinee = document.createElement('div');
                    graficoLinee.className = 'grafico-linee';

                    const valori = domandaCorrente.grafico.dati.map(d => d.valore);
                    const maxValore = Math.max(...valori);
                    const minValore = Math.min(...valori);
                    const range = maxValore - minValore;

                    const canvas = document.createElement('canvas');
                    canvas.className = 'linea-canvas';
                    graficoLinee.appendChild(canvas);

                    const punti = [];
                    domandaCorrente.grafico.dati.forEach((dato, index) => {
                        const punto = document.createElement('div');
                        punto.className = 'punto-linea';
                        graficoLinee.appendChild(punto);
                        const etichetta = document.createElement('div');
                        etichetta.className = 'etichetta-linea';
                        etichetta.textContent = dato.etichetta;
                        graficoLinee.appendChild(etichetta);
                        const valore = document.createElement('div');
                        valore.className = 'valore-linea';
                        valore.textContent = dato.valore;
                        graficoLinee.appendChild(valore);
                        punti.push({ punto, etichetta, valore, indice: index, valoreNum: dato.valore });
                    });

                    graficoVisuale.appendChild(graficoLinee);
                    graficoContainer.appendChild(graficoVisuale);
                    areaDomanda.appendChild(graficoContainer);

                    function disegnaLinea() {
                        const rect = graficoLinee.getBoundingClientRect();
                        if (rect.width === 0 || rect.height === 0) {
                            requestAnimationFrame(disegnaLinea);
                            return;
                        }
                        canvas.width = rect.width;
                        canvas.height = rect.height;

                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);

                        const n = domandaCorrente.grafico.dati.length;
                        if (n < 2) return;

                        const marginLeft = 30;
                        const marginRight = 30;
                        const marginTop = 20;
                        const marginBottom = 25;

                        const graphWidth = canvas.width - marginLeft - marginRight;
                        const graphHeight = canvas.height - marginTop - marginBottom;

                        let yBase = marginTop + graphHeight / 2;

                        ctx.beginPath();
                        ctx.strokeStyle = '#ffa500';
                        ctx.lineWidth = 3;

                        for (let i = 0; i < n; i++) {
                            const dato = domandaCorrente.grafico.dati[i];
                            let x = marginLeft + (i / (n - 1)) * graphWidth;
                            let y;
                            if (range === 0) {
                                y = yBase;
                            } else {
                                y = marginTop + (1 - (dato.valore - minValore) / range) * graphHeight;
                            }
                            y = Math.min(Math.max(y, marginTop), canvas.height - marginBottom);

                            const puntoDiv = punti[i].punto;
                            puntoDiv.style.left = `${x - 6}px`;
                            puntoDiv.style.top = `${y - 6}px`;

                            const etichettaDiv = punti[i].etichetta;
                            etichettaDiv.style.left = `${x}px`;
                            etichettaDiv.style.bottom = `-35px`;

                            const valoreDiv = punti[i].valore;
                            valoreDiv.style.left = `${x}px`;
                            if (y < 25) {
                                valoreDiv.style.top = `${y + 15}px`;
                            } else {
                                valoreDiv.style.top = `${y - 15}px`;
                            }

                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.stroke();
                    }
                    requestAnimationFrame(disegnaLinea);
                    setTimeout(disegnaLinea, 50);
                }
            }

            if (domandaCorrente.tipo === 'scelta_multipla') {
                const opzioniContainer = document.createElement('div');
                opzioniContainer.className = 'opzioni-container';
                domandaCorrente.opzioni.forEach((opzione, index) => {
                    const opzioneBtn = document.createElement('button');
                    opzioneBtn.className = 'opzione-btn';
                    opzioneBtn.textContent = opzione;
                    opzioneBtn.dataset.index = index;
                    opzioneBtn.addEventListener('click', () => {
                        if (!verificaEseguita) {
                            playClickSound();
                            document.querySelectorAll('.opzione-btn').forEach(btn => btn.classList.remove('selezionata'));
                            opzioneBtn.classList.add('selezionata');
                            rispostaCorrente = index;
                        }
                    });
                    opzioniContainer.appendChild(opzioneBtn);
                });
                areaDomanda.appendChild(opzioniContainer);
            } else if (domandaCorrente.tipo === 'scelta_multipla_multi') {
                const infoMultiSelezione = document.createElement('div');
                infoMultiSelezione.className = 'multi-selezione-info';
                infoMultiSelezione.textContent = '‚ö†Ô∏è ATTENZIONE: Questa domanda ha pi√π risposte corrette! Clicca su tutte le opzioni che ritieni corrette.';
                areaDomanda.appendChild(infoMultiSelezione);
                const opzioniContainer = document.createElement('div');
                opzioniContainer.className = 'opzioni-container';
                domandaCorrente.opzioni.forEach((opzione, index) => {
                    const opzioneBtn = document.createElement('button');
                    opzioneBtn.className = 'opzione-btn';
                    opzioneBtn.textContent = opzione;
                    opzioneBtn.dataset.index = index;
                    opzioneBtn.addEventListener('click', () => {
                        if (!verificaEseguita) {
                            playClickSound();
                            if (opzioniSelezionate.includes(index)) {
                                opzioniSelezionate = opzioniSelezionate.filter(i => i !== index);
                                opzioneBtn.classList.remove('selezionata');
                            } else {
                                opzioniSelezionate.push(index);
                                opzioneBtn.classList.add('selezionata');
                            }
                        }
                    });
                    opzioniContainer.appendChild(opzioneBtn);
                });
                areaDomanda.appendChild(opzioniContainer);
            } else if (domandaCorrente.tipo === 'vero_falso') {
                const opzioniContainer = document.createElement('div');
                opzioniContainer.className = 'opzioni-container';
                const opzioniVF = [
                    { testo: "VERO", valore: true },
                    { testo: "FALSO", valore: false }
                ];
                opzioniVF.forEach(opzione => {
                    const opzioneBtn = document.createElement('button');
                    opzioneBtn.className = 'opzione-btn';
                    opzioneBtn.textContent = opzione.testo;
                    opzioneBtn.dataset.valore = opzione.valore;
                    opzioneBtn.addEventListener('click', () => {
                        if (!verificaEseguita) {
                            playClickSound();
                            document.querySelectorAll('.opzione-btn').forEach(btn => btn.classList.remove('selezionata'));
                            opzioneBtn.classList.add('selezionata');
                            rispostaCorrente = opzione.valore;
                        }
                    });
                    opzioniContainer.appendChild(opzioneBtn);
                });
                areaDomanda.appendChild(opzioniContainer);
            } else if (domandaCorrente.tipo === 'risposta_aperta') {
                const rispostaContainer = document.createElement('div');
                rispostaContainer.className = 'risposta-aperta-container';
                const inputContainer = document.createElement('div');
                inputContainer.className = 'risposta-input-container';
                const casellaRisposta = document.createElement('input');
                casellaRisposta.className = 'casella-risposta';
                casellaRisposta.type = 'text';
                casellaRisposta.maxLength = 10;
                casellaRisposta.addEventListener('input', (e) => { rispostaAperta = e.target.value; });
                casellaRisposta.addEventListener('focus', () => { document.getElementById('tastiera-container').style.display = 'block'; });
                inputContainer.appendChild(casellaRisposta);
                rispostaContainer.appendChild(inputContainer);
                areaDomanda.appendChild(rispostaContainer);
                inizializzaTastieraNumerica(casellaRisposta);
            }

            if (!haMostratoSuggerimentoCambioSezione && domandeConsecutiveStessaSezione >= LIMITE_DOMANDE_PRIMA_SUGGERIMENTO && giocoIniziato) {
                mostraMessaggio(`üß† Suggerimento: Hai fatto ${domandeConsecutiveStessaSezione} domande sulla stessa sezione. Prova a cambiare tipo di domanda per esercitarti su tutti gli argomenti!`, "messaggio-suggerimento");
                haMostratoSuggerimentoCambioSezione = true;
            }
        }

        function verificaRisposta() {
            if (verificaEseguita) { creaNuovaDomanda(); return; }
            verificaEseguita = true;
            let rispostaCorretta = false;
            let messaggio = "";
            let classeMessaggio = "messaggio-info";
            document.getElementById('tastiera-container').style.display = 'none';

            if (domandaCorrente.tipo === 'scelta_multipla') {
                if (rispostaCorrente === domandaCorrente.risposta) {
                    rispostaCorretta = true;
                    messaggio = `‚úÖ CORRETTO! ${domandaCorrente.spiegazione}`;
                    classeMessaggio = "messaggio-corretto";
                    playSuccessSound();
                } else {
                    messaggio = `‚ùå SBAGLIATO. La risposta corretta era: "${domandaCorrente.opzioni[domandaCorrente.risposta]}". ${domandaCorrente.spiegazione}`;
                    classeMessaggio = "messaggio-errato";
                    haSbagliatoQuestaDomanda = true;
                }
                document.querySelectorAll('.opzione-btn').forEach((btn, index) => {
                    if (index === domandaCorrente.risposta) btn.classList.add('selezionata');
                    else if (index === rispostaCorrente && !rispostaCorretta) btn.classList.add('errata');
                });
            } else if (domandaCorrente.tipo === 'scelta_multipla_multi') {
                const risposteSelezionateOrdinate = [...opzioniSelezionate].sort();
                const risposteCorretteOrdinate = [...domandaCorrente.risposte].sort();
                const sonoUguali = risposteSelezionateOrdinate.length === risposteCorretteOrdinate.length &&
                                   risposteSelezionateOrdinate.every((val, idx) => val === risposteCorretteOrdinate[idx]);
                if (sonoUguali) {
                    rispostaCorretta = true;
                    messaggio = `‚úÖ TUTTE CORRETTE! ${domandaCorrente.spiegazione}`;
                    classeMessaggio = "messaggio-corretto";
                    playSuccessSound();
                } else {
                    const risposteGiuste = risposteSelezionateOrdinate.filter(val => risposteCorretteOrdinate.includes(val)).length;
                    if (risposteGiuste > 0) {
                        messaggio = `‚ö†Ô∏è PARZIALMENTE CORRETTO. Hai individuato ${risposteGiuste} risposta/e corretta/e su ${risposteCorretteOrdinate.length}. ${domandaCorrente.spiegazione}`;
                        classeMessaggio = "messaggio-parziale";
                    } else {
                        messaggio = `‚ùå SBAGLIATO. ${domandaCorrente.spiegazione}`;
                        classeMessaggio = "messaggio-errato";
                    }
                    haSbagliatoQuestaDomanda = true;
                }
                document.querySelectorAll('.opzione-btn').forEach((btn, index) => {
                    const isSelezionata = opzioniSelezionate.includes(index);
                    const isCorretta = domandaCorrente.risposte.includes(index);
                    if (isCorretta) btn.classList.add('selezionata');
                    else if (isSelezionata && !isCorretta) btn.classList.add('errata');
                });
            } else if (domandaCorrente.tipo === 'vero_falso') {
                if (rispostaCorrente === domandaCorrente.risposta) {
                    rispostaCorretta = true;
                    messaggio = `‚úÖ CORRETTO! ${domandaCorrente.spiegazione}`;
                    classeMessaggio = "messaggio-corretto";
                    playSuccessSound();
                } else {
                    messaggio = `‚ùå SBAGLIATO. La risposta corretta era: ${domandaCorrente.risposta ? "VERO" : "FALSO"}. ${domandaCorrente.spiegazione}`;
                    classeMessaggio = "messaggio-errato";
                    haSbagliatoQuestaDomanda = true;
                }
                document.querySelectorAll('.opzione-btn').forEach(btn => {
                    if ((btn.dataset.valore === "true" && domandaCorrente.risposta) ||
                        (btn.dataset.valore === "false" && !domandaCorrente.risposta)) {
                        btn.classList.add('selezionata');
                    } else if (btn.classList.contains('selezionata') && !rispostaCorretta) {
                        btn.classList.add('errata');
                    }
                });
            } else if (domandaCorrente.tipo === 'risposta_aperta') {
                const rispostaUtente = rispostaAperta.trim();
                const rispostaCorrettaDomanda = domandaCorrente.risposta.toString().trim();
                if (rispostaUtente === rispostaCorrettaDomanda) {
                    rispostaCorretta = true;
                    messaggio = `‚úÖ CORRETTO! ${domandaCorrente.spiegazione}`;
                    classeMessaggio = "messaggio-corretto";
                    playSuccessSound();
                    document.querySelector('.casella-risposta').classList.add('corretta');
                } else {
                    messaggio = `‚ùå SBAGLIATO. La risposta corretta era: ${domandaCorrente.risposta}. ${domandaCorrente.spiegazione}`;
                    classeMessaggio = "messaggio-errato";
                    haSbagliatoQuestaDomanda = true;
                    const casella = document.querySelector('.casella-risposta');
                    casella.classList.add('errata');
                    setTimeout(() => { casella.value = domandaCorrente.risposta; }, 500);
                }
            }

            if (rispostaCorretta) {
                operazioniCorretteConsecutive++;
                erroriConsecutivi = 0;
                let puntiGuadagnati = 2;
                if (domandaCorrente.tipo === 'scelta_multipla_multi' && rispostaCorretta) puntiGuadagnati = 3;
                puntiGuadagnati = Math.max(0, puntiGuadagnati - (aiutiUtilizzatiDomandaCorrente * 2));
                punteggio += puntiGuadagnati;
                if (operazioniCorretteConsecutive % 5 === 0 && vite < 3) {
                    vite++;
                    aggiornaVite();
                    mostraMessaggio(`‚ú® BONUS VITA! Hai raggiunto ${operazioniCorretteConsecutive} risposte corrette consecutive!`, "messaggio-wow");
                }
                if (puntiGuadagnati > 0) {
                    if (puntiGuadagnati === 3) { messaggio = `üéâ PERFETTO! +3 punti! ${domandaCorrente.spiegazione}`; classeMessaggio = "messaggio-wow"; }
                    else if (puntiGuadagnati === 2) { messaggio = `‚úÖ BRAVO! +2 punti! ${domandaCorrente.spiegazione}`; classeMessaggio = "messaggio-corretto"; }
                    else if (puntiGuadagnati === 1) { messaggio = `üëç OK! +1 punto! ${domandaCorrente.spiegazione}`; classeMessaggio = "messaggio-corretto"; }
                    else { messaggio = `üòê Risposta corretta, ma hai usato troppi aiuti! ${domandaCorrente.spiegazione}`; classeMessaggio = "messaggio-info"; }
                }
            } else {
                operazioniCorretteConsecutive = 0;
                erroriConsecutivi++;
                if (erroriConsecutivi >= 3 && vite > 0) {
                    vite--;
                    erroriConsecutivi = 0;
                    aggiornaVite();
                    if (vite === 0) { mostraMessaggio("üíÄ GAME OVER! Hai perso tutte le vite!", "messaggio-ahi"); gameOver = true; pausaTimer(); }
                    else { mostraMessaggio(`üíî Hai perso una vita! Ti rimangono ${vite} vite.`, "messaggio-ahi"); }
                }
                if (haSbagliatoQuestaDomanda) classeMessaggio = "messaggio-ahi";
            }

            aggiornaDisplayPunteggio();
            aggiornaErroriIndicatore();
            aggiornaContatori();
            mostraMessaggio(messaggio, classeMessaggio);
            document.getElementById('bottone-prossima').style.display = 'block';
            document.getElementById('bottone-verifica').style.display = 'none';
            document.getElementById('bottone-aiuto').style.display = 'none';
        }

        function daiAiuto() {
            if (verificaEseguita || gameOver) return;
            playClickSound();
            aiutiUtilizzatiDomandaCorrente++;
            aggiornaContatori();
            let suggerimento = "";
            if (domandaCorrente.tipo === 'scelta_multipla') {
                const opzioniSbagliate = [0, 1, 2, 3].filter(i => i !== domandaCorrente.risposta);
                const opzioniDaEliminare = mescolaArray(opzioniSbagliate).slice(0, 2);
                opzioniDaEliminare.forEach(index => {
                    const btn = document.querySelector(`.opzione-btn[data-index="${index}"]`);
                    if (btn && !btn.classList.contains('selezionata')) {
                        btn.style.opacity = '0.3';
                        btn.style.pointerEvents = 'none';
                    }
                });
                suggerimento = "Ho eliminato 2 risposte sbagliate!";
            } else if (domandaCorrente.tipo === 'scelta_multipla_multi') {
                const risposteNonSelezionate = domandaCorrente.risposte.filter(r => !opzioniSelezionate.includes(r));
                if (risposteNonSelezionate.length > 0) {
                    const rivelare = risposteNonSelezionate[0];
                    const btn = document.querySelector(`.opzione-btn[data-index="${rivelare}"]`);
                    if (btn) { btn.classList.add('selezionata'); opzioniSelezionate.push(rivelare); }
                    suggerimento = "Ho selezionato una risposta corretta per te!";
                } else suggerimento = "Hai gi√† selezionato tutte le risposte corrette!";
            } else if (domandaCorrente.tipo === 'vero_falso') {
                suggerimento = `La risposta corretta √®: ${domandaCorrente.risposta ? "VERO" : "FALSO"}`;
            } else if (domandaCorrente.tipo === 'risposta_aperta') {
                const rispostaNum = parseInt(domandaCorrente.risposta);
                if (!isNaN(rispostaNum)) {
                    const range = Math.max(1, Math.floor(rispostaNum * 0.2));
                    const min = Math.max(0, rispostaNum - range);
                    const max = rispostaNum + range;
                    suggerimento = `Il numero √® compreso tra ${min} e ${max}`;
                } else {
                    suggerimento = `La risposta contiene: "${domandaCorrente.risposta.substring(0, 3)}..."`;
                }
            }
            mostraMessaggio(`üß† AIUTO UTILIZZATO (-2 punti): ${suggerimento}`, "messaggio-info");
        }

        // ==================== FUNZIONE PER ESCI ====================
        function esciDalGioco() {
            if (confirm("Vuoi davvero uscire dal gioco?")) {
                window.location.href = "https://oragioca.github.io/matematica/";
            }
        }

        // ==================== INIZIALIZZAZIONE ====================
        document.addEventListener('DOMContentLoaded', function() {
            inizializzaAudio();
            aggiornaVite();
            aggiornaDisplayTempo();
            aggiornaDisplayPunteggio();
            aggiornaErroriIndicatore();

            const messaggioAvvio = document.getElementById('messaggio-avvio');
            messaggioAvvio.addEventListener('click', iniziaGioco);

            document.getElementById('tipo-tabelle').addEventListener('click', () => cambiaTipoDomanda('tabelle'));
            document.getElementById('tipo-grafici').addEventListener('click', () => cambiaTipoDomanda('grafici'));
            document.getElementById('tipo-conversione').addEventListener('click', () => cambiaTipoDomanda('conversione'));
            document.getElementById('tipo-interpretazione').addEventListener('click', () => cambiaTipoDomanda('interpretazione'));

            document.getElementById('bottone-verifica').addEventListener('click', verificaRisposta);
            document.getElementById('bottone-aiuto').addEventListener('click', daiAiuto);
            document.getElementById('bottone-prossima').addEventListener('click', () => {
                if (gameOver) {
                    giocoIniziato = false;
                    document.getElementById('messaggio-avvio').style.display = 'flex';
                    document.getElementById('controlli-gioco').style.display = 'none';
                    document.getElementById('area-domanda').style.display = 'none';
                    nascondiMessaggio();
                } else {
                    creaNuovaDomanda();
                    nascondiMessaggio();
                }
            });

            document.getElementById('bottone-nuova').addEventListener('click', () => {
                giocoIniziato = false;
                gameOver = false;
                pausaTimer();
                document.getElementById('messaggio-avvio').style.display = 'flex';
                document.getElementById('controlli-gioco').style.display = 'none';
                document.getElementById('area-domanda').style.display = 'none';
                nascondiMessaggio();
                domande = {
                    tabelle: mescolaArray([...tutteLeDomande.tabelle]),
                    grafici: mescolaArray([...tutteLeDomande.grafici]),
                    conversione: mescolaArray([...tutteLeDomande.conversione]),
                    interpretazione: mescolaArray([...tutteLeDomande.interpretazione])
                };
                domandeDisponibili = [...domande.tabelle];
                indiceDomandaCorrente = 0;
            });

            const istruzioniBtn = document.getElementById('istruzioni-btn');
            const modalOverlay = document.getElementById('modal-overlay');
            const closeModal = document.getElementById('close-modal');
            istruzioniBtn.addEventListener('click', () => { modalOverlay.style.display = 'flex'; playClickSound(); });
            closeModal.addEventListener('click', () => { modalOverlay.style.display = 'none'; playClickSound(); });
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) modalOverlay.style.display = 'none'; });

            // NUOVO: evento per il pulsante Esci
            document.getElementById('esciBtn').addEventListener('click', esciDalGioco);

            timeoutBenvenuto = setTimeout(() => {
                if (!giocoIniziato) messaggioAvvio.style.animation = 'pulse 1s infinite';
            }, 10000);

            console.log("Tabelle e Grafici inizializzato!");
        });
    </script>
</body>

</html>
