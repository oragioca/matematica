<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impara la Virgola nelle Divisioni</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 1.2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 8px;
            font-size: 0.8em;
            font-style: italic;
        }

        .mode-indicator {
            text-align: center;
            padding: 5px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.8em;
        }

        .mode-guided {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .mode-autonomous {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .score-board {
            display: flex;
            justify-content: space-around;
            margin-bottom: 6px;
            padding: 5px;
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            border-radius: 12px;
            color: white;
        }

        .score-item {
            text-align: center;
            flex: 1;
        }

        .score-label {
            font-size: 0.65em;
            opacity: 0.9;
        }

        .score-value {
            font-size: 1.1em;
            font-weight: bold;
        }

        /* Stile per il pulsante Esci */
        .btn-exit {
            background: none;
            border: none;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            width: 100%;
            padding: 2px;
            border-radius: 5px;
            transition: background 0.2s;
        }
        .btn-exit:hover {
            background: rgba(255,255,255,0.2);
        }
        .exit-icon {
            font-size: 1.2em;
        }

        .lesson-box {
            background: #fff3cd;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #ffc107;
        }

        .lesson-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 5px;
            font-size: 0.85em;
        }

        .lesson-content {
            color: #856404;
            font-size: 0.75em;
            line-height: 1.4;
        }

        .lesson-content strong {
            color: #d63384;
        }

        .example {
            background: white;
            padding: 6px;
            margin-top: 5px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            text-align: center;
            font-size: 0.9em;
        }

        .exercise-area {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .exercise-title {
            text-align: center;
            font-size: 1.1em;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .division-steps {
            background: #f0f4ff;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 2px solid #667eea;
        }

        .steps-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }

        .steps-content {
            font-family: 'Courier New', monospace;
            font-size: 1em;
            line-height: 1.8;
            color: #333;
        }

        .step-line {
            margin: 5px 0;
        }

        .step-line .highlight-integer {
            background: #e3f2fd;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
            color: #2196F3;
        }

        .step-line .highlight-comma {
            background: #ffcdd2;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
            color: #f5576c;
            font-size: 1.2em;
        }

        .step-line .highlight-decimal {
            background: #e8f5e9;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
            color: #4CAF50;
        }

        .division-display {
            font-family: 'Courier New', monospace;
            font-size: 1.5em;
            text-align: center;
            margin: 12px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .quotient-builder {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-height: 60px;
            position: relative;
        }

        .section-label {
            position: absolute;
            top: -25px;
            font-size: 0.75em;
            font-weight: bold;
            color: #666;
            background: white;
            padding: 2px 8px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .label-integer {
            color: #2196F3;
            left: 0;
        }

        .label-decimal {
            color: #4CAF50;
            right: 0;
        }

        .digit-slot {
            width: 38px;
            height: 45px;
            border: 3px dashed #667eea;
            border-radius: 8px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .digit-slot.integer {
            border-color: #2196F3;
            background: #e3f2fd;
        }

        .digit-slot.decimal {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .digit-slot.filled {
            border-style: solid;
        }

        .digit-slot.comma {
            width: 30px;
            border-color: #f5576c;
            border-width: 4px;
            background: #ffe5ea;
        }

        .digit-slot.comma.filled {
            background: #ffcdd2;
            border-color: #f5576c;
        }

        .digit-slot.neutral {
            border-color: #9e9e9e;
            background: #f5f5f5;
        }

        .digit-slot.drag-over {
            background: #e3f2fd;
            transform: scale(1.1);
        }

        .digit-slot.correct {
            background: #d4edda;
            border-color: #28a745;
            animation: success 0.5s;
        }

        .digit-slot.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            animation: shake 0.3s;
        }

        @keyframes success {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .tiles-panel {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 10px;
            margin-top: 12px;
        }

        .tiles-title {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .tiles-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tile {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            cursor: move;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }

        .tile.comma {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            font-size: 2em;
        }

        .tile:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .tile.dragging {
            opacity: 0.5;
        }

        .tile.used {
            display: none;
        }

        .hint-box {
            background: #d1ecf1;
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #0c5460;
            display: none;
        }

        .hint-box.show {
            display: block;
        }

        .hint-text {
            color: #0c5460;
            font-size: 0.9em;
        }

        .button-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }

        button {
            padding: 8px 15px;
            font-size: 0.85em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-check {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-hint {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .btn-next {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-reset {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            text-align: center;
            padding: 6px;
            margin-top: 8px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            min-height: 35px;
        }

        .message.show {
            opacity: 1;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 10px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            transition: width 0.5s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Impara la Virgola nelle Divisioni üéØ</h1>
        <div class="subtitle">Prima impara, poi mettiti alla prova!</div>

        <div class="mode-indicator" id="modeIndicator"></div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>

        <div class="score-board">
            <div class="score-item">
                <div class="score-label">Corrette</div>
                <div class="score-value" id="correct">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">Fase</div>
                <div class="score-value" id="phase">Guidata</div>
            </div>
            <div class="score-item">
                <div class="score-label">Esercizio</div>
                <div class="score-value"><span id="current">1</span>/<span id="total">10</span></div>
            </div>
            <!-- NUOVO PULSANTE ESCI -->
            <div class="score-item">
                <button class="btn-exit" id="esciBtn">
                    <span class="exit-icon">üö™</span>
                    <span>Esci</span>
                </button>
            </div>
        </div>

        <div class="lesson-box">
            <div class="lesson-title">üìö Regola della Virgola:</div>
            <div class="lesson-content">
                Quando fai una divisione con i decimali, la <strong>virgola nel quoziente</strong> va messa quando:
                <br>‚Ä¢ Hai finito le cifre del dividendo (parti intere)
                <br>‚Ä¢ Devi "abbassare lo 0" per continuare
                <br>‚Ä¢ Il resto non √® zero e vuoi continuare la divisione
                <div class="example">
                    Esempio: 25 √∑ 2 = 12<strong style="color: #f5576c;">,</strong>5
                    <br><span style="font-size: 0.8em;">‚Üë La virgola va dopo le cifre intere</span>
                </div>
            </div>
        </div>

        <div class="exercise-area">
            <div class="exercise-title" id="exerciseTitle">Esercizio 1</div>
            
            <div id="divisionStepsContainer"></div>

            <div class="division-display">
                <span id="dividend">245</span>
                <span>√∑</span>
                <span id="divisor">2</span>
                <span>=</span>
            </div>

            <div class="quotient-builder" id="quotientBuilder">
                <!-- Slots generati dinamicamente -->
            </div>

            <div class="tiles-panel">
                <div class="tiles-title" id="tilesTitle">üé≤ Trascina qua sopra:</div>
                <div class="tiles-container" id="tilesContainer">
                    <!-- Tiles generati dinamicamente -->
                </div>
            </div>

            <div class="hint-box" id="hintBox">
                <div class="hint-text" id="hintText"></div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-check" id="checkBtn">Controlla</button>
            <button class="btn-hint" id="hintBtn">Aiuto</button>
            <button class="btn-reset" id="resetBtn">Ricomincia</button>
            <button class="btn-next" id="nextBtn" disabled>Prossimo ‚ûú</button>
        </div>

        <div class="message" id="message"></div>
    </div>

    <script>
        let currentExercise = 0;
        let correctCount = 0;
        let draggedTile = null;

        // Primi 5 esercizi: GUIDATI (con colori e etichette)
        // Ultimi 5 esercizi: AUTONOMI (senza aiuti visivi)
        const exercises = [
            // FASE GUIDATA - Esercizi 1-5
            { dividend: 25, divisor: 2, quotient: "12,5", hint: "25 √∑ 2: fai 25√∑2=12 resto 1. Metti virgola e abbassa 0: 10√∑2=5", guided: true },
            { dividend: 45, divisor: 2, quotient: "22,5", hint: "45 √∑ 2: fai 45√∑2=22 resto 1. Metti virgola e abbassa 0: 10√∑2=5", guided: true },
            { dividend: 15, divisor: 4, quotient: "3,75", hint: "15 √∑ 4: fai 15√∑4=3 resto 3. Virgola! 30√∑4=7 resto 2, poi 20√∑4=5", guided: true },
            { dividend: 125, divisor: 5, quotient: "25,0", hint: "125 √∑ 5: fai 125√∑5=25 resto 0. Virgola e zero!", guided: true },
            { dividend: 175, divisor: 5, quotient: "35,0", hint: "175 √∑ 5: fai 175√∑5=35 resto 0. Virgola e zero!", guided: true },
            
            // FASE AUTONOMA - Esercizi 6-10 (SENZA colori e etichette)
            { dividend: 65, divisor: 4, quotient: "16,25", hint: "65 √∑ 4: fai 65√∑4=16 resto 1. Virgola! 10√∑4=2 resto 2, poi 20√∑4=5", guided: false },
            { dividend: 225, divisor: 4, quotient: "56,25", hint: "225 √∑ 4: fai 225√∑4=56 resto 1. Virgola! 10√∑4=2 resto 2, poi 20√∑4=5", guided: false },
            { dividend: 145, divisor: 4, quotient: "36,25", hint: "145 √∑ 4: fai 145√∑4=36 resto 1. Virgola! 10√∑4=2 resto 2, poi 20√∑4=5", guided: false },
            { dividend: 157, divisor: 4, quotient: "39,25", hint: "157 √∑ 4: fai 157√∑4=39 resto 1. Virgola! 10√∑4=2 resto 2, poi 20√∑4=5", guided: false },
            { dividend: 365, divisor: 8, quotient: "45,625", hint: "365 √∑ 8: fai 365√∑8=45 resto 5. Virgola! 50√∑8=6 resto 2, 20√∑8=2 resto 4, 40√∑8=5", guided: false }
        ];

        function startExercise() {
            const ex = exercises[currentExercise];
            const isGuided = ex.guided;
            
            // Aggiorna indicatore modalit√†
            const modeIndicator = document.getElementById('modeIndicator');
            const phaseDisplay = document.getElementById('phase');
            
            if (isGuided) {
                modeIndicator.className = 'mode-indicator mode-guided';
                modeIndicator.innerHTML = 'üë®‚Äçüè´ FASE GUIDATA: Ti aiuto con i colori!';
                phaseDisplay.textContent = 'Guidata';
            } else {
                modeIndicator.className = 'mode-indicator mode-autonomous';
                modeIndicator.innerHTML = 'üéØ FASE AUTONOMA: Decidi tu dove va la virgola!';
                phaseDisplay.textContent = 'Autonoma';
            }
            
            document.getElementById('exerciseTitle').textContent = `Esercizio ${currentExercise + 1} di ${exercises.length}`;
            document.getElementById('dividend').textContent = ex.dividend;
            document.getElementById('divisor').textContent = ex.divisor;
            document.getElementById('current').textContent = currentExercise + 1;
            document.getElementById('total').textContent = exercises.length;
            document.getElementById('correct').textContent = correctCount;
            
            updateProgressBar();
            
            // Mostra passaggi solo in fase guidata
            const stepsContainer = document.getElementById('divisionStepsContainer');
            if (isGuided) {
                stepsContainer.innerHTML = showDivisionSteps(ex.dividend, ex.divisor, ex.quotient);
            } else {
                stepsContainer.innerHTML = '<div class="division-steps"><div class="steps-title">ü§î Ora tocca a te! Dove va la virgola?</div></div>';
            }
            
            // Aggiorna testo pannello tessere
            const tilesTitle = document.getElementById('tilesTitle');
            if (isGuided) {
                tilesTitle.textContent = 'üé≤ Trascina qua sopra:';
            } else {
                tilesTitle.textContent = 'üîÄ Trascina in ordine (mischiate):';
            }
            
            // Crea slots per il quoziente
            createQuotientSlots(ex.quotient, isGuided);
            
            // Crea tiles
            createTiles(ex.quotient);
            
            // Nascondi hint e pulsante next
            document.getElementById('hintBox').classList.remove('show');
            document.getElementById('nextBtn').disabled = true;
            
            showMessage('');
        }

        function showDivisionSteps(dividend, divisor, quotient) {
            const parts = quotient.split(',');
            const integerPart = parts[0];
            const decimalPart = parts[1] || '';
            
            let html = '<div class="division-steps">';
            html += '<div class="steps-title">üìñ Guarda i passaggi:</div>';
            html += '<div class="steps-content">';
            
            html += `<div class="step-line">1. ${dividend} √∑ ${divisor} = <span class="highlight-integer">${integerPart}</span> (cifre intere)</div>`;
            
            if (decimalPart) {
                html += `<div class="step-line">2. C'√® un resto ‚Üí metti la <span class="highlight-comma">virgola ,</span></div>`;
                html += `<div class="step-line">3. Abbassa lo 0 e continua ‚Üí <span class="highlight-decimal">${decimalPart}</span> (cifre decimali)</div>`;
                html += `<div class="step-line"><strong>Risultato:</strong> <span class="highlight-integer">${integerPart}</span><span class="highlight-comma">,</span><span class="highlight-decimal">${decimalPart}</span></div>`;
            }
            
            html += '</div></div>';
            
            return html;
        }

        function createQuotientSlots(quotient, isGuided) {
            const builder = document.getElementById('quotientBuilder');
            builder.innerHTML = '';
            
            const commaIndex = quotient.indexOf(',');
            
            if (isGuided) {
                // FASE GUIDATA: con etichette e colori
                const labelInteger = document.createElement('div');
                labelInteger.className = 'section-label label-integer';
                labelInteger.textContent = 'üîµ Cifre INTERE';
                builder.appendChild(labelInteger);
                
                if (commaIndex !== -1) {
                    const labelDecimal = document.createElement('div');
                    labelDecimal.className = 'section-label label-decimal';
                    labelDecimal.textContent = 'üü¢ Cifre DECIMALI';
                    builder.appendChild(labelDecimal);
                }
            }
            
            for (let i = 0; i < quotient.length; i++) {
                const char = quotient[i];
                const slot = document.createElement('div');
                
                if (isGuided) {
                    // GUIDATA: colori diversi e dimensioni diverse
                    if (char === ',') {
                        slot.className = 'digit-slot comma';
                    } else if (i < commaIndex || commaIndex === -1) {
                        slot.className = 'digit-slot integer';
                    } else {
                        slot.className = 'digit-slot decimal';
                    }
                } else {
                    // AUTONOMA: TUTTE le caselle identiche (anche la virgola!)
                    slot.className = 'digit-slot neutral';
                }
                
                slot.dataset.expected = char;
                
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('dragenter', handleDragEnter);
                slot.addEventListener('dragleave', handleDragLeave);
                slot.addEventListener('drop', handleDrop);
                
                builder.appendChild(slot);
            }
        }

        function createTiles(quotient) {
            const container = document.getElementById('tilesContainer');
            container.innerHTML = '';
            
            const chars = quotient.split('');
            
            // Nella fase AUTONOMA, mescola le tessere in ordine casuale
            const ex = exercises[currentExercise];
            if (!ex.guided) {
                // Algoritmo Fisher-Yates per mescolare l'array
                for (let i = chars.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [chars[i], chars[j]] = [chars[j], chars[i]];
                }
            }
            
            chars.forEach((char, index) => {
                const tile = document.createElement('div');
                tile.className = char === ',' ? 'tile comma' : 'tile';
                tile.textContent = char;
                tile.draggable = true;
                tile.dataset.char = char;
                tile.dataset.id = `tile-${index}`;
                
                tile.addEventListener('dragstart', handleDragStart);
                tile.addEventListener('dragend', handleDragEnd);
                
                container.appendChild(tile);
            });
        }

        function handleDragStart(e) {
            draggedTile = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('char', e.target.dataset.char);
            e.dataTransfer.setData('id', e.target.dataset.id);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (e.target.classList.contains('digit-slot')) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('digit-slot')) {
                e.target.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            e.target.classList.remove('drag-over');
            
            const char = e.dataTransfer.getData('char');
            const tileId = e.dataTransfer.getData('id');
            
            if (e.target.classList.contains('digit-slot')) {
                if (e.target.dataset.tileId) {
                    const oldTile = document.querySelector(`[data-id="${e.target.dataset.tileId}"]`);
                    if (oldTile) {
                        oldTile.classList.remove('used');
                    }
                }
                
                e.target.textContent = char;
                e.target.classList.add('filled');
                e.target.dataset.value = char;
                e.target.dataset.tileId = tileId;
                
                draggedTile.classList.add('used');
            }
            
            return false;
        }

        function checkAnswer() {
            const slots = document.querySelectorAll('.digit-slot');
            let allCorrect = true;
            let emptySlots = false;
            
            slots.forEach(slot => {
                const expected = slot.dataset.expected;
                const value = slot.dataset.value;
                
                if (!value) {
                    emptySlots = true;
                } else if (value === expected) {
                    slot.classList.add('correct');
                    slot.classList.remove('incorrect');
                } else {
                    slot.classList.add('incorrect');
                    slot.classList.remove('correct');
                    allCorrect = false;
                }
            });
            
            if (emptySlots) {
                showMessage('üìù Completa tutti gli spazi!', 'error');
                return;
            }
            
            if (allCorrect) {
                correctCount++;
                document.getElementById('correct').textContent = correctCount;
                
                const ex = exercises[currentExercise];
                if (ex.guided) {
                    showMessage('üéâ Perfetto! Hai capito dove va la virgola! üåü', 'success');
                } else {
                    showMessage('üèÜ Eccellente! Hai deciso da solo dove mettere la virgola! üéØ', 'success');
                }
                
                document.getElementById('nextBtn').disabled = false;
                
                if (currentExercise === exercises.length - 1) {
                    setTimeout(() => {
                        showMessage(`üèÜ COMPLIMENTI! Hai finito! Punteggio: ${correctCount}/${exercises.length}`, 'success');
                    }, 2000);
                }
            } else {
                showMessage('‚ùå Controlla la posizione della virgola!', 'error');
            }
        }

        function showHint() {
            const ex = exercises[currentExercise];
            const hintBox = document.getElementById('hintBox');
            const hintText = document.getElementById('hintText');
            
            hintText.innerHTML = `<strong>üí° Suggerimento:</strong><br>${ex.hint}`;
            hintBox.classList.add('show');
        }

        function resetExercise() {
            const slots = document.querySelectorAll('.digit-slot');
            slots.forEach(slot => {
                if (slot.dataset.tileId) {
                    const tile = document.querySelector(`[data-id="${slot.dataset.tileId}"]`);
                    if (tile) {
                        tile.classList.remove('used');
                    }
                }
                slot.textContent = '';
                slot.classList.remove('filled', 'correct', 'incorrect');
                delete slot.dataset.value;
                delete slot.dataset.tileId;
            });
            
            document.getElementById('hintBox').classList.remove('show');
            showMessage('');
        }

        function nextExercise() {
            if (currentExercise < exercises.length - 1) {
                currentExercise++;
                startExercise();
            }
        }

        function updateProgressBar() {
            const progress = ((currentExercise + 1) / exercises.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function showMessage(text, type = '') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = 'message';
            if (type) messageEl.classList.add(type);
            if (text) messageEl.classList.add('show');
            
            if (text && type !== 'error') {
                setTimeout(() => {
                    messageEl.classList.remove('show');
                }, 5000);
            }
        }

        // ==================== FUNZIONE PER ESCI (DIRETTA) ====================
        function esciDalGioco() {
            if (confirm("Vuoi davvero uscire dal gioco?")) {
                // Ferma eventuali timer (non ce ne sono, ma per sicurezza)
                // Reindirizza a Google (o a qualsiasi altra pagina)
                window.location.href = "<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INVALSI - Frazioni - Quinta Primaria</title>
    <style>
        /* STILI COMPLETI (con modifica per il pulsante Esci) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Chalkboard SE', cursive;
        }
        
        body {
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3px;
            color: white;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .game-container {
            background: linear-gradient(145deg, #2d3047, #1f2235);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            padding: 8px;
            width: 100%;
            max-width: 1000px;
            text-align: center;
            border: 2px solid #3a3f5c;
            position: relative;
            overflow: hidden;
            margin: auto;
            max-height: 98vh;
            overflow-y: auto;
        }
        
        .game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6b00, #ffa500, #ff6b00);
            z-index: 1;
        }
        
        .game-header {
            margin-bottom: 8px;
            position: relative;
        }
        
        h1 {
            color: #ffa500;
            font-size: 1.3rem;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            background: linear-gradient(90deg, #ff6b00, #ffa500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
            line-height: 1.2;
            padding: 0 5px;
        }
        
        .tipo-domanda-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 8px 0 10px 0;
            width: 100%;
            flex-wrap: wrap;
        }
        
        .tipo-domanda-btn {
            padding: 8px 16px;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            background: rgba(74, 144, 226, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }
        
        .tipo-domanda-btn:hover {
            background: rgba(74, 144, 226, 0.4);
            transform: translateY(-1px);
        }
        
        .tipo-domanda-btn.attiva {
            background: #4a90e2;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 12px rgba(74, 144, 226, 0.5);
            border: 2px solid #5aa0f0;
        }
        
        .cruscotto-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 8px;
            padding: 6px;
            margin: 6px 0;
            border: 2px solid #3a3f5c;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5),
                        0 4px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            flex-wrap: nowrap;
            overflow: hidden;
        }
        
        .cruscotto-container::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border: 1px solid rgba(255, 165, 0, 0.2);
            border-radius: 5px;
            pointer-events: none;
        }
        
        .indicatore-cruscotto {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;  /* MODIFICATO: centra verticalmente il contenuto */
            position: relative;
            flex: 1;
            min-width: 0;
            padding: 0 5px;
        }
        
        .display-container {
            position: relative;
            width: 80px;
            height: 40px;
            margin-bottom: 3px;
            background: linear-gradient(145deg, #0a0e14, #05070a);
            border-radius: 5px;
            border: 2px solid #1a3b5d;
            box-shadow: 
                inset 0 0 8px rgba(0, 20, 40, 0.8),
                0 3px 4px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(0, 100, 200, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .display-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(255, 255, 255, 0.03) 0px,
                rgba(255, 255, 255, 0.03) 1px,
                transparent 1px,
                transparent 3px
            );
            pointer-events: none;
            z-index: 1;
        }
        
        .display-7segmenti {
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            font-weight: bold;
            color: #ff0000;
            text-shadow: 
                0 0 6px rgba(255, 0, 0, 0.8),
                0 0 10px rgba(255, 0, 0, 0.4);
            letter-spacing: 0.6px;
            position: relative;
            z-index: 2;
            transform: skew(-1deg);
            font-variant-numeric: tabular-nums;
        }
        
        .display-7segmenti.giallo {
            color: #ffcc00;
            text-shadow: 
                0 0 6px rgba(255, 204, 0, 0.8),
                0 0 10px rgba(255, 204, 0, 0.4);
        }
        
        .display-7segmenti.verde {
            color: #00ff00;
            text-shadow: 
                0 0 6px rgba(0, 255, 0, 0.8),
                0 0 10px rgba(0, 255, 0, 0.4);
        }
        
        .display-7segmenti.tempo {
            font-size: 0.95rem;
            letter-spacing: 0.3px;
        }
        
        .display-title {
            margin-top: 3px;
            font-size: 0.75rem;
            color: #ffcc00;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(255, 204, 0, 0.5);
            letter-spacing: 0.2px;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid rgba(255, 204, 0, 0.3);
            font-family: 'Courier New', monospace;
            white-space: nowrap;
        }
        
        .istruzioni-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 0 5px;
        }
        
        .istruzioni-btn {
            padding: 7px 14px;
            background: linear-gradient(145deg, #ffa500, #ff8c00);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            font-size: 0.85rem;
            line-height: 1.2;
            width: 100%;
            max-width: 110px;
        }
        
        .istruzioni-btn:hover {
            background: linear-gradient(145deg, #ff8c00, #e67e00);
            transform: translateY(-2px);
        }
        
        .vite-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 8px 0;
            width: 100%;
        }
        
        .vita {
            width: 22px;
            height: 22px;
            background: #ff4757;
            clip-path: polygon(50% 0%, 100% 35%, 82% 100%, 18% 100%, 0% 35%);
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
            transition: all 0.3s ease;
        }
        
        .vita.persa {
            background: #3a3f5c;
            transform: scale(0.8);
        }
        
        .sezione-gioco {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            position: relative;
        }
        
        .area-domanda {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(30, 33, 57, 0.8);
            border: 2px solid #4a90e2;
            border-radius: 6px;
            padding: 15px;
            margin: 6px 0;
            box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 800px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .testo-domanda {
            font-size: 1.4rem;
            font-weight: bold;
            color: #ffcc00;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.4;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            padding: 0 10px;
        }
        
        .frazione-immagine {
            width: 200px;
            height: 150px;
            margin: 15px auto;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 2px solid #4a90e2;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .frazione-visuale {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .frazione-torta {
            width: 120px;
            height: 120px;
            position: relative;
            border-radius: 50%;
            background: conic-gradient(
                #ff6b6b 0% 25%,
                #4ecdc4 25% 50%,
                #45b7d1 50% 75%,
                #96ceb4 75% 100%
            );
            border: 3px solid white;
            margin-bottom: 10px;
        }
        
        .frazione-rettangolo {
            width: 160px;
            height: 40px;
            background: linear-gradient(to right, #ff6b6b 0%, #ff6b6b 25%, #4ecdc4 25%, #4ecdc4 50%, #45b7d1 50%, #45b7d1 75%, #96ceb4 75%, #96ceb4 100%);
            border: 2px solid white;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .frazione-numero {
            font-size: 2rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .frazione-testo {
            font-size: 1.2rem;
            color: #ffcc00;
            margin-top: 5px;
            font-weight: bold;
        }
        
        .opzioni-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
        }
        
        .opzione-btn {
            padding: 12px 5px;
            background: linear-gradient(145deg, #3a3f5c, #2d3047);
            border: 2px solid #4a90e2;
            border-radius: 8px;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .opzione-btn:hover {
            background: linear-gradient(145deg, #4a4f6c, #3d4057);
            transform: translateY(-3px);
            border-color: #5aa0f0;
        }
        
        .opzione-btn.selezionata {
            background: linear-gradient(145deg, #28a745, #1e7e34);
            border-color: #32cd32;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.6);
        }
        
        .opzione-btn.errata {
            background: linear-gradient(145deg, #dc3545, #c82333);
            border-color: #ff4757;
        }
        
        .opzione-btn.parzialmente-corretta {
            background: linear-gradient(145deg, #ffc107, #ff9800);
            border-color: #ffca28;
        }
        
        .risposta-aperta-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .risposta-input-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .casella-risposta {
            width: 80px;
            height: 60px;
            margin: 0 5px;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid #4a90e2;
            border-radius: 8px;
            color: white;
            outline: none;
        }
        
        .casella-risposta:focus {
            border-color: #ffa500;
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .casella-risposta.corretta {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.2);
        }
        
        .casella-risposta.errata {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.2);
        }
        
        .messaggio-verifica {
            background: rgba(255, 193, 7, 0.2);
            border: 2px dashed #ffc107;
            border-radius: 6px;
            padding: 8px 10px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            color: white;
            width: 90%;
            max-width: 450px;
            margin: 6px auto;
            text-align: center;
        }
        
        .messaggio-verifica.mostra {
            opacity: 1;
            transform: translateY(0);
        }
        
        .messaggio-corretto {
            background: rgba(40, 167, 69, 0.3);
            border-color: #28a745;
            color: #90ee90;
        }
        
        .messaggio-errato {
            background: rgba(220, 53, 69, 0.3);
            border-color: #dc3545;
            color: #ff6b6b;
        }
        
        .messaggio-parziale {
            background: rgba(255, 193, 7, 0.3);
            border-color: #ffc107;
            color: #ffd166;
        }
        
        .messaggio-info {
            background: rgba(255, 193, 7, 0.3);
            border-color: #ffc107;
            color: #ffd166;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .messaggio-info:hover {
            background: rgba(255, 193, 7, 0.4);
        }
        
        .messaggio-game-over {
            background: rgba(108, 117, 125, 0.3);
            border-color: #495057;
            color: white;
            font-size: 0.8rem;
            padding: 10px;
        }
        
        .messaggio-wow {
            background: linear-gradient(145deg, #ff0080, #ff00ff);
            border: 2px solid #ff00ff;
            color: #ffffff;
            animation: rainbow 2s infinite;
            font-size: 0.9rem;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
        }
        
        .messaggio-ahi {
            background: linear-gradient(145deg, #ff0000, #ff4500);
            border: 2px solid #ff0000;
            color: #ffffff;
            animation: shake 0.5s ease-in-out;
            font-size: 0.9rem;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
        }
        
        @keyframes rainbow {
            0%, 100% { 
                background: linear-gradient(145deg, #ff0080, #ff00ff);
                box-shadow: 0 0 12px rgba(255, 0, 255, 0.8);
            }
            25% { 
                background: linear-gradient(145deg, #00ffff, #0080ff);
                box-shadow: 0 0 12px rgba(0, 255, 255, 0.8);
            }
            50% { 
                background: linear-gradient(145deg, #00ff80, #00ff00);
                box-shadow: 0 0 12px rgba(0, 255, 0, 0.8);
            }
            75% { 
                background: linear-gradient(145deg, #ffff00, #ff8000);
                box-shadow: 0 0 12px rgba(255, 255, 0, 0.8);
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .controlli {
            display: none;
            justify-content: center;
            gap: 8px;
            margin: 8px 0;
            flex-wrap: wrap;
            animation: fadeIn 0.5s ease 0.3s both;
        }
        
        .bottone {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: linear-gradient(145deg, #4a90e2, #3a7bd5);
            color: white;
            transition: all 0.2s;
            min-width: 90px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            font-size: 0.85rem;
            line-height: 1.2;
            flex: 1;
            max-width: 140px;
        }
        
        .bottone:hover {
            background: linear-gradient(145deg, #3a7bd5, #2a6bc5);
            transform: translateY(-2px);
            box-shadow: 0 5px 7px rgba(0, 0, 0, 0.4);
        }
        
        .bottone-verifica {
            background: linear-gradient(145deg, #28a745, #1e7e34);
        }
        
        .bottone-verifica:hover {
            background: linear-gradient(145deg, #1e7e34, #156d2b);
        }
        
        .bottone-aiuto {
            background: linear-gradient(145deg, #ffa500, #ff8c00);
        }
        
        .bottone-aiuto:hover {
            background: linear-gradient(145deg, #ff8c00, #e67e00);
        }
        
        .bottone-nuova {
            background: linear-gradient(145deg, #9370db, #7b5fcf);
        }
        
        .bottone-nuova:hover {
            background: linear-gradient(145deg, #7b5fcf, #6a4fcb);
        }
        
        .tastiera-container {
            display: none;
            background: rgba(30, 33, 57, 0.8);
            border-radius: 6px;
            padding: 8px;
            border: 2px solid #4a90e2;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.4);
            margin-top: 8px;
            animation: fadeIn 0.5s ease 0.6s both;
        }
        
        .tastiera-numerica {
            display: flex;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .tasto-numero {
            width: 40px;
            height: 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            background: linear-gradient(145deg, #3a3f5c, #2d3047);
            cursor: pointer;
            color: #ffffff;
            transition: all 0.2s;
            flex: 0 0 auto;
        }
        
        .tasto-numero:hover {
            background: linear-gradient(145deg, #4a4f6c, #3d4057);
            transform: translateY(-2px);
        }
        
        .tasto-cancella {
            background: linear-gradient(145deg, #ff4757, #ff3742);
            color: white;
            border-color: #dc3545;
            font-size: 0.9rem;
            width: 60px;
        }
        
        .tasto-cancella:hover {
            background: linear-gradient(145deg, #ff3742, #ff2732);
        }
        
        .risposte-consecutive, .aiuti-utilizzati {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
            font-size: 0.65rem;
            color: #a0a0c0;
            font-weight: bold;
        }
        
        .cuore-consecutivo {
            color: #ff4757;
            font-size: 0.8rem;
        }
        
        .icona-aiuto {
            color: #ffa500;
            font-size: 0.8rem;
        }
        
        .messaggio-avvio {
            background: linear-gradient(145deg, #4a90e2, #3a7bd5);
            border: 3px solid #ffa500;
            border-radius: 10px;
            padding: 15px;
            margin: 10px auto;
            max-width: 450px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            animation: pulse-glow 2s infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4),
                            0 0 0px rgba(255, 165, 0, 0.5);
            }
            50% { 
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4),
                            0 0 20px rgba(255, 165, 0, 0.8);
            }
        }
        
        .messaggio-avvio:hover {
            transform: scale(1.03);
            background: linear-gradient(145deg, #3a7bd5, #2a6bc5);
        }
        
        .messaggio-avvio h2 {
            color: #ffcc00;
            font-size: 1.3rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .messaggio-avvio p {
            color: white;
            margin-bottom: 6px;
            font-size: 0.9rem;
            line-height: 1.3;
            text-align: center;
        }
        
        .messaggio-avvio .istruzione-principale {
            font-size: 1rem;
            font-weight: bold;
            color: #ffcc00;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border: 1px solid rgba(255, 204, 0, 0.3);
        }
        
        .messaggio-avvio .istruzione-gioco {
            font-size: 0.9rem;
            color: #ffd166;
            background: rgba(255, 193, 7, 0.2);
            border: 2px dashed #ffc107;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
            width: 90%;
            max-width: 350px;
        }
        
        .icona-play {
            font-size: 2rem;
            margin-bottom: 10px;
            animation: bounce 1.5s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 8px;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #2d3047, #1f2235);
            border-radius: 6px;
            padding: 10px;
            width: 95%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            border: 2px solid #4a90e2;
            position: relative;
            color: white;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 5px;
        }
        
        .modal-title {
            color: #ffa500;
            font-size: 0.9rem;
        }
        
        .close-modal {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .modal-section {
            margin-bottom: 8px;
            text-align: left;
        }
        
        .modal-section h3 {
            color: #4a90e2;
            margin-bottom: 4px;
            font-size: 0.8rem;
            border-left: 3px solid #ffa500;
            padding-left: 4px;
        }
        
        .modal-section p {
            margin-bottom: 4px;
            line-height: 1.2;
            font-size: 0.7rem;
            color: #d0d0e0;
        }
        
        .modal-list {
            list-style-type: decimal;
            padding-left: 12px;
            margin: 5px 0;
            color: #d0d0e0;
        }
        
        .modal-list li {
            margin-bottom: 4px;
            line-height: 1.2;
            font-size: 0.7rem;
        }
        
        .punteggio-info {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .punteggio-item {
            background: rgba(74, 144, 226, 0.2);
            padding: 4px;
            border-radius: 4px;
            border: 2px solid #4a90e2;
            flex: 1;
            min-width: 80px;
        }
        
        .punteggio-item .value {
            font-weight: bold;
            color: #28a745;
            font-size: 0.75rem;
        }
        
        .errori-indicatore {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            font-size: 0.7rem;
            color: #ffcc00;
            font-weight: bold;
        }
        
        .pallino-errore {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3a3f5c;
            border: 1px solid #ff4757;
        }
        
        .pallino-errore.attivo {
            background: #ff4757;
            box-shadow: 0 0 5px rgba(255, 71, 87, 0.8);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 2px;
                align-items: flex-start;
            }
            
            .game-container {
                padding: 6px;
                margin: 2px auto;
                border-radius: 10px;
                max-height: 96vh;
            }
            
            h1 {
                font-size: 1.2rem;
                margin-bottom: 6px;
            }
            
            .tipo-domanda-container {
                margin: 6px 0 8px 0;
                gap: 8px;
            }
            
            .tipo-domanda-btn {
                padding: 7px 14px;
                font-size: 0.8rem;
                min-width: 85px;
            }
            
            .cruscotto-container {
                padding: 5px;
                margin: 4px 0;
            }
            
            .display-container {
                width: 75px;
                height: 36px;
            }
            
            .display-7segmenti {
                font-size: 1.3rem;
            }
            
            .display-7segmenti.tempo {
                font-size: 0.9rem;
            }
            
            .display-title {
                font-size: 0.7rem;
                padding: 2px 5px;
            }
            
            .istruzioni-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
                max-width: 100px;
            }
            
            .area-domanda {
                padding: 12px;
                margin: 4px 0;
            }
            
            .testo-domanda {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }
            
            .opzioni-container {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .opzione-btn {
                padding: 10px;
                font-size: 1rem;
            }
            
            .vite-container {
                margin: 6px 0;
            }
            
            .vita {
                width: 20px;
                height: 20px;
            }
            
            .controlli {
                gap: 6px;
                margin: 6px 0;
            }
            
            .bottone {
                padding: 7px 10px;
                min-width: 80px;
                font-size: 0.8rem;
                max-width: 120px;
            }
            
            .messaggio-avvio {
                padding: 12px;
                margin: 8px auto;
            }
            
            .messaggio-avvio h2 {
                font-size: 1.2rem;
            }
            
            .messaggio-avvio p {
                font-size: 0.85rem;
            }
            
            .tastiera-container {
                padding: 6px;
            }
            
            .tasto-numero {
                width: 45px;
                height: 45px;
                font-size: 1.2rem;
            }
            
            .tasto-cancella {
                width: 70px;
                font-size: 0.9rem;
                height: 45px;
            }
            
            .casella-risposta {
                width: 70px;
                height: 55px;
                font-size: 1.8rem;
            }
            
            .messaggio-verifica {
                padding: 6px 8px;
                min-height: 35px;
                font-size: 0.75rem;
                margin: 4px auto;
            }
            
            .errori-indicatore {
                font-size: 0.65rem;
            }
            
            .pallino-errore {
                width: 10px;
                height: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .game-container {
                padding: 5px;
                max-height: 94vh;
            }
            
            h1 {
                font-size: 1.1rem;
                margin-bottom: 4px;
            }
            
            .tipo-domanda-container {
                gap: 6px;
                margin: 4px 0 6px 0;
            }
            
            .tipo-domanda-btn {
                padding: 6px 12px;
                font-size: 0.75rem;
                min-width: 75px;
            }
            
            .cruscotto-container {
                padding: 4px;
            }
            
            .display-container {
                width: 70px;
                height: 34px;
            }
            
            .display-7segmenti {
                font-size: 1.2rem;
            }
            
            .display-7segmenti.tempo {
                font-size: 0.85rem;
            }
            
            .display-title {
                font-size: 0.65rem;
                padding: 2px 4px;
            }
            
            .istruzioni-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
                max-width: 90px;
            }
            
            .testo-domanda {
                font-size: 1.1rem;
            }
            
            .vita {
                width: 18px;
                height: 18px;
            }
            
            .controlli {
                gap: 4px;
            }
            
            .bottone {
                padding: 6px 8px;
                min-width: 70px;
                font-size: 0.75rem;
                max-width: 100px;
            }
            
            .messaggio-avvio {
                padding: 10px;
            }
            
            .messaggio-avvio h2 {
                font-size: 1.1rem;
            }
            
            .messaggio-avvio p {
                font-size: 0.8rem;
            }
            
            .icona-play {
                font-size: 1.8rem;
            }
            
            .tasto-numero {
                width: 48px;
                height: 48px;
                font-size: 1.3rem;
            }
            
            .tasto-cancella {
                width: 75px;
                height: 48px;
            }
            
            .casella-risposta {
                width: 65px;
                height: 50px;
                font-size: 1.6rem;
            }
            
            .messaggio-verifica {
                font-size: 0.7rem;
                padding: 5px 6px;
                min-height: 30px;
            }
            
            .modal-content {
                padding: 8px;
            }
            
            .errori-indicatore {
                font-size: 0.6rem;
            }
            
            .pallino-errore {
                width: 9px;
                height: 9px;
            }
        }
        
        @media (max-width: 360px) {
            .tipo-domanda-container {
                flex-direction: row;
                gap: 4px;
                align-items: center;
                justify-content: center;
            }
            
            .tipo-domanda-btn {
                width: auto;
                max-width: 100px;
                padding: 5px 8px;
                font-size: 0.7rem;
            }
            
            .cruscotto-container {
                flex-wrap: wrap;
                justify-content: center;
                gap: 5px;
            }
            
            .indicatore-cruscotto, .istruzioni-container {
                flex: 0 0 calc(50% - 10px);
                margin-bottom: 5px;
            }
            
            .istruzioni-container {
                order: 3;
                flex: 0 0 100%;
            }
            
            .controlli {
                flex-direction: column;
                align-items: center;
            }
            
            .bottone {
                width: 100%;
                max-width: 200px;
            }
            
            .opzioni-container {
                grid-template-columns: 1fr;
            }
        }
        
        .multi-selezione-info {
            font-size: 0.9rem;
            color: #ffcc00;
            margin: 10px 0;
            padding: 5px 10px;
            background: rgba(255, 204, 0, 0.1);
            border-radius: 5px;
            border: 1px dashed #ffcc00;
        }
        
        .messaggio-suggerimento {
            background: linear-gradient(145deg, #3498db, #2980b9);
            border: 2px solid #3498db;
            color: #ffffff;
            font-size: 0.9rem;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
            animation: pulse-suggerimento 2s infinite;
        }
        
        @keyframes pulse-suggerimento {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
            }
            50% { 
                box-shadow: 0 0 20px rgba(52, 152, 219, 0.8);
            }
        }
        
        .bottone-cambia-sezione {
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            border: 2px solid #2980b9;
            margin-top: 8px;
        }
        
        .bottone-cambia-sezione:hover {
            background: linear-gradient(145deg, #2980b9, #1f618d);
            transform: translateY(-2px);
        }
        
        .bottone-prossima {
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            border: 2px solid #2980b9;
        }
        
        .bottone-prossima:hover {
            background: linear-gradient(145deg, #2980b9, #1f618d);
            transform: translateY(-2px);
        }

        /* Stile per il pulsante Esci */
        .btn-exit {
            background: none;
            border: none;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            width: 100%;
            padding: 2px;
            border-radius: 5px;
            transition: background 0.2s;
        }
        .btn-exit:hover {
            background: rgba(255,255,255,0.2);
        }
        .exit-icon {
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>FRAZIONI - INVALSI Quinta Primaria</h1>
            
            <div class="tipo-domanda-container">
                <button class="tipo-domanda-btn attiva" id="tipo-base">
                    Concetti Base
                </button>
                <button class="tipo-domanda-btn" id="tipo-confronti">
                    Confronti
                </button>
                <button class="tipo-domanda-btn" id="tipo-operazioni">
                    Operazioni
                </button>
                <button class="tipo-domanda-btn" id="tipo-problemi">
                    Problemi
                </button>
            </div>
            
            <div class="cruscotto-container">
                <div class="indicatore-cruscotto">
                    <div class="display-container">
                        <div class="display-7segmenti giallo" id="punteggio-display">0</div>
                    </div>
                    <div class="display-title">PUNTEGGIO</div>
                </div>
                
                <div class="istruzioni-container">
                    <button class="istruzioni-btn" id="istruzioni-btn" title="Istruzioni del gioco">
                        üìö Istruzioni
                    </button>
                </div>
                
                <div class="indicatore-cruscotto">
                    <div class="display-container">
                        <div class="display-7segmenti verde tempo" id="tempo-display">10:00</div>
                    </div>
                    <div class="display-title">TEMPO</div>
                </div>

                <!-- NUOVO PULSANTE ESCI (senza testo sotto) -->
                <div class="indicatore-cruscotto">
                    <button class="btn-exit" id="esciBtn">
                        <span class="exit-icon">üö™</span>
                        <span>Esci</span>
                    </button>
                    <!-- TESTO "ESCI" RIMOSSO -->
                </div>
            </div>
            
            <div class="vite-container" id="vite-container"></div>
            
            <div class="errori-indicatore" id="errori-indicatore">
                <span>Errori consecutivi:</span>
                <div class="pallino-errore" id="errore-1"></div>
                <div class="pallino-errore" id="errore-2"></div>
                <div class="pallino-errore" id="errore-3"></div>
                <span>(perdi 1 vita al 3¬∞ errore)</span>
            </div>
            
            <div class="risposte-consecutive" id="risposte-consecutive">
                <span>Risposte consecutive corrette:</span>
                <span id="contatore-consecutive">0</span>
                <span class="cuore-consecutivo">‚ù§Ô∏è</span>
            </div>
            
            <div class="aiuti-utilizzati" id="aiuti-utilizzati">
                <span>Aiuti utilizzati in questa domanda:</span>
                <span id="contatore-aiuti">0</span>
                <span class="icona-aiuto">üß†</span>
                <span>(costo: -2 punti ciascuno)</span>
            </div>
        </div>
        
        <div class="sezione-gioco">
            <div class="messaggio-avvio" id="messaggio-avvio">
                <div class="icona-play">¬Ω</div>
                <h2>Pronti per il mondo delle frazioni?</h2>
                <p>Impara a riconoscere, confrontare e calcolare con le frazioni!</p>
                <p>Domande stile INVALSI per la quinta primaria.</p>
                <div class="istruzione-gioco">
                    Alcune domande hanno pi√π risposte corrette!<br>
                    Clicca su tutte le opzioni che ritieni corrette.
                </div>
                <p class="istruzione-principale">Clicca qui per iniziare a giocare!</p>
            </div>
            
            <div class="area-domanda" id="area-domanda"></div>
            
            <div class="messaggio-verifica" id="messaggio-verifica"></div>
        </div>
        
        <div class="controlli" id="controlli-gioco">
            <button class="bottone bottone-aiuto" id="bottone-aiuto">
                üß† Aiuto (-2)
            </button>
            <button class="bottone bottone-verifica" id="bottone-verifica">
                ‚úì Verifica
            </button>
            <button class="bottone bottone-prossima" id="bottone-prossima" style="display: none;">
                ‚è≠Ô∏è Prossima
            </button>
            <button class="bottone bottone-nuova" id="bottone-nuova">
                üîÑ Nuova Partita
            </button>
        </div>
        
        <div class="tastiera-container" id="tastiera-container">
            <div class="tastiera-numerica" id="tastiera-numerica"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    üìö Istruzioni del Gioco - Frazioni INVALSI
                </div>
                <button class="close-modal" id="close-modal">‚úï</button>
            </div>
            
            <div class="modal-section">
                <h3>üéØ Come Giocare</h3>
                <p>Impara a lavorare con le frazioni:</p>
                <ol class="modal-list">
                    <li>Scegli il tipo di domanda (Concetti Base, Confronti, Operazioni, Problemi)</li>
                    <li>Leggi attentamente la domanda e osserva le immagini</li>
                    <li>Per domande a scelta multipla: clicca sulla risposta corretta</li>
                    <li>Per domande con pi√π risposte: clicca su TUTTE le risposte corrette</li>
                    <li>Per vero/falso: clicca su VERO o FALSO</li>
                    <li>Per risposte aperte: scrivi la frazione o il numero <strong>sempre in forma ridotta ai minimi termini</strong></li>
                    <li>Premi "Verifica" per controllare la risposta</li>
                    <li>Dopo la verifica, premi "Prossima" per passare alla domanda successiva</li>
                </ol>
            </div>
            
            <div class="modal-section">
                <h3>¬Ω Tipi di Domande</h3>
                <p><strong>Concetti Base:</strong> Cos'√® una frazione, termini (numeratore/denominatore), frazioni proprie/improprie</p>
                <p><strong>Confronti:</strong> Quale frazione √® maggiore/minore, frazioni equivalenti</p>
                <p><strong>Operazioni:</strong> Addizioni e sottrazioni di frazioni con stesso denominatore, semplificazioni</p>
                <p><strong>Problemi:</strong> Applicazione delle frazioni a situazioni pratiche</p>
                <p><strong>Vero/Falso:</strong> Affermazioni da valutare come vere o false</p>
                <p><strong>Scelta Multipla:</strong> 4 opzioni, una sola corretta</p>
                <p><strong>Scelta Multipla Multipla:</strong> 4 opzioni, pi√π risposte corrette possibili</p>
            </div>
            
            <div class="modal-section">
                <h3>üìä Come lavorare con le frazioni</h3>
                <p><strong>Termini:</strong> Frazione = numeratore / denominatore</p>
                <ul class="modal-list">
                    <li>Esempio: 3/4 significa 3 parti su 4</li>
                    <li>Frazione propria: numeratore minore del denominatore (es. 2/5)</li>
                    <li>Frazione impropria: numeratore maggiore o uguale al denominatore (es. 5/4)</li>
                    <li>Frazioni equivalenti: rappresentano la stessa quantit√† (es. 1/2 = 2/4 = 3/6)</li>
                    <li><strong>Importante:</strong> Scrivi sempre le frazioni in forma ridotta ai minimi termini (es. 1/2 invece di 2/4 o 3/6)</li>
                    <li><strong>Regola:</strong> Dividi numeratore e denominatore per il loro massimo comune divisore</li>
                </ul>
            </div>
            
            <div class="modal-section">
                <h3>üèÜ Sistema dei Punteggi e Vite</h3>
                <div class="punteggio-info">
                    <div class="punteggio-item">
                        <div>Risposta corretta:</div>
                        <div class="value">+2 punti</div>
                    </div>
                    <div class="punteggio-item">
                        <div>Aiuto utilizzato:</div>
                        <div class="value">-2 punti ciascuno</div>
                    </div>
                    <div class="punteggio-item">
                        <div>Domande con pi√π risposte:</div>
                        <div class="value">+3 punti se tutte corrette</div>
                    </div>
                    <div class="punteggio-item">
                        <div>5 risposte corrette consecutive:</div>
                        <div class="value">+1 vita</div>
                    </div>
                </div>
                <p><strong>‚ö†Ô∏è Attenzione:</strong> Se usi troppi aiuti, potresti finire con 0 punti per quella domanda!</p>
                <p><strong>‚ú® Bonus Vita:</strong> Ogni 5 risposte consecutive corrette, recuperi una vita (massimo 3 vite).</p>
                <p><strong>üîÑ Sistema Errori:</strong> Perdi una vita solo dopo 3 errori consecutivi. Ogni risposta corretta resetta il contatore errori.</p>
            </div>
            
            <div class="modal-section">
                <h3>‚è±Ô∏è Tempo</h3>
                <p>Hai 10 minuti per rispondere a quante pi√π domande possibili!</p>
                <p>Il timer diventa rosso quando mancano meno di 60 secondi.</p>
            </div>
            
            <div class="modal-section">
                <h3>üéì Obiettivo Didattico</h3>
                <p>Questo gioco aiuta a prepararsi alle prove INVALSI di matematica per la quinta classe della scuola primaria, sviluppando:</p>
                <ul class="modal-list">
                    <li>Comprensione del concetto di frazione</li>
                    <li>Riconoscimento di frazioni proprie e improprie</li>
                    <li>Confronto di frazioni</li>
                    <li>Calcolo di semplici operazioni con frazioni</li>
                    <li>Risoluzione di problemi con le frazioni</li>
                    <li>Scrittura di frazioni in forma ridotta ai minimi termini</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // VARIABILI DEL GIOCO
        let punteggio = 0;
        let vite = 3;
        let tipoGioco = 'base';
        let verificaEseguita = false;
        let gameOver = false;
        let haSbagliatoQuestaDomanda = false;
        
        let operazioniCorretteConsecutive = 0;
        let aiutiUtilizzatiDomandaCorrente = 0;
        let rispostaCorrente = null;
        let opzioniSelezionate = [];
        let rispostaAperta = "";
        
        let tempoRimanente = 600;
        let timerInterval;
        let timerAttivo = false;
        const TEMPO_TOTALE = 600;
        
        let timeoutBenvenuto = null;
        let giocoIniziato = false;
        
        let erroriConsecutivi = 0;
        
        let domandeConsecutiveStessaSezione = 0;
        let haMostratoSuggerimentoCambioSezione = false;
        const LIMITE_DOMANDE_PRIMA_SUGGERIMENTO = 5;
        
        // DOMANDE SULLE FRAZIONI
        const tutteLeDomande = {
            base: [
                {
                    tipo: "scelta_multipla",
                    domanda: "Una torta √® divisa in 4 parti uguali. Se una parte √® colorata di rosso, quale frazione rappresenta la parte colorata?",
                    opzioni: ["1/2", "1/4", "1/3", "3/4"],
                    risposta: 1,
                    difficolta: 1
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "Quali di queste sono frazioni equivalenti a 1/2? (Scegli tutte quelle corrette)",
                    opzioni: ["2/4", "3/6", "2/3", "4/8", "3/5"],
                    risposte: [0, 1, 3],
                    difficolta: 2
                },
                {
                    tipo: "vero_falso",
                    domanda: "La frazione 5/4 √® una frazione propria.",
                    risposta: false,
                    spiegazione: "Una frazione propria ha il numeratore minore del denominatore. 5/4 ha numeratore maggiore, quindi √® impropria.",
                    difficolta: 1
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "Quali di queste sono frazioni proprie? (Scegli tutte quelle corrette)",
                    opzioni: ["2/5", "5/3", "3/4", "7/8", "9/9"],
                    risposte: [0, 2, 3],
                    spiegazione: "Una frazione propria ha numeratore minore del denominatore. 2/5, 3/4, 7/8 hanno numeratore minore, 5/3 ha numeratore maggiore, 9/9 √® uguale a 1.",
                    difficolta: 2
                },
                {
                    tipo: "scelta_multipla",
                    domanda: "Come si legge la frazione 3/5?",
                    opzioni: ["Tre quinti", "Cinque terzi", "Tre su cinque", "Cinque su tre"],
                    risposta: 0,
                    difficolta: 1
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "Quali di queste frazioni rappresentano il numero intero 1? (Scegli tutte quelle corrette)",
                    opzioni: ["1/1", "3/3", "2/2", "4/4", "5/6"],
                    risposte: [0, 1, 2, 3],
                    spiegazione: "Quando numeratore e denominatore sono uguali, la frazione rappresenta l'intero 1.",
                    difficolta: 2
                },
                {
                    tipo: "vero_falso",
                    domanda: "La frazione 7/8 √® maggiore di 1.",
                    risposta: false,
                    spiegazione: "7/8 √® minore di 1 perch√© il numeratore (7) √® minore del denominatore (8).",
                    difficolta: 1
                },
                {
                    tipo: "risposta_aperta",
                    domanda: "Un rettangolo √® diviso in 8 parti uguali. Se 3 parti sono colorate, quale frazione rappresenta la parte colorata? (Scrivi in forma ridotta, es. 1/2)",
                    risposta: "3/8",
                    spiegazione: "Le parti colorate sono 3 su 8 totali, quindi la frazione √® 3/8.",
                    difficolta: 2
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "Quali di queste sono frazioni improprie? (Scegli tutte quelle corrette)",
                    opzioni: ["7/8", "4/4", "9/5", "5/3", "2/5"],
                    risposte: [1, 2, 3],
                    spiegazione: "Una frazione impropria ha numeratore maggiore o uguale al denominatore. 4/4 ha numeratore uguale, 9/5 e 5/3 hanno numeratore maggiore. 7/8 e 2/5 sono proprie.",
                    difficolta: 2
                },
                {
                    tipo: "vero_falso",
                    domanda: "La frazione 0/5 √® uguale a 0.",
                    risposta: true,
                    spiegazione: "Quando il numeratore √® 0, la frazione √® uguale a 0, qualunque sia il denominatore (tranne 0).",
                    difficolta: 1
                }
            ],
            
            confronti: [
                {
                    tipo: "scelta_multipla",
                    domanda: "Quale frazione √® maggiore: 3/5 o 2/5?",
                    opzioni: ["3/5", "2/5", "Sono uguali", "Non si pu√≤ confrontare"],
                    risposta: 0,
                    spiegazione: "Con stesso denominatore, √® maggiore la frazione con numeratore maggiore.",
                    difficolta: 1
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "Quali di queste coppie di frazioni sono equivalenti? (Scegli tutti i gruppi corretti)",
                    opzioni: ["1/2 e 2/4", "2/3 e 4/6", "3/4 e 6/8", "1/3 e 2/5"],
                    risposte: [0, 1, 2],
                    spiegazione: "1/2=2/4, 2/3=4/6, 3/4=6/8. 1/3=5/15 mentre 2/5=6/15, quindi non sono equivalenti.",
                    difficolta: 3
                },
                {
                    tipo: "vero_falso",
                    domanda: "La frazione 5/10 √® equivalente a 1/2.",
                    risposta: true,
                    spiegazione: "5/10 semplificato (dividendo per 5) diventa 1/2.",
                    difficolta: 2
                },
                {
                    tipo: "scelta_multipla",
                    domanda: "Quale frazione √® maggiore: 2/3 o 3/4?",
                    opzioni: ["2/3", "3/4", "Sono uguali", "Non si pu√≤ confrontare"],
                    risposta: 1,
                    spiegazione: "2/3 = 8/12, 3/4 = 9/12, quindi 3/4 √® maggiore.",
                    difficolta: 3
                },
                {
                    tipo: "risposta_aperta",
                    domanda: "Quale frazione √® equivalente a 2/4? Scrivi in forma ridotta ai minimi termini.",
                    risposta: "1/2",
                    spiegazione: "2/4 semplificato (dividendo per 2) diventa 1/2.",
                    difficolta: 2
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "Quali di queste frazioni sono minori di 1/2? (Scegli tutte quelle corrette)",
                    opzioni: ["1/3", "2/5", "3/4", "1/5", "4/8"],
                    risposte: [0, 1, 3],
                    spiegazione: "1/2 = 0.5. 1/3‚âà0.33, 2/5=0.4, 1/5=0.2 sono minori di 0.5. 3/4=0.75 e 4/8=0.5 non sono minori.",
                    difficolta: 3
                },
                {
                    tipo: "vero_falso",
                    domanda: "La frazione 7/8 √® maggiore della frazione 6/7.",
                    risposta: true,
                    spiegazione: "7/8 = 49/56, 6/7 = 48/56, quindi 7/8 √® maggiore di 6/7.",
                    difficolta: 3
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "Quali di queste frazioni sono maggiori di 3/4? (Scegli tutte quelle corrette)",
                    opzioni: ["5/6", "7/8", "2/3", "4/5", "6/7"],
                    risposte: [0, 1, 3, 4],
                    spiegazione: "3/4 = 0.75. 5/6‚âà0.83, 7/8=0.875, 4/5=0.8, 6/7‚âà0.857 sono maggiori. 2/3‚âà0.667 √® minore.",
                    difficolta: 3
                },
                {
                    tipo: "scelta_multipla",
                    domanda: "Quale di queste frazioni √® la pi√π grande?",
                    opzioni: ["1/3", "1/2", "1/4", "1/5"],
                    risposta: 1,
                    spiegazione: "Con lo stesso numeratore, √® maggiore la frazione con denominatore minore.",
                    difficolta: 2
                },
                {
                    tipo: "vero_falso",
                    domanda: "Tutte le frazioni con numeratore 1 sono equivalenti.",
                    risposta: false,
                    spiegazione: "No, 1/2, 1/3, 1/4 sono tutte diverse tra loro.",
                    difficolta: 2
                }
            ],
            
            operazioni: [
                {
                    tipo: "scelta_multipla",
                    domanda: "Quanto fa 1/4 + 2/4?",
                    opzioni: ["1/4", "2/4", "3/4", "3/8"],
                    risposta: 2,
                    spiegazione: "Con stesso denominatore, si sommano i numeratori: 1+2=3, denominatore 4.",
                    difficolta: 1
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "Quali di queste operazioni danno come risultato 1? (Scegli tutte quelle corrette)",
                    opzioni: ["1/2 + 1/2", "2/3 + 1/3", "3/4 + 1/4", "1/5 + 3/5"],
                    risposte: [0, 1, 2],
                    spiegazione: "1/2+1/2=1, 2/3+1/3=1, 3/4+1/4=1, 1/5+3/5=4/5.",
                    difficolta: 2
                },
                {
                    tipo: "vero_falso",
                    domanda: "La somma di 1/3 e 1/3 √® 2/3.",
                    risposta: true,
                    spiegazione: "1/3 + 1/3 = 2/3 (stesso denominatore, somma i numeratori).",
                    difficolta: 1
                },
                {
                    tipo: "risposta_aperta",
                    domanda: "Quanto fa 3/5 + 1/5? Scrivi in forma ridotta ai minimi termini.",
                    risposta: "4/5",
                    spiegazione: "3/5 + 1/5 = 4/5.",
                    difficolta: 1
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "Quali di queste sottrazioni danno come risultato 1/2? (Scegli tutte quelle corrette)",
                    opzioni: ["3/4 - 1/4", "5/6 - 2/6", "4/8 - 0/8", "7/8 - 3/8"],
                    risposte: [0, 1, 2, 3],
                    spiegazione: "Tutte le operazioni danno 1/2: 3/4-1/4=2/4=1/2, 5/6-2/6=3/6=1/2, 4/8-0/8=4/8=1/2, 7/8-3/8=4/8=1/2.",
                    difficolta: 3
                },
                {
                    tipo: "vero_falso",
                    domanda: "La differenza tra 9/10 e 3/10 √® 6/10.",
                    risposta: true,
                    spiegazione: "9/10 - 3/10 = 6/10 (che pu√≤ essere semplificato in 3/5).",
                    difficolta: 2
                },
                {
                    tipo: "scelta_multipla",
                    domanda: "Se aggiungo 2/7 a 3/7, quanto ottengo?",
                    opzioni: ["5/14", "5/7", "6/7", "1/7"],
                    risposta: 1,
                    spiegazione: "3/7 + 2/7 = 5/7.",
                    difficolta: 1
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "Quali di queste frazioni semplificate diventano 1/3? (Scegli tutte quelle corrette)",
                    opzioni: ["2/6", "3/9", "4/12", "5/15", "3/12"],
                    risposte: [0, 1, 2, 3],
                    spiegazione: "2/6=1/3, 3/9=1/3, 4/12=1/3, 5/15=1/3. 3/12=1/4.",
                    difficolta: 3
                },
                {
                    tipo: "scelta_multipla",
                    domanda: "Qual √® il risultato di 2/9 + 4/9?",
                    opzioni: ["6/18", "2/3", "6/9", "2/9"],
                    risposta: 2,
                    spiegazione: "2/9 + 4/9 = 6/9 (che pu√≤ essere semplificato in 2/3).",
                    difficolta: 1
                },
                {
                    tipo: "vero_falso",
                    domanda: "La frazione 3/5 semplificata diventa 1/2.",
                    risposta: false,
                    spiegazione: "3/5 non pu√≤ essere semplificata perch√© 3 e 5 non hanno divisori comuni.",
                    difficolta: 2
                }
            ],
            
            problemi: [
                {
                    tipo: "scelta_multipla",
                    domanda: "Marco ha mangiato 1/4 di una pizza e Luca 2/4. Che frazione di pizza hanno mangiato insieme?",
                    opzioni: ["1/4", "2/4", "3/4", "1/2"],
                    risposta: 2,
                    spiegazione: "1/4 + 2/4 = 3/4.",
                    difficolta: 2
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "Quali di queste situazioni possono essere rappresentate dalla frazione 3/4? (Scegli tutte quelle corrette)",
                    opzioni: ["3 giorni su 4 della settimana", "3 mele su 4 nel cesto", "3/4 di un'ora (45 minuti)", "3 metri su 4 di stoffa"],
                    risposte: [0, 1, 2, 3],
                    spiegazione: "Tutte rappresentano 3 parti su 4.",
                    difficolta: 2
                },
                {
                    tipo: "vero_falso",
                    domanda: "Se una cioccolata √® divisa in 6 parti e ne mangio 2, ho mangiato 1/3 della cioccolata.",
                    risposta: true,
                    spiegazione: "2/6 = 1/3 (semplificando per 2).",
                    difficolta: 2
                },
                {
                    tipo: "scelta_multipla",
                    domanda: "In una classe di 20 alunni, 12 sono maschi. Quale frazione rappresenta le femmine?",
                    opzioni: ["12/20", "8/20", "2/5", "3/5"],
                    risposta: 1,
                    spiegazione: "Femmine = 20-12 = 8, quindi 8/20 (che pu√≤ essere semplificato in 2/5).",
                    difficolta: 2
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "Quali di queste affermazioni sono corrette per una frazione 3/8? (Scegli tutte quelle corrette)",
                    opzioni: ["Il numeratore √® 3", "Il denominatore √® 8", "√à una frazione propria", "√à maggiore di 1/2"],
                    risposte: [0, 1, 2],
                    spiegazione: "3/8: numeratore=3, denominatore=8, √® propria (3<8), non √® maggiore di 1/2 (1/2=4/8).",
                    difficolta: 2
                },
                {
                    tipo: "scelta_multipla",
                    domanda: "Un'automobile ha percorso 3/5 del viaggio. Che frazione del viaggio le rimane da percorrere?",
                    opzioni: ["1/5", "2/5", "3/5", "4/5"],
                    risposta: 1,
                    spiegazione: "L'intero viaggio √® 5/5. Se ha percorso 3/5, rimane 5/5 - 3/5 = 2/5.",
                    difficolta: 2
                },
                {
                    tipo: "vero_falso",
                    domanda: "Se spendo 1/3 dei miei risparmi e poi altri 1/3, ho speso 2/3 dei miei risparmi.",
                    risposta: true,
                    spiegazione: "1/3 + 1/3 = 2/3.",
                    difficolta: 2
                },
                {
                    tipo: "scelta_multipla_multi",
                    domanda: "In un sacchetto con 10 caramelle, quali frazioni rappresentano situazioni possibili? (Scegli tutte quelle corrette)",
                    opzioni: ["3/10 (3 caramelle rosse)", "7/10 (7 caramelle verdi)", "10/10 (tutte le caramelle)", "11/10 (impossibile)"],
                    risposte: [0, 1, 2],
                    spiegazione: "3/10, 7/10 e 10/10 sono possibili. 11/10 non √® possibile perch√© non puoi avere pi√π caramelle del totale.",
                    difficolta: 2
                },
                {
                    tipo: "scelta_multipla",
                    domanda: "Anna ha letto 2/7 di un libro e Paolo 3/7. Quale frazione del libro hanno letto insieme?",
                    opzioni: ["5/14", "5/7", "1/7", "6/7"],
                    risposta: 1,
                    spiegazione: "2/7 + 3/7 = 5/7.",
                    difficolta: 2
                },
                {
                    tipo: "vero_falso",
                    domanda: "Se ho 1/2 di una mela e ne mangio 1/4, mi rimane 1/4 della mela.",
                    risposta: true,
                    spiegazione: "1/2 - 1/4 = 2/4 - 1/4 = 1/4.",
                    difficolta: 3
                }
            ]
        };
        
        // Funzione per normalizzare le frazioni
        function normalizzaFrazione(frazione) {
            if (!frazione || !frazione.includes('/')) return frazione;
            
            const parti = frazione.split('/');
            if (parti.length !== 2) return frazione;
            
            let numeratore = parseInt(parti[0]);
            let denominatore = parseInt(parti[1]);
            
            if (isNaN(numeratore) || isNaN(denominatore) || denominatore === 0) {
                return frazione;
            }
            
            function mcd(a, b) {
                if (b === 0) return a;
                return mcd(b, a % b);
            }
            
            const divisore = mcd(Math.abs(numeratore), Math.abs(denominatore));
            numeratore = numeratore / divisore;
            denominatore = denominatore / divisore;
            
            if (denominatore === 1) {
                return numeratore.toString();
            }
            
            return `${numeratore}/${denominatore}`;
        }
        
        // Funzione per mescolare array
        function mescolaArray(array) {
            let arrayMescolato = [...array];
            for (let i = arrayMescolato.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arrayMescolato[i], arrayMescolato[j]] = [arrayMescolato[j], arrayMescolato[i]];
            }
            return arrayMescolato;
        }
        
        // Funzione per rimuovere opzioni equivalenti
        function rimuoviOpzioniEquivalenti(opzioni) {
            const valoriUnici = new Map();
            
            return opzioni.filter(opzione => {
                const valore = normalizzaFrazione(opzione);
                if (valoriUnici.has(valore)) {
                    return false;
                }
                valoriUnici.set(valore, true);
                return true;
            });
        }
        
        // Creiamo copie mescolate delle domande
        let domande = {
            base: mescolaArray(tutteLeDomande.base),
            confronti: mescolaArray(tutteLeDomande.confronti),
            operazioni: mescolaArray(tutteLeDomande.operazioni),
            problemi: mescolaArray(tutteLeDomande.problemi)
        };
        
        let domandaCorrente = null;
        let domandeDisponibili = [...domande.base];
        let indiceDomandaCorrente = 0;
        
        // AUDIO CONTEXT
        let audioContext;
        let audioInizializzato = false;
        
        // SUONI
        let wowSound = null;
        let ahiSound = null;
        let successSound = null;
        let clickSound = null;
        let startSound = null;

        // INIZIALIZZAZIONE AUDIO
        function inizializzaAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                creaSuoni();
                audioInizializzato = true;
            } catch (e) {
                console.log("Audio non supportato:", e);
                audioInizializzato = false;
            }
        }
        
        function creaSuoni() {
            // SUONO WOW
            try {
                const durata = 1.5;
                const buffer = audioContext.createBuffer(1, audioContext.sampleRate * durata, audioContext.sampleRate);
                const output = buffer.getChannelData(0);
                
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / audioContext.sampleRate;
                    
                    let freq1 = 200 + (t * 600);
                    if (freq1 > 800) freq1 = 800;
                    
                    let freq2 = freq1 * 1.5;
                    let freq3 = freq1 * 2;
                    
                    let envelope = Math.sin(Math.PI * t/durata) * 0.7;
                    envelope *= (1 + 0.3 * Math.sin(2 * Math.PI * 2 * t));
                    
                    output[i] = envelope * (
                        Math.sin(2 * Math.PI * freq1 * t) * 0.5 +
                        Math.sin(2 * Math.PI * freq2 * t) * 0.3 +
                        Math.sin(2 * Math.PI * freq3 * t) * 0.2
                    );
                    
                    output[i] *= (1 + 0.1 * Math.sin(2 * Math.PI * 3 * t));
                }
                
                wowSound = buffer;
            } catch (e) {
                console.log("Errore creazione suono wow:", e);
            }
            
            // SUONO AHI
            try {
                const durata = 0.8;
                const buffer = audioContext.createBuffer(1, audioContext.sampleRate * durata, audioContext.sampleRate);
                const output = buffer.getChannelData(0);
                
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / audioContext.sampleRate;
                    
                    let freq = 800 * Math.exp(-t * 3);
                    if (freq < 150) freq = 150;
                    
                    let envelope = Math.exp(-t * 4) * 0.8;
                    
                    const phase = 2 * Math.PI * freq * t;
                    output[i] = envelope * (2 * (phase % (2 * Math.PI)) / (2 * Math.PI) - 1) * 0.5;
                    
                    if (t < 0.1) {
                        output[i] += (Math.random() * 2 - 1) * 0.1 * (1 - t/0.1);
                    }
                }
                
                ahiSound = buffer;
            } catch (e) {
                console.log("Errore creazione suono ahi:", e);
            }
            
            // SUONO DI SUCCESSO
            try {
                const durata = 1.0;
                const buffer = audioContext.createBuffer(1, audioContext.sampleRate * durata, audioContext.sampleRate);
                const output = buffer.getChannelData(0);
                
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / audioContext.sampleRate;
                    
                    let freq = 300;
                    if (t < 0.25) freq = 300;
                    else if (t < 0.5) freq = 400;
                    else if (t < 0.75) freq = 500;
                    else freq = 600;
                    
                    let envelope = Math.sin(Math.PI * t/durata) * 0.6;
                    
                    output[i] = envelope * Math.sin(2 * Math.PI * freq * t);
                    
                    output[i] += 0.3 * envelope * Math.sin(2 * Math.PI * freq * 2 * t);
                }
                
                successSound = buffer;
            } catch (e) {
                console.log("Errore creazione suono successo:", e);
            }
            
            // SUONO DI CLICK
            try {
                const durata = 0.1;
                const buffer = audioContext.createBuffer(1, audioContext.sampleRate * durata, audioContext.sampleRate);
                const output = buffer.getChannelData(0);
                
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / audioContext.sampleRate;
                    
                    let freq = 1000 * Math.exp(-t * 50);
                    let envelope = Math.exp(-t * 100) * 0.3;
                    
                    output[i] = envelope * Math.sin(2 * Math.PI * freq * t);
                }
                
                clickSound = buffer;
            } catch (e) {
                console.log("Errore creazione suono click:", e);
            }
            
            // SUONO DI INIZIO GIOCO
            try {
                const durata = 1.2;
                const buffer = audioContext.createBuffer(1, audioContext.sampleRate * durata, audioContext.sampleRate);
                const output = buffer.getChannelData(0);
                
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / audioContext.sampleRate;
                    
                    let freq = 400 + Math.sin(2 * Math.PI * 2 * t) * 100;
                    let envelope = Math.sin(Math.PI * t/durata) * 0.7;
                    
                    output[i] = envelope * (
                        Math.sin(2 * Math.PI * freq * t) * 0.6 +
                        Math.sin(2 * Math.PI * freq * 1.5 * t) * 0.3 +
                        Math.sin(2 * Math.PI * freq * 2 * t) * 0.1
                    );
                    
                    if (t < 0.5) {
                        output[i] += 0.2 * Math.sin(2 * Math.PI * (200 + t * 800) * t);
                    }
                }
                
                startSound = buffer;
            } catch (e) {
                console.log("Errore creazione suono inizio:", e);
            }
        }
        
        function playSound(soundBuffer, volume = 0.7) {
            if (!audioInizializzato || !soundBuffer) return;
            
            try {
                const source = audioContext.createBufferSource();
                source.buffer = soundBuffer;
                
                const gainNode = audioContext.createGain();
                gainNode.gain.value = volume;
                
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                source.start();
                
                const durata = soundBuffer.duration;
                gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + durata);
            } catch (e) {
                console.log("Errore riproduzione suono:", e);
            }
        }
        
        function playWowSound() {
            playSound(wowSound, 0.8);
        }
        
        function playAhiSound() {
            playSound(ahiSound, 0.6);
        }
        
        function playSuccessSound() {
            playSound(successSound, 0.5);
        }
        
        function playClickSound() {
            playSound(clickSound, 0.3);
        }
        
        function playStartSound() {
            playSound(startSound, 0.7);
        }

        // FUNZIONI PER I DISPLAY
        function aggiornaDisplayPunteggio() {
            const punteggioDisplay = document.getElementById('punteggio-display');
            
            punteggioDisplay.style.opacity = '0.7';
            punteggioDisplay.style.transform = 'scale(1.1) skew(-1deg)';
            
            setTimeout(() => {
                punteggioDisplay.textContent = punteggio;
                punteggioDisplay.style.opacity = '1';
                punteggioDisplay.style.transform = 'scale(1) skew(-1deg)';
                
                if (punteggio >= 150) {
                    punteggioDisplay.className = 'display-7segmenti giallo';
                } else if (punteggio >= 100) {
                    punteggioDisplay.className = 'display-7segmenti verde';
                } else {
                    punteggioDisplay.className = 'display-7segmenti giallo';
                }
            }, 150);
        }
        
        function aggiornaDisplayTempo() {
            const tempoDisplay = document.getElementById('tempo-display');
            const minuti = Math.floor(tempoRimanente / 60);
            const secondi = tempoRimanente % 60;
            const tempoFormattato = `${minuti.toString().padStart(2, '0')}:${secondi.toString().padStart(2, '0')}`;
            
            tempoDisplay.style.opacity = '0.7';
            tempoDisplay.style.transform = 'scale(1.05) skew(-1deg)';
            
            setTimeout(() => {
                tempoDisplay.textContent = tempoFormattato;
                tempoDisplay.style.opacity = '1';
                tempoDisplay.style.transform = 'scale(1) skew(-1deg)';
                
                if (tempoRimanente <= 60) {
                    tempoDisplay.style.color = '#ff0000';
                    tempoDisplay.style.textShadow = '0 0 8px rgba(255, 0, 0, 0.8), 0 0 15px rgba(255, 0, 0, 0.4)';
                    
                    if (tempoRimanente <= 10) {
                        tempoDisplay.style.animation = tempoRimanente % 2 === 0 ? 'none' : 'pulse 0.5s infinite';
                    }
                } else if (tempoRimanente <= 180) {
                    tempoDisplay.style.color = '#ff9900';
                    tempoDisplay.style.textShadow = '0 0 8px rgba(255, 153, 0, 0.8), 0 0 15px rgba(255, 153, 0, 0.4)';
                } else {
                    tempoDisplay.style.color = '#00ff00';
                    tempoDisplay.style.textShadow = '0 0 8px rgba(0, 255, 0, 0.8), 0 0 15px rgba(0, 255, 0, 0.4)';
                }
            }, 150);
        }
        
        function aggiornaViteUI() {
            const viteContainer = document.getElementById('vite-container');
            viteContainer.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const vitaDiv = document.createElement('div');
                vitaDiv.className = `vita ${i < vite ? '' : 'persa'}`;
                viteContainer.appendChild(vitaDiv);
            }
        }
        
        function aggiornaIndicatoreErrori() {
            const errore1 = document.getElementById('errore-1');
            const errore2 = document.getElementById('errore-2');
            const errore3 = document.getElementById('errore-3');
            
            errore1.className = 'pallino-errore';
            errore2.className = 'pallino-errore';
            errore3.className = 'pallino-errore';
            
            if (erroriConsecutivi >= 1) errore1.className = 'pallino-errore attivo';
            if (erroriConsecutivi >= 2) errore2.className = 'pallino-errore attivo';
            if (erroriConsecutivi >= 3) errore3.className = 'pallino-errore attivo';
        }
        
        function aggiornaUI() {
            const contatoreAiuti = document.getElementById('contatore-aiuti');
            contatoreAiuti.textContent = aiutiUtilizzatiDomandaCorrente;
            
            const contatoreConsecutive = document.getElementById('contatore-consecutive');
            contatoreConsecutive.textContent = operazioniCorretteConsecutive;
            
            const aiutiDiv = document.getElementById('aiuti-utilizzati');
            const consecutiveDiv = document.getElementById('risposte-consecutive');
            
            if (aiutiUtilizzatiDomandaCorrente > 0) {
                aiutiDiv.style.display = 'flex';
            } else {
                aiutiDiv.style.display = 'none';
            }
            
            if (operazioniCorretteConsecutive > 0) {
                consecutiveDiv.style.display = 'flex';
            } else {
                consecutiveDiv.style.display = 'none';
            }
        }
        
        function avviaTimer() {
            if (timerAttivo || gameOver) return;
            
            timerAttivo = true;
            aggiornaDisplayTempo();
            
            timerInterval = setInterval(() => {
                tempoRimanente--;
                aggiornaDisplayTempo();
                
                if (tempoRimanente <= 0) {
                    fermaTimer();
                    tempoRimanente = 0;
                    gameOver = true;
                    mostraMessaggio(`TEMPO SCADUTO! Punteggio finale: ${punteggio}. Clicca "Nuova Partita" per ricominciare`, "game-over");
                    document.getElementById("bottone-verifica").disabled = true;
                    document.getElementById("bottone-aiuto").disabled = true;
                    aggiornaUI();
                }
            }, 1000);
        }
        
        function fermaTimer() {
            clearInterval(timerInterval);
            timerAttivo = false;
        }
        
        function resetTimer() {
            fermaTimer();
            tempoRimanente = TEMPO_TOTALE;
            aggiornaDisplayTempo();
            if (giocoIniziato) {
                avviaTimer();
            }
        }

        // FUNZIONI DI GIOCO
        function inizializzaGioco() {
            punteggio = 0;
            vite = 3;
            gameOver = false;
            haSbagliatoQuestaDomanda = false;
            operazioniCorretteConsecutive = 0;
            aiutiUtilizzatiDomandaCorrente = 0;
            tipoGioco = 'base';
            verificaEseguita = false;
            tempoRimanente = TEMPO_TOTALE;
            giocoIniziato = false;
            opzioniSelezionate = [];
            rispostaAperta = "";
            
            erroriConsecutivi = 0;
            indiceDomandaCorrente = 0;
            
            domandeConsecutiveStessaSezione = 0;
            haMostratoSuggerimentoCambioSezione = false;
            
            if (!audioInizializzato) {
                inizializzaAudio();
            }
            
            domande.base = mescolaArray([...tutteLeDomande.base]);
            domande.confronti = mescolaArray([...tutteLeDomande.confronti]);
            domande.operazioni = mescolaArray([...tutteLeDomande.operazioni]);
            domande.problemi = mescolaArray([...tutteLeDomande.problemi]);
            
            document.getElementById('area-domanda').style.display = 'none';
            document.getElementById('controlli-gioco').style.display = 'none';
            document.getElementById('tastiera-container').style.display = 'none';
            document.getElementById('messaggio-avvio').style.display = 'flex';
            
            aggiornaViteUI();
            aggiornaDisplayPunteggio();
            aggiornaDisplayTempo();
            
            aggiornaDomandeDisponibili();
            
            document.getElementById("bottone-verifica").disabled = false;
            document.getElementById("bottone-aiuto").disabled = false;
            document.getElementById("bottone-prossima").style.display = 'none';
            
            aggiornaUI();
        }

        function iniziaGioco() {
            if (!giocoIniziato) {
                giocoIniziato = true;
                
                playStartSound();
                
                document.getElementById('messaggio-avvio').style.display = 'none';
                document.getElementById('area-domanda').style.display = 'flex';
                document.getElementById('controlli-gioco').style.display = 'flex';
                
                resetTimer();
                nuovaDomanda();
            }
        }

        function resetGioco() {
            punteggio = 0;
            vite = 3;
            gameOver = false;
            haSbagliatoQuestaDomanda = false;
            operazioniCorretteConsecutive = 0;
            aiutiUtilizzatiDomandaCorrente = 0;
            verificaEseguita = false;
            tempoRimanente = TEMPO_TOTALE;
            opzioniSelezionate = [];
            rispostaAperta = "";
            erroriConsecutivi = 0;
            indiceDomandaCorrente = 0;
            domandeConsecutiveStessaSezione = 0;
            haMostratoSuggerimentoCambioSezione = false;
            
            domande.base = mescolaArray([...tutteLeDomande.base]);
            domande.confronti = mescolaArray([...tutteLeDomande.confronti]);
            domande.operazioni = mescolaArray([...tutteLeDomande.operazioni]);
            domande.problemi = mescolaArray([...tutteLeDomande.problemi]);
            
            aggiornaDomandeDisponibili();
            
            giocoIniziato = true;
            
            document.getElementById('messaggio-avvio').style.display = 'none';
            document.getElementById('area-domanda').style.display = 'flex';
            document.getElementById('controlli-gioco').style.display = 'flex';
            
            aggiornaViteUI();
            aggiornaDisplayPunteggio();
            aggiornaDisplayTempo();
            
            document.getElementById("bottone-verifica").disabled = false;
            document.getElementById("bottone-aiuto").disabled = false;
            document.getElementById("bottone-prossima").style.display = 'none';
            
            resetTimer();
            nuovaDomanda();
            aggiornaUI();
        }

        function cambiaTipoDomanda(nuovoTipo) {
            if (gameOver || !giocoIniziato) return;
            
            tipoGioco = nuovoTipo;
            verificaEseguita = false;
            haSbagliatoQuestaDomanda = false;
            aiutiUtilizzatiDomandaCorrente = 0;
            indiceDomandaCorrente = 0;
            
            domandeConsecutiveStessaSezione = 0;
            haMostratoSuggerimentoCambioSezione = false;
            
            document.getElementById('tipo-base').classList.remove('attiva');
            document.getElementById('tipo-confronti').classList.remove('attiva');
            document.getElementById('tipo-operazioni').classList.remove('attiva');
            document.getElementById('tipo-problemi').classList.remove('attiva');
            
            document.getElementById('tipo-' + nuovoTipo).classList.add('attiva');
            
            if (nuovoTipo === 'base') {
                domande.base = mescolaArray([...tutteLeDomande.base]);
                domandeDisponibili = [...domande.base];
            } else if (nuovoTipo === 'confronti') {
                domande.confronti = mescolaArray([...tutteLeDomande.confronti]);
                domandeDisponibili = [...domande.confronti];
            } else if (nuovoTipo === 'operazioni') {
                domande.operazioni = mescolaArray([...tutteLeDomande.operazioni]);
                domandeDisponibili = [...domande.operazioni];
            } else {
                domande.problemi = mescolaArray([...tutteLeDomande.problemi]);
                domandeDisponibili = [...domande.problemi];
            }
            
            nuovaDomanda();
        }

        function aggiornaDomandeDisponibili() {
            if (tipoGioco === 'base') {
                domandeDisponibili = [...domande.base];
            } else if (tipoGioco === 'confronti') {
                domandeDisponibili = [...domande.confronti];
            } else if (tipoGioco === 'operazioni') {
                domandeDisponibili = [...domande.operazioni];
            } else {
                domandeDisponibili = [...domande.problemi];
            }
        }

        function nuovaDomanda() {
            if (gameOver) {
                resetGioco();
                return;
            }
            
            if (!giocoIniziato) {
                return;
            }
            
            domandeConsecutiveStessaSezione++;
            
            if (indiceDomandaCorrente >= domandeDisponibili.length) {
                if (tipoGioco === 'base') {
                    domande.base = mescolaArray([...tutteLeDomande.base]);
                    domandeDisponibili = [...domande.base];
                } else if (tipoGioco === 'confronti') {
                    domande.confronti = mescolaArray([...tutteLeDomande.confronti]);
                    domandeDisponibili = [...domande.confronti];
                } else if (tipoGioco === 'operazioni') {
                    domande.operazioni = mescolaArray([...tutteLeDomande.operazioni]);
                    domandeDisponibili = [...domande.operazioni];
                } else {
                    domande.problemi = mescolaArray([...tutteLeDomande.problemi]);
                    domandeDisponibili = [...domande.problemi];
                }
                indiceDomandaCorrente = 0;
            }
            
            verificaEseguita = false;
            haSbagliatoQuestaDomanda = false;
            aiutiUtilizzatiDomandaCorrente = 0;
            opzioniSelezionate = [];
            rispostaAperta = "";
            nascondiMessaggio();
            
            document.getElementById("bottone-prossima").style.display = 'none';
            document.getElementById("bottone-verifica").style.display = 'inline-block';
            
            domandaCorrente = domandeDisponibili[indiceDomandaCorrente];
            indiceDomandaCorrente++;
            
            mostraDomanda(domandaCorrente);
            
            aggiornaTastiera(domandaCorrente.tipo);
            
            document.getElementById("bottone-verifica").disabled = false;
            
            if (domandeConsecutiveStessaSezione >= LIMITE_DOMANDE_PRIMA_SUGGERIMENTO && !haMostratoSuggerimentoCambioSezione) {
                setTimeout(() => {
                    mostraSuggerimentoCambioSezione();
                }, 1000);
            }
            
            aggiornaUI();
        }

        function mostraSuggerimentoCambioSezione() {
            const nomiSezioni = {
                'base': 'Concetti Base',
                'confronti': 'Confronti',
                'operazioni': 'Operazioni',
                'problemi': 'Problemi'
            };
            
            const sezioneAttuale = nomiSezioni[tipoGioco];
            
            const messaggio = `Hai giocato ${domandeConsecutiveStessaSezione} volte con "${sezioneAttuale}". Prova a cambiare sezione per variare le domande!`;
            
            const bottoneCambia = document.createElement('button');
            bottoneCambia.className = 'bottone bottone-cambia-sezione';
            bottoneCambia.textContent = 'üîÄ Cambia Sezione';
            bottoneCambia.style.marginTop = '10px';
            
            bottoneCambia.onclick = function() {
                playClickSound();
                const sezioni = ['base', 'confronti', 'operazioni', 'problemi'];
                const sezioniDisponibili = sezioni.filter(s => s !== tipoGioco);
                const nuovaSezione = sezioniDisponibili[Math.floor(Math.random() * sezioniDisponibili.length)];
                
                cambiaTipoDomanda(nuovaSezione);
                nascondiMessaggio();
            };
            
            const bottoneChiudi = document.createElement('button');
            bottoneChiudi.className = 'bottone';
            bottoneChiudi.textContent = 'Chiudi';
            bottoneChiudi.style.marginTop = '5px';
            bottoneChiudi.style.marginLeft = '10px';
            bottoneChiudi.style.backgroundColor = '#6c757d';
            
            bottoneChiudi.onclick = function() {
                playClickSound();
                nascondiMessaggio();
                haMostratoSuggerimentoCambioSezione = true;
                domandeConsecutiveStessaSezione = Math.floor(LIMITE_DOMANDE_PRIMA_SUGGERIMENTO / 2);
            };
            
            mostraMessaggioConPulsante(messaggio, bottoneCambia, bottoneChiudi, "suggerimento");
            
            haMostratoSuggerimentoCambioSezione = true;
        }
        
        function mostraMessaggioConPulsante(testo, pulsante1, pulsante2, tipo) {
            const messaggioDiv = document.getElementById("messaggio-verifica");
            
            if (timeoutBenvenuto) {
                clearTimeout(timeoutBenvenuto);
                timeoutBenvenuto = null;
            }
            
            const contenitore = document.createElement('div');
            contenitore.style.display = 'flex';
            contenitore.style.flexDirection = 'column';
            contenitore.style.alignItems = 'center';
            contenitore.style.gap = '10px';
            
            const testoDiv = document.createElement('div');
            testoDiv.textContent = testo;
            testoDiv.style.textAlign = 'center';
            contenitore.appendChild(testoDiv);
            
            const containerPulsanti = document.createElement('div');
            containerPulsanti.style.display = 'flex';
            containerPulsanti.style.gap = '10px';
            containerPulsanti.style.flexWrap = 'wrap';
            containerPulsanti.style.justifyContent = 'center';
            
            containerPulsanti.appendChild(pulsante1);
            if (pulsante2) {
                containerPulsanti.appendChild(pulsante2);
            }
            
            contenitore.appendChild(containerPulsanti);
            
            messaggioDiv.innerHTML = '';
            messaggioDiv.appendChild(contenitore);
            
            messaggioDiv.className = "messaggio-verifica mostra";
            
            if (tipo === "suggerimento") {
                messaggioDiv.classList.add("messaggio-suggerimento");
                messaggioDiv.classList.remove("messaggio-corretto", "messaggio-errato", "messaggio-info", "messaggio-game-over", "messaggio-parziale", "messaggio-wow", "messaggio-ahi");
            }
            
            timeoutBenvenuto = setTimeout(() => {
                nascondiMessaggio();
                haMostratoSuggerimentoCambioSezione = true;
                domandeConsecutiveStessaSezione = Math.floor(LIMITE_DOMANDE_PRIMA_SUGGERIMENTO / 2);
            }, 15000);
        }

        function mostraDomanda(domanda) {
            const areaDomanda = document.getElementById("area-domanda");
            areaDomanda.innerHTML = "";
            
            const testoDomanda = document.createElement("div");
            testoDomanda.className = "testo-domanda";
            testoDomanda.textContent = domanda.domanda;
            areaDomanda.appendChild(testoDomanda);
            
            if (domanda.tipo === "scelta_multipla_multi") {
                const infoMulti = document.createElement("div");
                infoMulti.className = "multi-selezione-info";
                infoMulti.textContent = "‚ö†Ô∏è Questa domanda ha pi√π risposte corrette! Seleziona tutte quelle che ritieni giuste.";
                areaDomanda.appendChild(infoMulti);
            }
            
            if (domanda.tipo === "risposta_aperta") {
                const avvisoRidotta = document.createElement("div");
                avvisoRidotta.className = "multi-selezione-info";
                avvisoRidotta.textContent = "‚ö†Ô∏è Ricorda: scrivi la frazione in forma ridotta ai minimi termini (es. 1/2 invece di 2/4)";
                areaDomanda.appendChild(avvisoRidotta);
            }
            
            if (domanda.tipo === "scelta_multipla" || domanda.tipo === "scelta_multipla_multi") {
                creaDomandaSceltaMultipla(domanda);
            } else if (domanda.tipo === "vero_falso") {
                creaDomandaVeroFalso(domanda);
            } else if (domanda.tipo === "risposta_aperta") {
                creaDomandaRispostaAperta(domanda);
            }
        }

        function creaDomandaSceltaMultipla(domanda) {
            const opzioniContainer = document.createElement("div");
            opzioniContainer.className = "opzioni-container";
            
            let opzioniUniche = rimuoviOpzioniEquivalenti(domanda.opzioni);
            
            if (opzioniUniche.length < domanda.opzioni.length) {
                opzioniUniche = [...domanda.opzioni];
            }
            
            let indici = [];
            for (let i = 0; i < opzioniUniche.length; i++) {
                indici.push(i);
            }
            
            for (let i = indici.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indici[i], indici[j]] = [indici[j], indici[i]];
            }
            
            let opzioniMescolate = indici.map(indice => opzioniUniche[indice]);
            
            if (domanda.tipo === "scelta_multipla") {
                let nuovaRisposta = indici.indexOf(domanda.risposta);
                domandaCorrente.risposta = nuovaRisposta;
            } else {
                let nuoveRisposte = [];
                for (let i = 0; i < domanda.risposte.length; i++) {
                    nuoveRisposte.push(indici.indexOf(domanda.risposte[i]));
                }
                nuoveRisposte.sort((a, b) => a - b);
                domandaCorrente.risposte = nuoveRisposte;
            }
            
            domandaCorrente.opzioni = opzioniMescolate;
            
            opzioniMescolate.forEach((opzione, index) => {
                const opzioneBtn = document.createElement("button");
                opzioneBtn.className = "opzione-btn";
                opzioneBtn.textContent = `${String.fromCharCode(65 + index)}) ${opzione}`;
                opzioneBtn.dataset.indiceOpzione = index;
                
                opzioneBtn.onclick = () => {
                    playClickSound();
                    
                    if (domanda.tipo === "scelta_multipla") {
                        document.querySelectorAll('.opzione-btn.selezionata').forEach(btn => {
                            btn.classList.remove('selezionata');
                        });
                        
                        opzioneBtn.classList.add('selezionata');
                        opzioniSelezionate = [parseInt(opzioneBtn.dataset.indiceOpzione)];
                    } else {
                        const indice = parseInt(opzioneBtn.dataset.indiceOpzione);
                        const posizione = opzioniSelezionate.indexOf(indice);
                        
                        if (posizione === -1) {
                            opzioneBtn.classList.add('selezionata');
                            opzioniSelezionate.push(indice);
                            opzioniSelezionate.sort((a, b) => a - b);
                        } else {
                            opzioneBtn.classList.remove('selezionata');
                            opzioniSelezionate.splice(posizione, 1);
                        }
                    }
                };
                
                opzioniContainer.appendChild(opzioneBtn);
            });
            
            document.getElementById("area-domanda").appendChild(opzioniContainer);
        }

        function creaDomandaVeroFalso(domanda) {
            const opzioniContainer = document.createElement("div");
            opzioniContainer.className = "opzioni-container";
            opzioniContainer.style.gridTemplateColumns = "1fr 1fr";
            
            let invertiOrdine = Math.random() > 0.5;
            
            if (invertiOrdine) {
                const falsoBtn = document.createElement("button");
                falsoBtn.className = "opzione-btn";
                falsoBtn.textContent = "FALSO";
                falsoBtn.dataset.valore = "false";
                
                falsoBtn.onclick = () => {
                    playClickSound();
                    document.querySelectorAll('.opzione-btn.selezionata').forEach(btn => {
                        btn.classList.remove('selezionata');
                    });
                    falsoBtn.classList.add('selezionata');
                    opzioniSelezionate = [false];
                };
                
                const veroBtn = document.createElement("button");
                veroBtn.className = "opzione-btn";
                veroBtn.textContent = "VERO";
                veroBtn.dataset.valore = "true";
                
                veroBtn.onclick = () => {
                    playClickSound();
                    document.querySelectorAll('.opzione-btn.selezionata').forEach(btn => {
                        btn.classList.remove('selezionata');
                    });
                    veroBtn.classList.add('selezionata');
                    opzioniSelezionate = [true];
                };
                
                opzioniContainer.appendChild(falsoBtn);
                opzioniContainer.appendChild(veroBtn);
            } else {
                const veroBtn = document.createElement("button");
                veroBtn.className = "opzione-btn";
                veroBtn.textContent = "VERO";
                veroBtn.dataset.valore = "true";
                
                veroBtn.onclick = () => {
                    playClickSound();
                    document.querySelectorAll('.opzione-btn.selezionata').forEach(btn => {
                        btn.classList.remove('selezionata');
                    });
                    veroBtn.classList.add('selezionata');
                    opzioniSelezionate = [true];
                };
                
                const falsoBtn = document.createElement("button");
                falsoBtn.className = "opzione-btn";
                falsoBtn.textContent = "FALSO";
                falsoBtn.dataset.valore = "false";
                
                falsoBtn.onclick = () => {
                    playClickSound();
                    document.querySelectorAll('.opzione-btn.selezionata').forEach(btn => {
                        btn.classList.remove('selezionata');
                    });
                    falsoBtn.classList.add('selezionata');
                    opzioniSelezionate = [false];
                };
                
                opzioniContainer.appendChild(veroBtn);
                opzioniContainer.appendChild(falsoBtn);
            }
            
            document.getElementById("area-domanda").appendChild(opzioniContainer);
        }

        function creaDomandaRispostaAperta(domanda) {
            const rispostaContainer = document.createElement("div");
            rispostaContainer.className = "risposta-aperta-container";
            
            const inputContainer = document.createElement("div");
            inputContainer.className = "risposta-input-container";
            
            const casella = document.createElement("input");
            casella.className = "casella-risposta";
            casella.type = "text";
            casella.placeholder = "Scrivi qui la risposta";
            casella.inputmode = "numeric";
            
            casella.addEventListener('input', (e) => {
                rispostaAperta = e.target.value.replace(/[^0-9.\-\/]/g, '');
                e.target.value = rispostaAperta;
            });
            
            casella.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    verificaRisposta();
                }
            });
            
            inputContainer.appendChild(casella);
            rispostaContainer.appendChild(inputContainer);
            
            creaTastieraNumerica(casella);
            
            document.getElementById("area-domanda").appendChild(rispostaContainer);
        }

        function creaTastieraNumerica(casellaInput) {
            const tastieraContainer = document.getElementById("tastiera-container");
            const tastieraNumerica = document.getElementById("tastiera-numerica");
            
            tastieraContainer.style.display = "block";
            tastieraNumerica.innerHTML = "";
            
            let numeri = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            numeri = mescolaArray(numeri);
            
            numeri.forEach(numero => {
                const tasto = document.createElement("button");
                tasto.className = "tasto-numero";
                tasto.textContent = numero;
                tasto.onclick = () => {
                    playClickSound();
                    casellaInput.value += numero;
                    rispostaAperta = casellaInput.value;
                    casellaInput.focus();
                };
                tastieraNumerica.appendChild(tasto);
            });
            
            const tasto0 = document.createElement("button");
            tasto0.className = "tasto-numero";
            tasto0.textContent = "0";
            tasto0.onclick = () => {
                playClickSound();
                casellaInput.value += "0";
                rispostaAperta = casellaInput.value;
                casellaInput.focus();
            };
            tastieraNumerica.appendChild(tasto0);
            
            const tastoFrazione = document.createElement("button");
            tastoFrazione.className = "tasto-numero";
            tastoFrazione.textContent = "/";
            tastoFrazione.onclick = () => {
                playClickSound();
                casellaInput.value += "/";
                rispostaAperta = casellaInput.value;
                casellaInput.focus();
            };
            tastieraNumerica.appendChild(tastoFrazione);
            
            const tastoCancella = document.createElement("button");
            tastoCancella.className = "tasto-numero tasto-cancella";
            tastoCancella.textContent = "‚å´";
            tastoCancella.onclick = () => {
                playClickSound();
                casellaInput.value = casellaInput.value.slice(0, -1);
                rispostaAperta = casellaInput.value;
                casellaInput.focus();
            };
            tastieraNumerica.appendChild(tastoCancella);
        }

        function aggiornaTastiera(tipoDomanda) {
            const tastieraContainer = document.getElementById("tastiera-container");
            
            if (tipoDomanda === "risposta_aperta") {
                // La tastiera numerica viene creata quando serve
            } else if (tipoDomanda === "vero_falso") {
                tastieraContainer.style.display = "none";
            } else {
                tastieraContainer.style.display = "none";
            }
        }

        function mostraMessaggio(testo, tipo, speciale = false) {
            const messaggioDiv = document.getElementById("messaggio-verifica");
            
            if (timeoutBenvenuto) {
                clearTimeout(timeoutBenvenuto);
                timeoutBenvenuto = null;
            }
            
            messaggioDiv.textContent = testo;
            messaggioDiv.className = "messaggio-verifica mostra";
            
            messaggioDiv.classList.remove("messaggio-wow", "messaggio-ahi", "messaggio-suggerimento");
            
            if (speciale) {
                if (tipo === "wow") {
                    messaggioDiv.classList.add("messaggio-wow");
                } else if (tipo === "ahi") {
                    messaggioDiv.classList.add("messaggio-ahi");
                }
            } else if (tipo === "corretto") {
                messaggioDiv.classList.add("messaggio-corretto");
                messaggioDiv.classList.remove("messaggio-errato", "messaggio-info", "messaggio-game-over", "messaggio-parziale");
            } else if (tipo === "errato") {
                messaggioDiv.classList.add("messaggio-errato");
                messaggioDiv.classList.remove("messaggio-corretto", "messaggio-info", "messaggio-game-over", "messaggio-parziale");
            } else if (tipo === "parziale") {
                messaggioDiv.classList.add("messaggio-parziale");
                messaggioDiv.classList.remove("messaggio-corretto", "messaggio-errato", "messaggio-info", "messaggio-game-over");
            } else if (tipo === "game-over") {
                messaggioDiv.classList.add("messaggio-game-over");
                messaggioDiv.classList.remove("messaggio-corretto", "messaggio-errato", "messaggio-info", "messaggio-parziale");
            } else if (tipo === "suggerimento") {
                messaggioDiv.classList.add("messaggio-suggerimento");
                messaggioDiv.classList.remove("messaggio-corretto", "messaggio-errato", "messaggio-info", "messaggio-game-over", "messaggio-parziale", "messaggio-wow", "messaggio-ahi");
            } else {
                messaggioDiv.classList.add("messaggio-info");
                messaggioDiv.classList.remove("messaggio-corretto", "messaggio-errato", "messaggio-game-over", "messaggio-parziale", "messaggio-suggerimento");
            }
        }

        function nascondiMessaggio() {
            const messaggioDiv = document.getElementById("messaggio-verifica");
            messaggioDiv.classList.remove("mostra");
            setTimeout(() => {
                messaggioDiv.textContent = "";
                messaggioDiv.className = "messaggio-verifica";
            }, 300);
        }

        function verificaRisposta() {
            if (gameOver || !giocoIniziato || !domandaCorrente) return;
            
            if (domandaCorrente.tipo === "scelta_multipla" || domandaCorrente.tipo === "scelta_multipla_multi" || domandaCorrente.tipo === "vero_falso") {
                if (opzioniSelezionate.length === 0) {
                    mostraMessaggio("Seleziona almeno una risposta prima di verificare!", "errato");
                    return;
                }
            } else if (domandaCorrente.tipo === "risposta_aperta") {
                if (rispostaAperta.trim() === "") {
                    mostraMessaggio("Inserisci una risposta prima di verificare!", "errato");
                    return;
                }
            }
            
            let corretta = false;
            let rispostaParziale = false;
            
            if (domandaCorrente.tipo === "scelta_multipla") {
                corretta = opzioniSelezionate[0] === domandaCorrente.risposta;
                
            } else if (domandaCorrente.tipo === "scelta_multipla_multi") {
                const risposteUtente = [...opzioniSelezionate].sort((a, b) => a - b);
                const risposteCorrette = [...domandaCorrente.risposte].sort((a, b) => a - b);
                
                if (risposteUtente.length === risposteCorrette.length) {
                    corretta = risposteUtente.every((val, idx) => val === risposteCorrette[idx]);
                }
                
                if (!corretta && risposteUtente.length > 0) {
                    let corretteSelezionate = 0;
                    risposteUtente.forEach(risposta => {
                        if (risposteCorrette.includes(risposta)) {
                            corretteSelezionate++;
                        }
                    });
                    
                    if (corretteSelezionate > 0 && corretteSelezionate < risposteCorrette.length) {
                        rispostaParziale = true;
                    }
                }
                
            } else if (domandaCorrente.tipo === "vero_falso") {
                corretta = opzioniSelezionate[0] === domandaCorrente.risposta;
                
            } else if (domandaCorrente.tipo === "risposta_aperta") {
                rispostaAperta = normalizzaFrazione(rispostaAperta.trim());
                const rispostaCorretta = normalizzaFrazione(domandaCorrente.risposta.toString());
                
                corretta = rispostaAperta === rispostaCorretta;
                
                if (!corretta) {
                    function evalFrazione(str) {
                        if (str.includes("/")) {
                            const [num, den] = str.split("/").map(Number);
                            if (den !== 0) return num / den;
                        }
                        return parseFloat(str);
                    }
                    
                    const utenteNum = evalFrazione(rispostaAperta);
                    const correttoNum = evalFrazione(rispostaCorretta);
                    
                    if (!isNaN(utenteNum) && !isNaN(correttoNum)) {
                        corretta = Math.abs(utenteNum - correttoNum) < 0.01;
                    }
                }
            }
            
            if (corretta) {
                playSuccessSound();
                
                let puntiDomanda = 0;
                if (domandaCorrente.tipo === "scelta_multipla_multi") {
                    puntiDomanda = 3;
                } else {
                    puntiDomanda = 2;
                }
                
                puntiDomanda -= (aiutiUtilizzatiDomandaCorrente * 2);
                if (puntiDomanda < 0) puntiDomanda = 0;
                
                punteggio += puntiDomanda;
                aggiornaDisplayPunteggio();
                
                operazioniCorretteConsecutive++;
                erroriConsecutivi = 0;
                aggiornaIndicatoreErrori();
                
                if (operazioniCorretteConsecutive >= 5) {
                    if (vite < 3) {
                        vite++;
                        aggiornaViteUI();
                        mostraMessaggio(`Fantastico! 5 risposte corrette consecutive! Hai guadagnato una vita extra!`, "wow", true);
                        playWowSound();
                    } else {
                        mostraMessaggio(`Fantastico! 5 risposte corrette consecutive! Ma hai gi√† il massimo di vite.`, "corretto");
                    }
                    operazioniCorretteConsecutive = 0;
                } else {
                    mostraMessaggio(`Corretto! +${puntiDomanda} punti`, "corretto");
                }
                
                if (domandaCorrente.spiegazione) {
                    setTimeout(() => {
                        mostraMessaggio(domandaCorrente.spiegazione, "info");
                    }, 1500);
                }
                
                setTimeout(() => {
                    document.getElementById("bottone-verifica").style.display = 'none';
                    document.getElementById("bottone-prossima").style.display = 'inline-block';
                }, 2000);
                
            } else if (rispostaParziale) {
                playAhiSound();
                mostraMessaggio(`Hai selezionato alcune risposte corrette, ma non tutte. Riprova!`, "parziale");
                haSbagliatoQuestaDomanda = true;
                
                erroriConsecutivi++;
                aggiornaIndicatoreErrori();
                
                if (erroriConsecutivi >= 3) {
                    erroriConsecutivi = 0;
                    vite--;
                    aggiornaViteUI();
                    mostraMessaggio(`Tre errori consecutivi! Perdi una vita.`, "errato");
                    
                    if (vite <= 0) {
                        gameOver = true;
                        mostraMessaggio(`GAME OVER! Punteggio finale: ${punteggio}. Clicca "Nuova Partita" per ricominciare`, "game-over");
                        document.getElementById("bottone-verifica").disabled = true;
                        document.getElementById("bottone-aiuto").disabled = true;
                        document.getElementById("bottone-prossima").style.display = 'none';
                        fermaTimer();
                    }
                }
                
                operazioniCorretteConsecutive = 0;
                
            } else {
                playAhiSound();
                mostraMessaggio(`Risposta errata. Riprova!`, "errato");
                haSbagliatoQuestaDomanda = true;
                
                erroriConsecutivi++;
                aggiornaIndicatoreErrori();
                
                if (erroriConsecutivi >= 3) {
                    erroriConsecutivi = 0;
                    vite--;
                    aggiornaViteUI();
                    mostraMessaggio(`Tre errori consecutivi! Perdi una vita.`, "errato");
                    
                    if (vite <= 0) {
                        gameOver = true;
                        mostraMessaggio(`GAME OVER! Punteggio finale: ${punteggio}. Clicca "Nuova Partita" per ricominciare`, "game-over");
                        document.getElementById("bottone-verifica").disabled = true;
                        document.getElementById("bottone-aiuto").disabled = true;
                        document.getElementById("bottone-prossima").style.display = 'none';
                        fermaTimer();
                    }
                }
                
                operazioniCorretteConsecutive = 0;
                
                if (domandaCorrente.spiegazione) {
                    setTimeout(() => {
                        mostraMessaggio(domandaCorrente.spiegazione, "info");
                    }, 1500);
                }
            }
            
            verificaEseguita = true;
            aggiornaUI();
        }
        
        // FUNZIONE AIUTO
        function aiuto() {
            if (gameOver || !giocoIniziato || !domandaCorrente) return;
            
            playClickSound();
            
            aiutiUtilizzatiDomandaCorrente++;
            aggiornaUI();
            
            let messaggioAiuto = "";
            
            if (domandaCorrente.tipo === "scelta_multipla") {
                messaggioAiuto = "Prova a ragionare sul significato della frazione. Ricorda che il denominatore indica in quante parti √® diviso l'intero e il numeratore quante parti sono considerate.";
            } else if (domandaCorrente.tipo === "scelta_multipla_multi") {
                messaggioAiuto = "Attenzione: ci possono essere pi√π risposte corrette. Controlla ogni opzione con attenzione.";
            } else if (domandaCorrente.tipo === "vero_falso") {
                messaggioAiuto = "Leggi attentamente l'affermazione e pensa se √® sempre vera o se ci sono eccezioni.";
            } else if (domandaCorrente.tipo === "risposta_aperta") {
                messaggioAiuto = "Ricorda di scrivere la frazione in forma ridotta. Ad esempio, 2/4 si riduce a 1/2.";
            }
            
            if (domandaCorrente.spiegazione) {
                messaggioAiuto += " " + domandaCorrente.spiegazione;
            }
            
            mostraMessaggio(messaggioAiuto, "info");
        }
        
        // FUNZIONE PROSSIMA DOMANDA
        function prossimaDomanda() {
            playClickSound();
            nuovaDomanda();
        }
        
        // FUNZIONI PER LE ISTRUZIONI
        function apriIstruzioni() {
            document.getElementById('modal-overlay').style.display = 'flex';
            playClickSound();
        }
        
        function chiudiIstruzioni() {
            document.getElementById('modal-overlay').style.display = 'none';
            playClickSound();
        }

        // ==================== FUNZIONE PER ESCI (DIRETTA) ====================
        function esciDalGioco() {
            if (confirm("Vuoi davvero uscire dal gioco?")) {
                fermaTimer(); // ferma il timer se attivo
                window.location.href = "https://oragioca.github.io/matematica/";
                // In alternativa, per una pagina vuota: window.location.href = "about:blank";
            }
        }
        
        // INIZIALIZZAZIONE EVENT LISTENER
        document.addEventListener('DOMContentLoaded', function() {
            inizializzaGioco();
            
            document.getElementById('bottone-aiuto').addEventListener('click', aiuto);
            document.getElementById('bottone-verifica').addEventListener('click', verificaRisposta);
            document.getElementById('bottone-prossima').addEventListener('click', prossimaDomanda);
            document.getElementById('bottone-nuova').addEventListener('click', resetGioco);
            
            document.getElementById('tipo-base').addEventListener('click', function() { cambiaTipoDomanda('base'); });
            document.getElementById('tipo-confronti').addEventListener('click', function() { cambiaTipoDomanda('confronti'); });
            document.getElementById('tipo-operazioni').addEventListener('click', function() { cambiaTipoDomanda('operazioni'); });
            document.getElementById('tipo-problemi').addEventListener('click', function() { cambiaTipoDomanda('problemi'); });
            
            document.getElementById('istruzioni-btn').addEventListener('click', apriIstruzioni);
            document.getElementById('close-modal').addEventListener('click', chiudiIstruzioni);
            document.getElementById('modal-overlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    chiudiIstruzioni();
                }
            });
            
            document.getElementById('messaggio-avvio').addEventListener('click', iniziaGioco);
            
            // NUOVO: evento per il pulsante Esci
            document.getElementById('esciBtn').addEventListener('click', esciDalGioco);
            
            inizializzaAudio();
        });
    </script>
</body>
</html>";
                // In alternativa, per una pagina vuota: window.location.href = "about:blank";
            }
        }

        document.getElementById('checkBtn').addEventListener('click', checkAnswer);
        document.getElementById('hintBtn').addEventListener('click', showHint);
        document.getElementById('resetBtn').addEventListener('click', resetExercise);
        document.getElementById('nextBtn').addEventListener('click', nextExercise);

        // NUOVO: evento per il pulsante Esci
        document.getElementById('esciBtn').addEventListener('click', esciDalGioco);

        startExercise();
    </script>
</body>
</html>